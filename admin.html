<!DOCTYPE html>
<html lang="ja" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>サイト管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script>
      // サイトの共通Tailwind設定
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              // ★ メインカラー
              primary: "#00bfff",
              secondary: "#00bfff",
              "background-light": "#F8F9FA",
              "background-dark": "#101c22",
              "text-light": "#343A40",
              "text-dark": "#F8F9FA",
              "text-muted-light": "#6c757d",
              "text-muted-dark": "#adb5bd",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2a33",
            },
            fontFamily: {
              display: ["Manrope", "Noto Sans JP", "sans-serif"],
            },
            // ★ バナーアニメーション (6種)
            keyframes: {
              wiggle: {
                "0%, 100%": { transform: "rotate(-1deg)" },
                "50%": { transform: "rotate(1deg)" },
              },
              pulse: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: ".7" },
              },
              squish: {
                "0%, 100%": { transform: "scale(1, 1)" },
                "50%": { transform: "scale(1.05, 0.95)" },
              },
              flash: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.2" },
              },
              heartbeat: {
                "0%": { transform: "scale(1)" },
                "25%": { transform: "scale(1.03)" },
                "50%": { transform: "scale(1)" },
                "75%": { transform: "scale(1.03)" },
                "100%": { transform: "scale(1)" },
              },
            },
            animation: {
              wiggle: "wiggle 1s ease-in-out infinite",
              pulse: "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              squish: "squish 0.8s ease-in-out infinite",
              flash: "flash 1.5s linear infinite",
              heartbeat: "heartbeat 1.2s ease-in-out infinite",
            },
          },
        },
      };
    </script>
    <style>
      /* TailwindのCDNは <style> タグ内の @apply に対応していないため、
        ここで通常のCSSルールを定義し直します。
        (元々 "固定ページ管理" タブにあったものを <head> に移動)
      */
      .toggle-checkbox {
        /* トグルがOFFの時の左端の位置 */
        left: 0;
        transition: all 0.2s ease-in-out;
      }
      .toggle-checkbox:checked {
        /* トグルがONの時の右端の位置 
          コンテナ(w-10=2.5rem) - 本体(w-6=1.5rem) = 1rem の移動
        */
        transform: translateX(1rem);
        /* @apply border-primary (Tailwind.configで "primary": "#00bfff")
        */
        border-color: #00bfff;
      }
      .toggle-checkbox:checked + .toggle-label {
        /* @apply bg-primary
        */
        background-color: #00bfff;
      }
    </style>
    <style>
      /* 読み込み中スピナー */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #00bfff; /* メインカラー */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* タブのスタイル */
      .tab-btn.active {
        border-bottom-color: var(
          --color-primary,
          #00bfff
        ); /* tailwind.configのprimaryを参照 */
        color: var(--color-primary, #00bfff);
        border-bottom-width: 2px;
      }
      .tab-btn {
        border-bottom-width: 2px;
        border-color: transparent;
        padding-bottom: 0.5rem;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
        color: var(--color-text-muted-light, #6c757d);
        transition-property: color, background-color, border-color,
          text-decoration-color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }
      .dark .tab-btn {
        color: var(--color-text-muted-dark, #adb5bd);
      }
      .tab-btn:hover {
        border-color: #94a3b8;
        color: var(--color-text-light, #343a40);
      }
      .dark .tab-btn:hover {
        border-color: #64748b;
        color: var(--color-text-dark, #f8f9fa);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .sub-tab-content {
        display: none;
      }
      .sub-tab-content.active {
        display: block;
      }

      /* ★ 編集モーダル用のスタイル ★ */
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: all 0.3s ease;
      }
      /* スクロールバーのスタイル (ダークモード対応) */
      .modal-body::-webkit-scrollbar {
        width: 8px;
      }
      .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .modal-body::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 10px;
      }
      .modal-body::-webkit-scrollbar-thumb:hover {
        background: #aaa;
      }
      .dark .modal-body::-webkit-scrollbar-track {
        background: #333;
      }
      .dark .modal-body::-webkit-scrollbar-thumb {
        background: #666;
      }
      .dark .modal-body::-webkit-scrollbar-thumb:hover {
        background: #888;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-display min-h-screen"
  >
    <!-- グローバルメッセージ表示エリア -->
    <div id="message-container" class="fixed top-5 right-5 z-[100]"></div>

    <!-- 1. ログイン画面 -->
    <section
      id="login-section"
      class="flex flex-col items-center justify-center min-h-screen p-4"
    >
      <div
        class="w-full max-w-md p-8 bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
      >
        <h1 class="text-3xl font-bold text-center mb-6">管理ページログイン</h1>
        <button
          id="google-login-btn"
          class="w-full flex items-center justify-center gap-3 py-3 px-4 bg-white border border-slate-300 rounded-lg text-slate-700 font-medium hover:bg-slate-50 transition duration-150"
        >
          <svg class="w-6 h-6" viewBox="0 0 48 48">
            <path
              fill="#EA4335"
              d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"
            ></path>
            <path
              fill="#4285F4"
              d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"
            ></path>
            <path
              fill="#FBBC05"
              d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"
            ></path>
            <path
              fill="#34A853"
              d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"
            ></path>
            <path fill="none" d="M0 0h48v48H0z"></path>
          </svg>
          Google アカウントでログイン
        </button>
        <div class="my-6 flex items-center justify-center">
          <span class="border-b border-slate-300 w-full"></span>
          <span class="mx-4 text-sm text-text-muted-light">または</span>
          <span class="border-b border-slate-300 w-full"></span>
        </div>
        <form id="email-login-form" class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium"></label>
              メールアドレス
            </label>
            <input
              type="email"
              id="email"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium">
              パスワード
            </label>
            <input
              type="password"
              id="password"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <button
            type="submit"
            class="w-full py-3 px-4 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity"
          >
            メールアドレスでログイン
          </button>
        </form>
      </div>
    </section>

    <!-- 2. SMS 2段階認証画面 (MFA) -->
    <section
      id="mfa-section"
      class="hidden flex-col items-center justify-center min-h-screen p-4"
    >
      <div
        class="w-full max-w-md p-8 bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
      >
        <h1 class="text-3xl font-bold text-center mb-6">2段階認証</h1>
        <p id="mfa-info-text" class="text-center mb-4 text-text-muted-light">
          セキュリティ保護のため、電話番号に確認コードを送信します。
        </p>
        <form id="phone-form" class="space-y-4">
          <div>
            <label for="phone-number" class="block text-sm font-medium">
              電話番号 (例: +818012345678)
            </label>
            <input
              type="tel"
              id="phone-number"
              required
              placeholder="+818012345678"
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <button
            type="submit"
            class="w-full py-3 px-4 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity"
          >
            SMSコードを送信
          </button>
        </form>
        <form id="code-form" class="hidden space-y-4 mt-6">
          <div>
            <label for="code" class="block text-sm font-medium">
              確認コード
            </label>
            <input
              type="text"
              id="code"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <button
            type="submit"
            class="w-full py-3 px-4 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity"
          >
            確認してログイン
          </button>
        </form>
        <div id="recaptcha-container" class="mt-4"></div>
      </div>
    </section>

    <!-- 3. 管理ダッシュボード -->
    <section
      id="dashboard-section"
      class="hidden max-w-5xl mx-auto p-4 sm:p-6 lg:p-8"
    >
      <header
        class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b border-slate-200 dark:border-slate-700"
      >
        <div>
          <h1 class="text-3xl font-bold">サイト管理ダッシュボード</h1>
          <p
            id="user-email"
            class="text-text-muted-light dark:text-text-muted-dark"
          ></p>
        </div>
        <button
          id="logout-btn"
          class="mt-4 sm:mt-0 w-full sm:w-auto py-2 px-6 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors"
        >
          ログアウト
        </button>
      </header>

      <!-- ★★★ 6つのタブナビゲーション (修正) ★★★ -->
      <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
        <nav id="tabs-container" class="flex gap-6 -mb-px flex-wrap">
          <button class="tab-btn active text-sm font-bold" data-tab="articles">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              article
            </span>
            お知らせ管理
          </button>
          <button class="tab-btn text-sm font-bold" data-tab="books">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              auto_stories
            </span>
            書籍管理
          </button>
          <button class="tab-btn text-sm font-bold" data-tab="media-icons">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              collections
            </span>
            メディア(アイコン)管理
          </button>
          <button class="tab-btn text-sm font-bold" data-tab="media-banners">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              image
            </span>
            メディア(バナー)管理
          </button>
          <button class="tab-btn text-sm font-bold" data-tab="sites">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              web
            </span>
            ブログ・HP管理
          </button>
          <!-- ★ 修正 (Step 1/2) : 6番目の固定ページ管理タブ -->
          <!-- ★ NEW: ページ共通管理 (Common Management) -->
      <button
        class="tab-btn text-sm font-bold px-4 py-2 rounded-lg border border-transparent hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center gap-2"
        data-tab="common-management"
      >
        <span class="material-symbols-outlined">settings</span>
        <span>ページ共通管理</span>
      </button>

      <!-- 6. 固定ページ管理 (Static Pages) -->
      <button class="tab-btn text-sm font-bold" data-tab="static-pages">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              wysiwyg
            </span>
            固定ページ管理
          </button>
          <!-- ★ P2: ブログ記事管理タブ ★ -->
          <button class="tab-btn text-sm font-bold" data-tab="blog-posts">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              post_add
            </span>
            ブログ記事管理
          </button>


          <button class="tab-btn text-sm font-bold" data-tab="custom-html">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">
              code_blocks
            </span>
            カスタムHTML
          </button>

          <button class="tab-btn text-sm font-bold" data-tab="saved-links">
            <span class="material-symbols-outlined align-middle !text-lg mr-1">bookmarks</span>
            登録リンク
          </button>
        </nav>
      </div>

      <!-- ★★★ タブコンテンツ ★★★ -->

      <!-- 1. お知らせ管理 -->
      <div id="tab-content-articles" class="tab-content active">
        <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
          <h2 class="text-2xl font-bold mb-6">お知らせ管理</h2>

          <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
            <nav class="flex gap-4" id="sub-tabs-container-articles">
              <button class="sub-tab-btn active px-4 py-2 text-sm font-bold border-b-2 border-primary text-primary" data-subtab="article-list">記事一覧・追加</button>
              <button class="sub-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-subtab="article-categories">カテゴリー管理</button>
            </nav>
          </div>

          <div id="sub-tab-content-article-list" class="sub-tab-content-articles active">
            <h3 class="text-xl font-bold mb-6">お知らせを追加 (info.html)</h3>
            <form id="add-article-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                  <label for="article-title" class="block text-sm font-medium">タイトル <span class="text-red-500">*</span></label>
                  <input type="text" id="article-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
                <div>
                  <label for="article-date" class="block text-sm font-medium">日付 <span class="text-red-500">*</span></label>
                  <input type="date" id="article-date" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="article-category" class="block text-sm font-medium">カテゴリー <span class="text-red-500">*</span></label>
                  <select id="article-category" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                    <option value="" disabled selected>カテゴリーを読み込み中...</option>
                  </select>
                </div>
                <div>
                  <label for="article-image" class="block text-sm font-medium">サムネイル画像</label>
                  <input type="file" id="article-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
                  <div id="upload-progress-container-article" class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                    <div id="upload-progress-bar-article" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                  </div>
                  <img id="image-preview-article" src="" alt="画像プレビュー" class="hidden mt-4 w-48 h-auto rounded-lg" />
                </div>
              </div>
              <div>
                <label for="article-content" class="block text-sm font-medium">本文 (任意)</label>
                <textarea id="article-content" rows="4" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" placeholder="本文を入力..."></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium">表示ステータス</label>
                <div class="mt-2 flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600">
                  <label for="article-visible" class="block text-sm font-medium">この記事を公開する</label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="article-visible" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label for="article-visible" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
                  </div>
                </div>
              </div>
              <div>
                <button type="submit" id="submit-article-btn" class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">add</span> <span>記事を追加する</span>
                </button>
              </div>
            </form>

            <div class="mt-12">
              <h2 class="text-2xl font-bold mb-6">お知らせ一覧 <span id="articles-count-display" class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"></span></h2>
              <div class="mb-4 relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><span class="material-symbols-outlined">search</span></span>
                <input type="text" id="search-articles" placeholder="キーワードで絞り込み..." class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>
              <div id="articles-list-container" class="space-y-4">
                <div id="articles-loader" class="flex justify-center py-8"><div class="loader"></div></div>
              </div>
            </div>
          </div>

          <div id="sub-tab-content-article-categories" class="sub-tab-content-articles hidden">
            <h3 class="text-xl font-bold mb-6">お知らせカテゴリー管理</h3>
            <form id="add-article-category-form" class="flex gap-4 mb-6">
              <div class="flex-grow">
                <label for="article-category-name" class="block text-sm font-medium">新規カテゴリー名</label>
                <input type="text" id="article-category-name" required placeholder="例: ニュース" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>
              <div class="flex-shrink-0 self-end">
                <button type="submit" id="submit-article-category-btn" class="py-3 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">add</span> <span>追加</span>
                </button>
              </div>
            </form>
            <h4 class="text-lg font-bold mb-4">登録済みカテゴリー一覧</h4>
            <div id="article-categories-list-container" class="space-y-2">
              <div id="article-categories-loader" class="flex justify-center py-4"><div class="loader"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. 書籍管理 -->
      <div id="tab-content-books" class="tab-content">
        <div
          class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-2xl font-bold mb-6">書籍を追加 (media.html)</h2>
          <form id="add-book-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="book-title" class="block text-sm font-medium">
                  書籍タイトル
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="book-title"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="book-url" class="block text-sm font-medium">
                  詳細リンクURL (http://...)
                </label>
                <input
                  type="url"
                  id="book-url"
                  placeholder="https://..."
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="book-button-text" class="block text-sm font-medium">ボタンの文字</label>
                <input type="text" id="book-button-text" placeholder="詳細を見る" value="詳細を見る" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
              </div>
              <div class="flex items-end pb-3">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="book-open-new-tab" class="rounded border-slate-300 text-primary focus:ring-primary h-5 w-5">
                  <label for="book-open-new-tab" class="block text-sm font-medium">リンクを新しいタブで開く</label>
                </div>
              </div>
            </div>
            <div>
              <label for="book-image" class="block text-sm font-medium">
                書籍画像
                <span class="text-red-500">*</span>
              </label>
              <input
                type="file"
                id="book-image"
                accept="image/*"
                required
                class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
              />
              <div class="mt-2 p-3 bg-slate-50 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700 text-xs text-text-muted-light dark:text-text-muted-dark">
                <p class="font-bold mb-1">推奨画像スペック:</p>
                <ul class="list-disc list-inside space-y-0.5 ml-1">
                  <li>縦横比: 3 : 4 (縦長)</li>
                  <li>サイズ: 横 600px × 縦 800px</li>
                  <li>形式: .jpg (推奨)</li>
                  <li>容量: 200KB以下 (推奨100KB)</li>
                </ul>
              </div>
              <div
                id="upload-progress-container-book"
                class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700"
              >
                <div
                  id="upload-progress-bar-book"
                  class="bg-primary h-2.5 rounded-full"
                  style="width: 0%"
                ></div>
              </div>
              <img
                id="image-preview-book"
                src=""
                alt="画像プレビュー"
                class="hidden mt-4 w-48 h-auto rounded-lg"
              />
            </div>
            <div>
              <label for="book-description" class="block text-sm font-medium">
                紹介文
                <span class="text-red-500">*</span>
              </label>
              <textarea
                id="book-description"
                rows="3"
                required
                class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                placeholder="書籍の簡単な紹介文を入力..."
              ></textarea>
            </div>

            <div class="mt-2 space-y-3 p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
              <div class="flex items-center justify-between">
                <label for="book-fixed" class="block text-sm font-medium">トップページに固定</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                  <input type="checkbox" id="book-fixed" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                  <label for="book-fixed" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
                </div>
              </div>
              <div class="flex items-center justify-between border-t border-slate-200 dark:border-slate-700 pt-3">
                <label for="book-fixed-on-media" class="block text-sm font-medium">メディアページに固定</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                  <input type="checkbox" id="book-fixed-on-media" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                  <label for="book-fixed-on-media" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
                </div>
              </div>
              <div class="flex items-center justify-between border-t border-slate-200 dark:border-slate-700 pt-3">
                <label for="book-show-in-snippet" class="block text-sm font-medium">書籍全体のスニペットに表示</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                  <input type="checkbox" id="book-show-in-snippet" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                  <label for="book-show-in-snippet" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="book-star-rating" class="block text-sm font-medium">
                  人気度 (星評価: 1〜5)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="book-star-rating"
                  min="1"
                  max="5"
                  value="5"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="book-order" class="block text-sm font-medium">
                  固定表示順 (数値: 1, 2, ... 0=日付順)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="book-order"
                  value="10"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>

            <div>
              <button
                type="submit"
                id="submit-book-btn"
                class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">add</span>
                <span>書籍を追加する</span>
              </button>
            </div>
          </form>
          <button
            id="open-snippet-modal-btn"
            class="mt-6 w-full py-3 px-8 bg-secondary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined">code</span>
            <span>埋め込み用スニペット取得</span>
          </button>
          <h2 class="text-2xl font-bold mb-6">
            書籍一覧
            <span
              id="books-count-display"
              class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
            ></span>
          </h2>
          <div id="books-list-container" class="space-y-4">
            <div id="books-loader" class="flex justify-center py-8">
              <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. メディア(アイコン)管理 -->
      <div id="tab-content-media-icons" class="tab-content">
        <div
          class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-2xl font-bold mb-6">
            メディア(アイコン)を追加 (media.html)
          </h2>
          <form id="add-media-icon-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="media-icon-title" class="block text-sm font-medium">
                  リンクタイトル
                  <span class="text-red-500">*</span>
                  (例: note)
                </label>
                <input
                  type="text"
                  id="media-icon-title"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label
                  for="media-icon-description"
                  class="block text-sm font-medium"
                >
                  解説内容
                  <span class="text-red-500">*</span>
                  (例: 思考の記録)
                </label>
                <input
                  type="text"
                  id="media-icon-description"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="media-icon-url" class="block text-sm font-medium">
                  リンク先URL (http://...)
                </label>
                <input
                  type="url"
                  id="media-icon-url"
                  placeholder="https://..."
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="media-icon-order" class="block text-sm font-medium">
                  表示順 (数値)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="media-icon-order"
                  value="10"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="media-icon-name" class="block text-sm font-medium">
                  方法1: リストからアイコン選択
                </label>
                <select
                  id="media-icon-name"
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                >
                  <option value="article">note (記事)</option>
                  <option value="play_circle">YouTube (動画)</option>
                  <option value="graphic_eq">standFM (音声)</option>
                  <option value="photo_camera">Instagram (写真)</option>
                  <option value="music_note">TikTok (音楽/動画)</option>
                  <option value="forum">Threads (会話)</option>
                  <option value="public">Facebook (ソーシャル)</option>
                  <option value="podcasts">Podcast (ポッドキャスト)</option>
                  <option value="link">その他 (汎用リンク)</option>
                </select>
              </div>
              <div>
                <label for="media-icon-image" class="block text-sm font-medium">
                  方法2: カスタム画像アップロード
                </label>
                <input
                  type="file"
                  id="media-icon-image"
                  accept="image/*"
                  class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
                />
                <p class="text-xs text-text-muted-light mt-1">
                  推奨: 64x64px。こちらを選択すると方法1は無視されます。
                </p>
                <div
                  id="upload-progress-container-media-icon"
                  class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700"
                >
                  <div
                    id="upload-progress-bar-media-icon"
                    class="bg-primary h-2.5 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
                <img
                  id="image-preview-media-icon"
                  src=""
                  alt="画像プレビュー"
                  class="hidden mt-4 w-16 h-16 rounded-lg"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium">表示ステータス</label>
              <div
                class="mt-2 flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600"
              >
                <label
                  for="media-icon-visible"
                  class="block text-sm font-medium"
                >
                  このアイコンを公開する
                </label>
                <div
                  class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                >
                  <input
                    type="checkbox"
                    id="media-icon-visible"
                    checked
                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                  />
                  <label
                    for="media-icon-visible"
                    class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"
                  ></label>
                </div>
              </div>
              <p class="text-xs text-text-muted-light mt-1">
                ※オフにすると、一覧ページに表示されなくなります。
              </p>
            </div>

            <div>
              <button
                type="submit"
                id="submit-media-icon-btn"
                class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">add</span>
                <span>メディア(アイコン)を追加する</span>
              </button>
            </div>
          </form>
        </div>
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">メディア(アイコン)一覧</h2>
          <div id="media-icons-list-container" class="space-y-4">
            <div id="media-icons-loader" class="flex justify-center py-8">
              <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. メディア(バナー)管理 -->
      <div id="tab-content-media-banners" class="tab-content">
        <div
          class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-2xl font-bold mb-6">
            メディア(バナー)を追加 (media.html)
          </h2>
          <form id="add-media-banner-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="media-banner-image"
                  class="block text-sm font-medium"
                >
                  バナー画像
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="file"
                  id="media-banner-image"
                  accept="image/*"
                  required
                  class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
                />
                <p class="text-xs text-text-muted-light mt-1">
                  推奨: 600x400px (3:2比率)
                </p>
                <div
                  id="upload-progress-container-media-banner"
                  class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700"
                >
                  <div
                    id="upload-progress-bar-media-banner"
                    class="bg-primary h-2.5 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
                <img
                  id="image-preview-media-banner"
                  src=""
                  alt="画像プレビュー"
                  class="hidden mt-4 w-48 h-auto rounded-lg"
                />
              </div>
              <div>
                <label for="media-banner-url" class="block text-sm font-medium">
                  リンク先URL (http://...)
                </label>
                <input
                  type="url"
                  id="media-banner-url"
                  placeholder="https://..."
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="media-banner-order"
                  class="block text-sm font-medium"
                >
                  表示順 (数値)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="media-banner-order"
                  value="10"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label
                  for="media-banner-animation"
                  class="block text-sm font-medium"
                >
                  アニメーション選択
                </label>
                <!-- ★ 6つの選択肢 ★ -->
                <select
                  id="media-banner-animation"
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                >
                  <option value="none">なし</option>
                  <option value="pulse">ゆっくり光る</option>
                  <option value="wiggle">小さく揺れる</option>
                  <option value="squish">ぺこぺこへこむ</option>
                  <option value="flash">キラッと光る</option>
                  <option value="heartbeat">ドキドキ鼓動する</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium">表示ステータス</label>
              <div
                class="mt-2 flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600"
              >
                <label
                  for="media-banner-visible"
                  class="block text-sm font-medium"
                >
                  このバナーを公開する
                </label>
                <div
                  class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                >
                  <input
                    type="checkbox"
                    id="media-banner-visible"
                    checked
                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                  />
                  <label
                    for="media-banner-visible"
                    class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"
                  ></label>
                </div>
              </div>
              <p class="text-xs text-text-muted-light mt-1">
                ※オフにすると、一覧ページに表示されなくなります。
              </p>
            </div>

            <div>
              <button
                type="submit"
                id="submit-media-banner-btn"
                class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">add</span>
                <span>メディア(バナー)を追加する</span>
              </button>
            </div>
          </form>
        </div>
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">
            メディア(バナー)一覧
            <span
              id="media-banners-count-display"
              class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
            ></span>
          </h2>
          <div id="media-banners-list-container" class="space-y-4">
            <div id="media-banners-loader" class="flex justify-center py-8">
              <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ★★★ 5. ブログ・HP管理コンテンツ (NEW) ★★★ -->
      <div id="tab-content-sites" class="tab-content">
        <div
          class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-2xl font-bold mb-6">ブログ・HPを追加 (media.html)</h2>
          <form id="add-site-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="site-title" class="block text-sm font-medium">
                  タイトル
                  <span class="text-red-500">*</span>
                  (例: マネタイズラボ)
                </label>
                <input
                  type="text"
                  id="site-title"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="site-description" class="block text-sm font-medium">
                  解説内容
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="site-description"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="site-url" class="block text-sm font-medium">
                  リンク先URL (http://...)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="url"
                  id="site-url"
                  placeholder="https://..."
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>

              <div>
                <label for="site-order" class="block text-sm font-medium">
                  固定表示順 (1, 2... 0=日付順)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="site-order"
                  value="0"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="site-icon-name" class="block text-sm font-medium">
                  方法1: リストからアイコン選択
                </label>
                <select
                  id="site-icon-name"
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                >
                  <option value="insights">マネタイズ (insights)</option>
                  <option value="psychology">心理 (psychology)</option>
                  <option value="school">スクール (school)</option>
                  <option value="storefront">ストア (storefront)</option>
                  <option value="groups">コミュニティ (groups)</option>
                  <option value="link">その他 (link)</option>
                </select>
              </div>
              <div>
                <label for="site-icon-image" class="block text-sm font-medium">
                  方法2: カスタム画像アップロード
                </label>
                <input
                  type="file"
                  id="site-icon-image"
                  accept="image/*"
                  class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
                />
                <p class="text-xs text-text-muted-light mt-1">
                  推奨: 64x64px。こちらを選択すると方法1は無視されます。
                </p>
                <div
                  id="upload-progress-container-site"
                  class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700"
                >
                  <div
                    id="upload-progress-bar-site"
                    class="bg-primary h-2.5 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
                <img
                  id="image-preview-site"
                  src=""
                  alt="画像プレビュー"
                  class="hidden mt-4 w-16 h-16 rounded-lg"
                />
              </div>
            </div>
            <div>
              <button
                type="submit"
                id="submit-site-btn"
                class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">add</span>
                <span>ブログ・HPを追加する</span>
              </button>
            </div>
          </form>
        </div>
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">
            ブログ・HP一覧
            <span
              id="sites-count-display"
              class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
            ></span>
          </h2>
<div id="sites-list-container" class="space-y-4">
        <div id="sites-loader" class="flex justify-center py-8">
          <div class="loader"></div>
        </div>
      </div>
    </div>
  </div>

      <!-- 2. ブログ記事管理 -->
      <div id="tab-content-blog-posts" class="tab-content hidden space-y-8">
        <!-- Sub-tabs Navigation -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6 overflow-x-auto" id="sub-tabs-container-blog-posts">
          <button class="sub-tab-btn active py-2 px-4 font-medium text-sm border-b-2 border-primary text-primary whitespace-nowrap transition-colors" data-subtab="blog-meta">
            メタデータ管理
          </button>
          <button class="sub-tab-btn py-2 px-4 font-medium text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap transition-colors" data-subtab="blog-dynamic">
            動的ブログ作成
          </button>
          <button class="sub-tab-btn py-2 px-4 font-medium text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 whitespace-nowrap transition-colors" data-subtab="blog-categories">
            カテゴリー管理
          </button>
        </div>

        <!-- Sub-tab Content: Metadata Management -->
        <div id="sub-tab-content-blog-meta" class="sub-tab-content-blog-posts">
          <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold mb-6">ブログ記事のメタデータを追加 (P2)</h2>
            <form id="add-blog-post-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="blog-post-title" class="block text-sm font-medium">タイトル<span class="text-red-500">*</span></label>
                  <input type="text" id="blog-post-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
                <div>
                  <label for="blog-post-url" class="block text-sm font-medium">リンク先URL<span class="text-red-500">*</span> (例: blog/post1.html)</label>
                  <input type="text" id="blog-post-url" placeholder="blog/post1.html" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
                <div>
                  <label for="blog-post-image" class="block text-sm font-medium">アイキャッチ画像<span class="text-red-500">*</span></label>
                  <input type="file" id="blog-post-image" accept="image/*" required class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
                  <div id="upload-progress-container-blog-post" class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                    <div id="upload-progress-bar-blog-post" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                  </div>
                  <img id="image-preview-blog-post" src="" alt="画像プレビュー" class="hidden mt-4 w-48 h-auto rounded-lg" />
                </div>
              </div>

              <div>
                <label for="blog-post-description" class="block text-sm font-medium">解説文<span class="text-red-500">*</span> (一覧に表示されます)</label>
                <textarea id="blog-post-description" rows="3" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" placeholder="この記事の簡単な概要..."></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="blog-post-category-select" class="block text-sm font-medium">ブログカテゴリー<span class="text-red-500">*</span></label>
                  <select id="blog-post-category-select" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                    <option value="" disabled selected>カテゴリーを読み込み中...</option>
                  </select>
                  <p class="text-xs text-text-muted-light mt-1">※カテゴリーは「カテゴリー管理」タブで追加・削除できます。</p>
                </div>
                <div>
                  <label for="blog-post-order" class="block text-sm font-medium">固定表示順 (1, 2... 0=日付順)<span class="text-red-500">*</span></label>
                  <input type="number" id="blog-post-order" value="0" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium">リンクオプション</label>
                <div class="mt-2 flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600">
                  <label for="blog-post-open-new-tab" class="block text-sm font-medium">記事を新しいタブで開く</label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="blog-post-open-new-tab" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label for="blog-post-open-new-tab" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
                  </div>
                </div>
                <p class="text-xs text-text-muted-light mt-1">※チェックを外すと、同じウィンドウで開きます。</p>
              </div>
              <div>
                <button type="submit" id="submit-blog-post-btn" class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">add</span>
                  <span>ブログ記事メタを追加する</span>
                </button>
              </div>
            </form>
          </div>

          <div class="mt-12">
            <h2 class="text-2xl font-bold mb-6">ブログ記事メタデータ一覧 <span id="blog-posts-count-display" class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"></span></h2>
            <div class="mb-4 relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                <span class="material-symbols-outlined">search</span>
              </span>
              <input type="text" id="search-blog-posts" placeholder="キーワードで絞り込み..." class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
            </div>
            <div id="blog-posts-list-container" class="space-y-4">
              <div id="blog-posts-loader" class="flex justify-center py-8"><div class="loader"></div></div>
            </div>
          </div>
        </div>

        <!-- Sub-tab Content: Dynamic Editor -->
        <div id="sub-tab-content-blog-dynamic" class="sub-tab-content-blog-posts hidden">
          <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold mb-6">動的ブログ記事 本文作成フォーム</h2>
            <p class="text-text-muted-light dark:text-text-muted-dark mb-6">
              ここでは、記事のタイトル、本文（リッチテキスト）、およびアイキャッチ画像を設定し、Firestoreの専用コレクション（blogContentsなど）に保存します。
            </p>
            <form id="add-dynamic-blog-form" class="space-y-6">
              <div>
                <label for="dynamic-post-title" class="block text-sm font-medium">記事タイトル<span class="text-red-500">*</span></label>
                <input type="text" id="dynamic-post-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>

              <div>
                <label class="block text-sm font-medium">記事本文 (カスタムHTMLブロック)<span class="text-red-500">*</span></label>
                <div id="html-blocks-container" class="space-y-4 mt-2"></div>
                <button type="button" id="add-html-block-btn" class="mt-4 py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">add</span>
                  <span>HTMLブロックを追加</span>
                </button>
              </div>

              <div>
                <label for="dynamic-post-image" class="block text-sm font-medium">アイキャッチ画像</label>
                <input type="file" id="dynamic-post-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
                <div id="upload-progress-container-dynamic-post" class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                  <div id="upload-progress-bar-dynamic-post" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <img id="image-preview-dynamic-post" src="" alt="画像プレビュー" class="hidden mt-4 w-48 h-auto rounded-lg" />
              </div>

              <div>
                <div class="flex gap-4">
                  <button type="button" id="preview-dynamic-blog-btn" class="flex-1 sm:flex-none py-3 px-8 bg-gray-600 text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>新しいタブでプレビュー</span>
                  </button>
                  <button type="submit" id="submit-dynamic-post-btn" class="flex-1 sm:flex-none py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">save</span>
                    <span>記事を保存する</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="mt-12">
            <h2 class="text-2xl font-bold mb-6">動的ブログ記事一覧 <span id="dynamic-blogs-count-display" class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"></span></h2>
            <div class="mb-4 relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                <span class="material-symbols-outlined">search</span>
              </span>
              <input type="text" id="search-dynamic-blogs" placeholder="キーワードで絞り込み..." class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
            </div>
            <div id="dynamic-blogs-list-container" class="space-y-4">
              <div id="dynamic-blogs-loader" class="flex justify-center py-8"><div class="loader"></div></div>
            </div>
          </div>
        </div>

        <!-- Sub-tab Content: Category Management -->
        <div id="sub-tab-content-blog-categories" class="sub-tab-content-blog-posts hidden">
          <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-6">ブログカテゴリー管理</h3>
            <form id="add-blog-category-form" class="flex gap-4 mb-6">
              <div class="flex-grow">
                <label for="blog-category-name" class="block text-sm font-medium">新規カテゴリー名</label>
                <input type="text" id="blog-category-name" required placeholder="例: マインドセット" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>
              <div class="flex-shrink-0 self-end">
                <button type="submit" id="submit-blog-category-btn" class="py-3 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">add</span> <span>追加</span>
                </button>
              </div>
            </form>
            
            <div class="mt-12">
                <h4 class="text-lg font-bold mb-4">登録済みカテゴリー一覧</h4>
                <div id="blog-categories-list-container" class="space-y-2">
                  <div id="blog-categories-loader" class="flex justify-center py-4"><div class="loader"></div></div>
                </div>
            </div>
          </div>
        </div>
      </div>


  <div id="tab-content-static-pages" class="tab-content">
    <div class="mb-6 border-b border-slate-300 dark:border-slate-600">
      <nav class="sub-tabs-container flex gap-4 -mb-px flex-wrap">
        <button
          class="sub-tab-btn active text-sm font-bold"
          data-sub-tab="common"
            >
              <span
                class="material-symbols-outlined align-middle !text-lg mr-1"
              >
                layers
              </span>
              ページ共通 (Aタイプ)
            </button>
            <button
              class="sub-tab-btn text-sm font-bold"
              data-sub-tab="timeline"
            >
              <span
                class="material-symbols-outlined align-middle !text-lg mr-1"
              >
                history
              </span>
              経歴 (Timeline)
            </button>
            <button class="sub-tab-btn text-sm font-bold" data-sub-tab="skills">
              <span
                class="material-symbols-outlined align-middle !text-lg mr-1"
              >
                construction
              </span>
              スキル
            </button>
            <button class="sub-tab-btn text-sm font-bold" data-sub-tab="personal">
              <span
                class="material-symbols-outlined align-middle !text-lg mr-1"
              >
                person
              </span>
              パーソナル
            </button>
            <button class="sub-tab-btn text-sm font-bold" data-sub-tab="contact">
              <span
                class="material-symbols-outlined align-middle !text-lg mr-1"
              >
                mail
              </span>
              お問い合わせ
            </button>
          </nav>
        </div>

        <!-- サブ・タブコンテンツ -->

        <!-- 1. ページ共通 -->
        <div class="sub-tab-content active" id="sub-tab-content-common">
          <div
            class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
          >
            <h2 class="text-2xl font-bold mb-6">
              ページ共通コンテンツ管理 (Aタイプ)
            </h2>
            <p class="text-text-muted-light dark:text-text-muted-dark">
              ここは、`index.html` のヒーロータイトル、`profile.html`
              のプロフィール画像、`service.html`
              の講師紹介など、各ページ固有の「単一コンテンツ」を編集する場所です。
              <br />
              今後、ここに各ページ（index, profile,
              vision...）の編集フォームをアコーディオン形式で追加していきます。
            </p>
          </div>

        </div>
        <!-- 2. 経歴 (Timeline) -->
        <div class="sub-tab-content" id="sub-tab-content-timeline">
          <div
            class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
          >
            <h2 class="text-2xl font-bold mb-6">経歴項目を追加 (profile.html)</h2>
            <form id="add-timeline-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="timeline-year" class="block text-sm font-medium">
                    年代・期間 (例: 2018 - 現在)
                    <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="timeline-year"
                    required
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  />
                </div>
                <div>
                  <label for="timeline-title" class="block text-sm font-medium">
                    タイトル (例: メンタルトレーナー)
                    <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="timeline-title"
                    required
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  />
                </div>
              </div>
              <div>
                <label for="timeline-company" class="block text-sm font-medium">
                  企業・組織名 (例: 個人事業)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="timeline-company"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="timeline-description" class="block text-sm font-medium">
                  詳細説明
                  <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="timeline-description"
                  rows="3"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  placeholder="具体的な業務内容や成果を記述..."
                ></textarea>
              </div>
              <div>
                <button
                  type="submit"
                  id="submit-timeline-btn"
                  class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                >
                  <span class="material-symbols-outlined">add</span>
                  <span>経歴項目を追加する</span>
                </button>
              </div>
            </form>
          </div>
          <div class="mt-12">
            <h3 class="text-xl font-bold mb-6">登録済み経歴一覧</h3>
            <div id="timeline-list-container" class="space-y-4">
              <div id="timeline-loader" class="flex justify-center py-8">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. スキル -->
        <div class="sub-tab-content" id="sub-tab-content-skills">
          <div
            class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
          >
            <h2 class="text-2xl font-bold mb-6">スキル項目を追加 (profile.html)</h2>
            <form id="add-skills-form" class="space-y-6">
              <div>
                <label for="skill-title" class="block text-sm font-medium">
                  タイトル (例: メンタルトレーニング)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="skill-title"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div>
                <label for="skill-subtitle" class="block text-sm font-medium">
                  サブタイトル・詳細 (例: パフォーマンス最大化)
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="skill-subtitle"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="skill-icon" class="block text-sm font-medium">
                    アイコン名 (Material Symbols)
                    <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="skill-icon"
                    required
                    placeholder="psychology"
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  />
                </div>
                <div>
                  <label for="skill-image" class="block text-sm font-medium">カスタム画像アイコン (任意)</label>
                  <input type="file" id="skill-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
                  <p class="text-xs text-text-muted-light mt-1">※画像をアップロードすると、Material Symbolsの代わりに表示されます。</p>
                  <img id="image-preview-skill" src="" alt="画像プレビュー" class="hidden mt-4 w-16 h-16 rounded-lg" />
                  <div id="upload-progress-container-skill" class="hidden mt-2 w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                    <div id="upload-progress-bar-skill" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                  </div>
                </div>
                <div>
                  <label for="skill-order" class="block text-sm font-medium">
                    表示順 (数値)
                    <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="number"
                    id="skill-order"
                    value="10"
                    required
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  />
                </div>
              </div>
              <div>
                <button
                  type="submit"
                  id="submit-skills-btn"
                  class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                >
                  <span class="material-symbols-outlined">add</span>
                  <span>スキル項目を追加する</span>
                </button>
              </div>
            </form>
          </div>
          <div class="mt-12">
            <h3 class="text-xl font-bold mb-6">登録済みスキル一覧</h3>
            <div id="skills-list-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <div id="skills-loader" class="flex justify-center py-8 col-span-full">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. サービス特徴 -->
        <div class="sub-tab-content" id="sub-tab-content-personal">
          <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold mb-6">パーソナル情報を追加 (profile.html)</h2>
            <form id="add-personal-form" class="space-y-6">
              <div>
                <label for="personal-title" class="block text-sm font-medium">タイトル (例: 趣味)<span class="text-red-500">*</span></label>
                <input type="text" id="personal-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>
              <div>
                <label for="personal-description" class="block text-sm font-medium">内容・詳細<span class="text-red-500">*</span></label>
                <textarea id="personal-description" rows="3" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" placeholder="詳細を入力..."></textarea>
              </div>
              <div>
                <label for="personal-order" class="block text-sm font-medium">表示順 (数値)<span class="text-red-500">*</span></label>
                <input type="number" id="personal-order" value="10" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
              </div>
              <div>
                <button type="submit" id="submit-personal-btn" class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">add</span>
                  <span>パーソナル情報を追加</span>
                </button>
              </div>
            </form>
          </div>
          <div class="mt-12">
            <h3 class="text-xl font-bold mb-6">登録済みパーソナル情報一覧</h3>
            <div id="personal-list-container" class="space-y-4">
              <div id="personal-loader" class="flex justify-center py-8"><div class="loader"></div></div>
            </div>
          </div>
        </div>

        <!-- 5. 講座内容 -->
        <div class="sub-tab-content" id="sub-tab-content-contact">
          <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold mb-6">お問い合わせセット管理</h2>
            
            <!-- Set List Section -->
            <div id="contact-sets-list-section" class="mb-8">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">登録済みセット一覧</h3>
                <button type="button" id="create-new-set-btn" class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1">
                  <span class="material-symbols-outlined">add</span>
                  <span>新規セット作成</span>
                </button>
              </div>
              <div id="contact-sets-container" class="grid grid-cols-1 gap-4">
                <div class="flex justify-center py-8"><div class="loader"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 1. お知らせ管理 -->

            <!-- Set Editor Section (Hidden by default) -->
            <div id="contact-set-editor-section" class="hidden border-t border-slate-200 dark:border-slate-700 pt-8">
              <h3 id="editor-title" class="text-xl font-bold mb-6">新規セット作成</h3>
              <form id="contact-set-form" class="space-y-6">
                <input type="hidden" id="set-id" />
                
                <!-- Set Name -->
                <div>
                  <label for="set-title" class="block text-sm font-medium">セット名 (管理用)<span class="text-red-500">*</span></label>
                  <input type="text" id="set-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" placeholder="例: 標準セット (電話+LINE)" />
                </div>

                <!-- CTA Settings -->
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
                  <h4 class="font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">call_to_action</span>
                    CTA設定
                  </h4>
                  <div class="space-y-4">
                    <label class="inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="set-cta-visible" class="sr-only peer">
                      <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                      <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">CTAブロックを表示</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs font-medium text-text-muted-light mb-1">メイン見出し</label>
                        <input type="text" id="set-cta-main-text" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-text-muted-light mb-1">ボタンテキスト</label>
                        <input type="text" id="set-cta-button-text" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-text-muted-light mb-1">サブテキスト</label>
                      <textarea id="set-cta-sub-text" rows="2" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"></textarea>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-text-muted-light mb-1">ボタンURL</label>
                      <input type="url" id="set-cta-button-url" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                    </div>
                    <div>
                      <label for="set-cta-align" class="block text-xs font-medium text-text-muted-light mb-1">配置 (Align)</label>
                      <select id="set-cta-align" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                        <option value="text-center">中央寄せ</option>
                        <option value="text-left">左寄せ</option>
                        <option value="text-right">右寄せ</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Contact List -->
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
                  <h4 class="font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">list</span>
                    連絡先リスト
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                      <label for="items-columns" class="block text-sm font-medium">リストの列数</label>
                      <select id="items-columns" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                        <option value="1">1列 (縦積み)</option>
                        <option value="2">2列</option>
                        <option value="3">3列</option>
                      </select>
                    </div>
                    <div>
                      <label for="items-icon-position" class="block text-sm font-medium">アイコンの位置</label>
                      <select id="items-icon-position" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                        <option value="flex-row">横 (アイコンの右に文字)</option>
                        <option value="flex-col">縦 (アイコンの下に文字)</option>
                      </select>
                    </div>
                    <div>
                      <label for="items-align" class="block text-sm font-medium">文字の配置</label>
                      <select id="items-align" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                        <option value="text-left">左寄せ</option>
                        <option value="text-center">中央寄せ</option>
                        <option value="text-right">右寄せ</option>
                      </select>
                    </div>
                  </div>
                  <div id="set-contact-items-container" class="space-y-4 mb-4">
                    <!-- Dynamic Items -->
                  </div>
                  <button type="button" id="add-contact-item-btn" class="text-sm text-primary hover:text-primary-dark font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined">add_circle</span>
                    項目を追加
                  </button>
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-4">
                  <button type="button" id="cancel-set-btn" class="py-2 px-6 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition-colors">キャンセル</button>
                  <button type="submit" id="save-set-btn" class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">save</span>
                    <span>セットを保存</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- カスタムHTML部品管理 -->
    <div id="tab-content-custom-html" class="tab-content">
      <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">カスタムHTML部品管理</h2>
          <button
            id="add-custom-part-btn"
            class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"
          >
            <span class="material-symbols-outlined">add</span>
            <span>新規作成</span>
          </button>
        </div>

        <!-- 検索・フィルタエリア -->
        <div class="mb-6 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- キーワード検索 -->
            <div class="md:col-span-2">
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                  <span class="material-symbols-outlined">search</span>
                </span>
                <input
                  type="text"
                  id="search-custom-parts"
                  placeholder="タイトル・メモで検索..."
                  class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                />
              </div>
            </div>
            <!-- カテゴリフィルタ -->
            <div>
              <select
                id="filter-custom-parts-category"
                class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
              >
                <option value="">全カテゴリ</option>
                <option value="バナー">バナー</option>
                <option value="ボタン">ボタン</option>
                <option value="告知">告知</option>
                <option value="その他">その他</option>
              </select>
            </div>
          </div>
          <!-- アーカイブを含める -->
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              id="include-archived-parts"
              class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
            />
            <label for="include-archived-parts" class="text-sm font-medium">
              アーカイブを含める
            </label>
          </div>
        </div>

        <!-- 部品一覧エリア -->
        <div>
          <h3 class="text-xl font-bold mb-4">
            登録済み部品
            <span
              id="custom-parts-count-display"
              class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
            ></span>
          </h3>
          <div id="custom-parts-list-container" class="space-y-4">
            <div id="custom-parts-loader" class="flex justify-center py-8">
              <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 登録リンク管理 -->
    <div id="tab-content-saved-links" class="tab-content">
      <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
        <h2 class="text-2xl font-bold mb-6">よく使うリンクの管理</h2>
        <form id="add-saved-link-form" class="space-y-6 mb-10">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="saved-link-title" class="block text-sm font-medium">タイトル <span class="text-red-500">*</span></label>
              <input type="text" id="saved-link-title" required placeholder="例: Amazonアフィリエイト" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
            </div>
            <div>
              <label for="saved-link-url" class="block text-sm font-medium">URL <span class="text-red-500">*</span></label>
              <input type="url" id="saved-link-url" required placeholder="https://..." class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
            </div>
          </div>
          <div>
            <label for="saved-link-memo" class="block text-sm font-medium">メモ / 検索用キーワード</label>
            <input type="text" id="saved-link-memo" placeholder="例: 商品紹介用、プロフィール用" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
          </div>
          <button type="submit" id="submit-saved-link-btn" class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
            <span class="material-symbols-outlined">add</span> <span>リンクを登録</span>
          </button>
        </form>

        <div>
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">登録済みリンク一覧 <span id="saved-links-count-display" class="text-sm font-normal text-text-muted-light"></span></h3>
            <div class="relative w-64">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><span class="material-symbols-outlined">search</span></span>
              <input type="text" id="search-saved-links" placeholder="キーワードで検索..." class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
            </div>
          </div>
          <div id="saved-links-list-container" class="space-y-3">
            <div id="saved-links-loader" class="flex justify-center py-8"><div class="loader"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ★ NEW: ページ共通管理 (Common Management) -->
    <div id="tab-content-common-management" class="tab-content">
      <div
        class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700"
      >
        <h2 class="text-2xl font-bold mb-6">ページ共通管理</h2>
        
        <!-- Sub-tabs Navigation -->
        <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
          <nav class="flex gap-4" id="sub-tabs-container-common-management">
            <button class="sub-tab-btn active px-4 py-2 text-sm font-bold border-b-2 border-primary text-primary" data-subtab="basic-settings">基本設定</button>
            <button class="sub-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-subtab="nav-settings">ナビゲーション設定</button>
            <button class="sub-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-subtab="site-common">サイト共通設定</button>
            <button class="sub-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-subtab="system-settings">システム設定</button>
          </nav>
        </div>

        <!-- Sub-tabs Content -->
        
        <!-- 1. 基本設定 (Basic Settings) -->
        <div id="sub-tab-content-basic-settings" class="sub-tab-content-common active">
            <!-- サイトタイトル・ロゴ管理 -->
            <div class="mb-10">
              <h3
                class="text-xl font-bold mb-4 pb-2 border-b border-slate-200 dark:border-slate-700"
              >
                サイトタイトル・ロゴ管理
              </h3>
              <form id="update-site-branding-form" class="space-y-6">
                <div>
                  <label for="site-title-input" class="block text-sm font-medium">
                    サイトタイトル
                  </label>
                  <input
                    type="text"
                    id="site-title-input"
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                    placeholder="例: My Portfolio"
                  />
                </div>
                <div>
                  <label for="site-logo-input" class="block text-sm font-medium">
                    ロゴ画像 (変更する場合)
                  </label>
                  <input
                    type="file"
                    id="site-logo-input"
                    accept="image/*"
                    class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
                  />
                  <div class="mt-4">
                    <p class="text-xs text-text-muted-light mb-2">現在のロゴ:</p>
                    <img
                      id="current-site-logo-preview"
                      src=""
                      alt="Current Logo"
                      class="h-12 w-auto object-contain border border-slate-200 dark:border-slate-700 rounded p-1 bg-white"
                      onerror="this.style.display='none'"
                    />
                  </div>
                </div>
                <div class="flex justify-end">
                  <button
                    type="submit"
                    id="save-site-branding-btn"
                    class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined">save</span>
                    <span>サイト設定を保存</span>
                  </button>
                </div>
              </form>
            </div>
        </div>

        <!-- 2. ナビゲーション設定 (Navigation Settings) -->
        <div id="sub-tab-content-nav-settings" class="sub-tab-content-common hidden">
            <!-- Nested Tabs Navigation -->
            <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
              <nav class="flex gap-4" id="nested-tabs-nav-settings">
                <button class="nested-tab-btn active px-4 py-2 text-sm font-bold border-b-2 border-primary text-primary" data-nested-tab="global-nav">ナビゲーション項目</button>
                <button class="nested-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-nested-tab="bottom-nav">ボトムナビ項目</button>
              </nav>
            </div>

            <!-- Nested Content: Global Nav -->
            <div id="nested-content-global-nav" class="nested-tab-content">
              <div class="mb-12">
            <div class="mb-8 p-5 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
              <h4 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">dock_to_left</span>
                メニューの配置設定
              </h4>
              <form id="update-nav-align-form" class="flex flex-col sm:flex-row items-end gap-4">
                <div class="flex-grow w-full">
                  <label for="nav-align-select" class="block text-sm font-medium mb-1">PC表示時の配置位置</label>
                  <select id="nav-align-select" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                    <option value="justify-start">左寄せ</option>
                    <option value="justify-center">中央寄せ</option>
                    <option value="justify-end">右寄せ</option>
                  </select>
                </div>
                <button type="submit" id="save-nav-align-btn" class="w-full sm:w-auto py-2.5 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">save</span>
                  <span>配置を保存</span>
                </button>
              </form>
            </div>

                <h3 class="text-xl font-bold mb-6">
                  ナビゲーション項目を追加
                </h3>
                <form id="add-navigation-form" class="space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label for="nav-title" class="block text-sm font-medium">
                        メニュー名
                        <span class="text-red-500">*</span>
                        (例: ホーム)
                      </label>
                      <input
                        type="text"
                        id="nav-title"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                    <div>
                      <label for="nav-url" class="block text-sm font-medium">
                        リンク先URL
                        <span class="text-red-500">*</span>
                        (例: index.html)
                      </label>
                      <input
                        type="text"
                        id="nav-url"
                        placeholder="index.html"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                    <div>
                      <label for="nav-order" class="block text-sm font-medium">
                        表示順 (数値)
                        <span class="text-red-500">*</span>
                      </label>
                      <input
                        type="number"
                        id="nav-order"
                        value="10"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                  </div>
                  <div>
                    <button
                      type="submit"
                      id="submit-navigation-btn"
                      class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                    >
                      <span class="material-symbols-outlined">add</span>
                      <span>メニュー項目を追加する</span>
                    </button>
                  </div>
                </form>
              </div>

              <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6">
                  ナビゲーション項目一覧
                  <span
                    id="navigation-count-display"
                    class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
                  ></span>
                </h2>
                <div id="navigation-list-container" class="space-y-4">
                  <div id="navigation-loader" class="flex justify-center py-8">
                    <div class="loader"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Nested Content: Bottom Nav -->
            <div id="nested-content-bottom-nav" class="nested-tab-content hidden">
              <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6">
                  ボトムナビ項目を追加 (全ページ共通)
                </h2>
                <p class="text-text-muted-light dark:text-text-muted-dark mb-6">
                  スマホ・タブレット表示時に画面下部に固定表示されるメニュー（最大5個推奨）を管理します。
                </p>
            <div class="mb-8 p-5 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
              <h4 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">align_horizontal_center</span>
                ボトムナビの配置設定
              </h4>
              <form id="update-bottom-nav-align-form" class="flex flex-col sm:flex-row items-end gap-4">
                <div class="flex-grow w-full">
                  <label for="bottom-nav-align-select" class="block text-sm font-medium mb-1">配置位置</label>
                  <select id="bottom-nav-align-select" class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
                    <option value="justify-around">等間隔 (デフォルト)</option>
                    <option value="justify-start">左寄せ</option>
                    <option value="justify-center">中央寄せ</option>
                    <option value="justify-end">右寄せ</option>
                    <option value="justify-between">両端揃え</option>
                  </select>
                </div>
                <button type="submit" id="save-bottom-nav-align-btn" class="w-full sm:w-auto py-2.5 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">save</span>
                  <span>配置を保存</span>
                </button>
              </form>
            </div>

                <form id="add-bottom-nav-form" class="space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label for="bottom-nav-title" class="block text-sm font-medium">
                        メニュー名
                        <span class="text-red-500">*</span>
                        (例: ホーム)
                      </label>
                      <input
                        type="text"
                        id="bottom-nav-title"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                    <div>
                      <label for="bottom-nav-url" class="block text-sm font-medium">
                        リンク先URL
                        <span class="text-red-500">*</span>
                        (例: index.html)
                      </label>
                      <input
                        type="text"
                        id="bottom-nav-url"
                        placeholder="index.html"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                    <div>
                      <label for="bottom-nav-order" class="block text-sm font-medium">
                        表示順 (数値)
                        <span class="text-red-500">*</span>
                      </label>
                      <input
                        type="number"
                        id="bottom-nav-order"
                        value="10"
                        required
                        class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      />
                    </div>
                  </div>
                  <div>
                    <label for="bottom-nav-icon" class="block text-sm font-medium">
                      アイコン名 (Material Icons)
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="bottom-nav-icon"
                      placeholder="home"
                      required
                      class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                    />
                    <p class="text-xs text-text-muted-light mt-1">
                      例:
                      <span
                        class="font-mono p-1 bg-slate-200 dark:bg-slate-700 rounded-sm"
                      >
                        home
                      </span>
                      ,
                      <span
                        class="font-mono p-1 bg-slate-200 dark:bg-slate-700 rounded-sm"
                      >
                        person
                      </span>
                      ,
                      <span
                        class="font-mono p-1 bg-slate-200 dark:bg-slate-700 rounded-sm"
                      >
                        article
                      </span>
                      ,
                      <span
                        class="font-mono p-1 bg-slate-200 dark:bg-slate-700 rounded-sm"
                      >
                        mail
                      </span>
                    </p>
                  </div>
                  <div>
                    <label for="bottom-nav-image" class="block text-sm font-medium">カスタム画像アイコン (任意)</label>
                    <input type="file" id="bottom-nav-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
                    <p class="text-xs text-text-muted-light mt-1">※画像をアップロードすると、Material Iconsの代わりに表示されます。</p>
                  </div>
                  <div>
                    <button
                      type="submit"
                      id="submit-bottom-nav-btn"
                      class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                    >
                      <span class="material-symbols-outlined">add</span>
                      <span>ボトムナビ項目を追加する</span>
                    </button>
                  </div>
                </form>
              </div>

              <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6">
                  ボトムナビ項目一覧
                  <span
                    id="bottom-nav-count-display"
                    class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
                  ></span>
                </h2>
                <div id="bottom-nav-list-container" class="space-y-4">
                  <div id="bottom-nav-loader" class="flex justify-center py-8">
                    <div class="loader"></div>
                  </div>
                </div>
              </div>
            </div>
        </div>

        <!-- 3. サイト共通設定 (Site Common) -->
        <div id="sub-tab-content-site-common" class="sub-tab-content-common hidden">
            <!-- Nested Tabs Navigation -->
            <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
              <nav class="flex gap-4" id="nested-tabs-site-common">
                <button class="nested-tab-btn active px-4 py-2 text-sm font-bold border-b-2 border-primary text-primary" data-nested-tab="header-cta">ヘッダーCTA</button>
                <button class="nested-tab-btn px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" data-nested-tab="footer">フッター設定</button>
              </nav>
            </div>

            <!-- Nested Content: Header CTA -->
            <div id="nested-content-header-cta" class="nested-tab-content">
              <!-- ヘッダーCTAボタン管理 -->
              <div class="mb-12">
                <h3 class="text-xl font-bold mb-6">
                  ヘッダーCTAボタン管理 (全ページ共通)
                </h3>
                <form id="update-header-cta-form" class="space-y-6">
                  <!-- 1. 表示/非表示 -->
                  <div
                    class="flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600"
                  >
                    <label for="header-cta-visible" class="block text-sm font-medium">
                      CTAボタンを表示する
                    </label>
                    <div
                      class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                    >
                      <!-- ★ トグルスイッチのHTML ★ -->
                      <input
                        type="checkbox"
                        id="header-cta-visible"
                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                      />
                      <label
                        for="header-cta-visible"
                        class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"
                      ></label>
                    </div>
                  </div>

                  <!-- 2. 表示文字 -->
                  <div>
                    <label for="header-cta-text" class="block text-sm font-medium">
                      表示文字 (例: 無料講座)
                    </label>
                    <input
                      type="text"
                      id="header-cta-text"
                      class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                    />
                  </div>

                  <!-- 3. リンク先URL -->
                  <div>
                    <label for="header-cta-url" class="block text-sm font-medium">
                      リンク先URL (例: free-course.html)
                    </label>
                    <input
                      type="text"
                      id="header-cta-url"
                      placeholder="free-course.html"
                      class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                    />
                  </div>

                  <!-- 4. 保存ボタン -->
                  <div>
                    <button
                      type="submit"
                      id="submit-header-cta-btn"
                      class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                    >
                      <span class="material-symbols-outlined">save</span>
                      <span>共通設定を保存</span>
                    </button>
                  </div>
                </form>
                <!-- 5. ローダー（読み込み中表示） -->
                <div id="header-cta-loader" class="hidden flex justify-center py-8">
                  <div class="loader"></div>
                </div>
              </div>
            </div>

            <!-- Nested Content: Footer -->
            <div id="nested-content-footer" class="nested-tab-content hidden">
              <!-- フッター設定 -->
              <div class="mb-12">
                <h3 class="text-xl font-bold mb-6">
                  フッター設定 (全ページ共通)
                </h3>
                <form id="update-footer-text-form" class="space-y-6">
                  <!-- フッターテキスト -->
                  <div>
                    <label for="footer-text-input" class="block text-sm font-medium mb-2">
                      フッターテキスト
                    </label>
                    <input
                      type="text"
                      id="footer-text-input"
                      class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                      placeholder="© 2024 My Website. All rights reserved."
                    />
                    <p class="text-xs text-text-muted-light mt-1">
                      ※ <code>{year}</code> と入力すると、現在の西暦（例: <span id="current-year-preview">2024</span>）に自動変換されます。
                    </p>
                  </div>

                  <!-- 保存ボタン -->
                  <div>
                    <button
                      type="submit"
                      id="submit-footer-text-btn"
                      class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                    >
                      <span class="material-symbols-outlined">save</span>
                      <span>フッター設定を保存</span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
        </div>
        <!-- ローダー（読み込み中表示） -->
              <div id="footer-text-loader" class="hidden flex justify-center py-8">
                <div class="loader"></div>
              </div>
            </div>

        <!-- 4. システム設定 (System Settings) -->
        <div id="sub-tab-content-system-settings" class="sub-tab-content-common hidden">
            <!-- サイトマップ管理 -->
            <div class="mb-12">
              <h2 class="text-2xl font-bold mb-6">サイトマップ管理 (Phase 3-3)</h2>
              <p class="text-text-muted-light dark:text-text-muted-dark mb-6">
                ここでは、サイト内の全ページ（主要ページ ＋
                Firestoreに登録済みの全アイテム）を自動でリストアップします。
                <br />
                「未登録」のアイテムをサイトマップ（`sitemapEntries`
                コレクション）に一括で追加できます。
              </p>
              <div class="flex flex-col sm:flex-row">
                <button type="button" id="scan-sitemap-btn" class="w-full sm:w-auto py-3 px-8 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">refresh</span>
                  <span>サイト内全ページのスキャンを開始</span>
                </button>
                <button type="button" id="download-sitemap-btn" class="w-full sm:w-auto py-3 px-8 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-opacity flex items-center justify-center gap-2 mt-4 sm:mt-0 sm:ml-4">
                  <span class="material-symbols-outlined">download</span>
                  <span>sitemap.xml をダウンロード</span>
                </button>
              </div>

              <div class="mt-12">
                <h2 class="text-2xl font-bold mb-6">
                  スキャン結果: サイトマップ登録状況
                  <span
                    id="sitemap-count-display"
                    class="text-lg font-normal text-text-muted-light dark:text-text-muted-dark"
                  ></span>
                </h2>
                <div class="mb-4 relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                    <span class="material-symbols-outlined">search</span>
                  </span>
                  <input type="text" id="search-sitemap" placeholder="キーワードで絞り込み..." class="block w-full pl-10 pr-3 py-2 rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
                </div>
                <div id="sitemap-list-container" class="space-y-4">
                  <div id="sitemap-loader" class="flex justify-center py-8 hidden">
                    <div class="loader"></div>
                  </div>
                  <p
                    id="sitemap-prompt"
                    class="text-center text-text-muted-light dark:text-text-muted-dark"
                  >
                    「スキャンを開始」ボタンを押してください。
                  </p>
                </div>
              </div>
            </div>


        </div>

      </div>
    </div>

    <!-- ★★★ 編集モーダル (NEW) ★★★ -->
    <!-- このモーダルは全タブで共通して使用します -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen p-4">
        <!-- オーバーレイ -->
        <div
          id="modal-overlay"
          class="modal-overlay fixed inset-0 bg-black opacity-50"
        ></div>

        <!-- モーダルコンテンツ -->
        <div
          class="modal-content bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg w-full max-w-2xl z-10 transform scale-95 opacity-0 border border-slate-200 dark:border-slate-700"
        >
          <!-- フォーム（ヘッダーとフッターを含む） -->
          <form id="edit-form">
            <!-- ヘッダー -->
            <div
              class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
            >
              <h3 id="edit-modal-title" class="text-2xl font-bold">
                アイテムを編集
              </h3>
              <button
                id="close-modal-btn"
                type="button"
                class="text-text-muted-light dark:text-text-muted-dark hover:text-text-light dark:hover:text-text-dark"
              >
                <span class="material-symbols-outlined text-3xl">close</span>
              </button>
            </div>

            <!-- 中身 (ここに各フォームが挿入される) -->
            <div
              id="edit-form-content"
              class="modal-body p-6 max-h-[60vh] overflow-y-auto space-y-6"
            >
              <!-- フォームの中身はJSで動的に挿入されます -->
            </div>

            <!-- フッター -->
            <div
              class="flex items-center justify-end gap-4 p-4 border-t border-slate-200 dark:border-slate-700"
            >
              <button
                id="cancel-modal-btn"
                type="button"
                class="py-2 px-6 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition-colors"
              >
                キャンセル
              </button>
              <button
                id="update-submit-btn"
                type="submit"
                class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">save</span>
                <span>変更を保存</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- ★★★ 書籍埋め込みスニペット取得モーダル (NEW) ★★★ -->
    <div id="snippet-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen p-4">
        <!-- オーバーレイ -->
        <div
          class="modal-overlay fixed inset-0 bg-black opacity-50"
          onclick="document.getElementById('snippet-modal').classList.add('hidden')"
        ></div>

        <!-- モーダルコンテンツ -->
        <div
          class="modal-content bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg w-full max-w-2xl z-10 border border-slate-200 dark:border-slate-700"
        >
          <!-- ヘッダー -->
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h3 class="text-2xl font-bold">埋め込み用HTMLスニペット</h3>
            <button
              id="close-snippet-modal"
              type="button"
              class="text-text-muted-light dark:text-text-muted-dark hover:text-text-light dark:hover:text-text-dark"
            >
              <span class="material-symbols-outlined text-3xl">close</span>
            </button>
          </div>

          <!-- 中身 -->
          <div class="p-6 space-y-4">
            <p class="text-sm text-text-muted-light dark:text-text-muted-dark">
              以下のコードをコピーして、HTMLファイルの表示したい場所に貼り付けてください。(例:
              index.html)
            </p>
            


            <label class="block text-sm font-bold mb-1">HTMLコード</label>
            <textarea
              id="snippet-code-area"
              readonly
              class="w-full h-64 p-2 font-mono text-sm bg-background-light dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md"
            ></textarea>
            <button
              id="copy-snippet-button"
              class="w-full py-2 px-4 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity"
            >
              クリップボードにコピー
            </button>
            <button
              id="open-preview-tab-btn"
              class="mt-2 w-full py-2 px-4 bg-gray-600 text-white font-bold rounded-lg hover:opacity-90 transition-opacity"
            >
              <span class="material-symbols-outlined align-middle mr-1">open_in_new</span>
              新しいタブでプレビュー
            </button>
            <p
              id="copy-message"
              class="hidden text-center text-green-600 font-bold"
            >
              コピーしました！
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ★★★ 編集モーダル用のHTMLテンプレート (非表示) ★★★ -->
    <!-- これらのテンプレートをJSがコピーしてモーダル内に挿入します -->
    <div id="edit-form-templates" class="hidden" style="display: none !important;">
      <!-- 1. お知らせ編集フォーム -->
      <div id="edit-form-template-articles" class="space-y-6">
        <div>
          <label for="edit-article-title" class="block text-sm font-medium">
            タイトル
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-article-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-article-id" />
          <input type="hidden" id="edit-article-imagePath" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-article-date" class="block text-sm font-medium">
              日付
              <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="edit-article-date"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <div>
            <label
              for="edit-article-category"
              class="block text-sm font-medium"
            >
              カテゴリー
              <span class="text-red-500">*</span>
            </label>
            <select
              id="edit-article-category"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            >
              <option value="お知らせ">お知らせ</option>
              <option value="コラム">コラム</option>
              <option value="イベント">イベント</option>
            </select>
          </div>
        </div>
        <div>
          <label for="edit-article-content" class="block text-sm font-medium">
            本文 (任意)
          </label>
          <textarea
            id="edit-article-content"
            rows="4"
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          ></textarea>
        </div>
        <div>
          <label for="edit-article-image" class="block text-sm font-medium">
            サムネイル画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-article-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <img
            id="edit-image-preview-article"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-48 h-auto rounded-lg"
          />
        </div>
      </div>

      <!-- 2. 書籍編集フォーム -->
      <div id="edit-form-template-books" class="space-y-6">
        <div>
          <label for="edit-book-title" class="block text-sm font-medium">
            書籍タイトル
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-book-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-book-id" />
          <input type="hidden" id="edit-book-imagePath" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-book-url" class="block text-sm font-medium">
              詳細リンクURL (http://...)
            </label>
            <input
              type="url"
              id="edit-book-url"
              placeholder="https://..."
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <div>
            <label for="edit-book-star-rating" class="block text-sm font-medium">
              人気度 (星評価: 1〜5)
              <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="edit-book-star-rating"
              min="1"
              max="5"
              value="5"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-book-button-text" class="block text-sm font-medium">ボタンの文字</label>
            <input type="text" id="edit-book-button-text" placeholder="詳細を見る" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
          </div>
          <div class="flex items-end pb-3">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="edit-book-open-new-tab" class="rounded border-slate-300 text-primary focus:ring-primary h-5 w-5">
              <label for="edit-book-open-new-tab" class="block text-sm font-medium">リンクを新しいタブで開く</label>
            </div>
          </div>
        </div>

        <div>
          <label for="edit-book-description" class="block text-sm font-medium">
            紹介文
            <span class="text-red-500">*</span>
          </label>
          <textarea
            id="edit-book-description"
            rows="3"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          ></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="mt-2 space-y-3 p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 h-full">
            <div class="flex items-center justify-between">
              <label for="edit-book-fixed" class="block text-sm font-medium">トップページに固定</label>
              <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" id="edit-book-fixed" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="edit-book-fixed" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
              </div>
            </div>
            <div class="flex items-center justify-between border-t border-slate-200 dark:border-slate-700 pt-3">
              <label for="edit-book-fixed-on-media" class="block text-sm font-medium">メディアページに固定</label>
              <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" id="edit-book-fixed-on-media" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="edit-book-fixed-on-media" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
              </div>
            </div>
            <div class="flex items-center justify-between border-t border-slate-200 dark:border-slate-700 pt-3">
              <label for="edit-book-show-in-snippet" class="block text-sm font-medium">書籍全体のスニペットに表示</label>
              <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" id="edit-book-show-in-snippet" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="edit-book-show-in-snippet" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"></label>
              </div>
            </div>
          </div>
          <div>
            <label for="edit-book-order" class="block text-sm font-medium">
              固定表示順 (数値: 1, 2, ... 0=日付順)
              <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="edit-book-order"
              value="10"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label for="edit-book-image" class="block text-sm font-medium">
            書籍画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-book-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <div class="mt-2 p-3 bg-slate-50 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700 text-xs text-text-muted-light dark:text-text-muted-dark">
            <p class="font-bold mb-1">推奨画像スペック:</p>
            <ul class="list-disc list-inside space-y-0.5 ml-1">
              <li>縦横比: 3 : 4 (縦長)</li>
              <li>サイズ: 横 600px × 縦 800px</li>
              <li>形式: .jpg (推奨)</li>
              <li>容量: 200KB以下 (推奨100KB)</li>
            </ul>
          </div>
          <img
            id="edit-image-preview-book"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-48 h-auto rounded-lg"
          />
        </div>
      </div>

      <!-- 3. メディア(アイコン)編集フォーム -->
      <div id="edit-form-template-mediaIcons" class="space-y-6">
        <div>
          <label for="edit-media-icon-title" class="block text-sm font-medium">
            リンクタイトル
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-media-icon-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-media-icon-id" />
          <input type="hidden" id="edit-media-icon-imagePath" />
        </div>
        <div>
          <label
            for="edit-media-icon-description"
            class="block text-sm font-medium"
          >
            解説内容
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-media-icon-description"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-media-icon-url" class="block text-sm font-medium">
            リンク先URL (http://...)
          </label>
          <input
            type="url"
            id="edit-media-icon-url"
            placeholder="https://..."
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-media-icon-order" class="block text-sm font-medium">
            表示順 (数値)
            <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="edit-media-icon-order"
            value="10"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-media-icon-name" class="block text-sm font-medium">
            方法1: リストからアイコン選択
          </label>
          <select
            id="edit-media-icon-name"
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          >
            <option value="article">note (記事)</option>
            <option value="play_circle">YouTube (動画)</option>
            <option value="graphic_eq">standFM (音声)</option>
            <option value="photo_camera">Instagram (写真)</option>
            <option value="music_note">TikTok (音楽/動画)</option>
            <option value="forum">Threads (会話)</option>
            <option value="public">Facebook (ソーシャル)</option>
            <option value="podcasts">Podcast (ポッドキャスト)</option>
            <option value="link">その他 (汎用リンク)</option>
          </select>
        </div>
        <div>
          <label for="edit-media-icon-image" class="block text-sm font-medium">
            方法2: カスタム画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-media-icon-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <p class="text-xs text-text-muted-light mt-1">
            推奨: 64x64px。画像を変更するとリスト選択は無視されます。
          </p>
          <img
            id="edit-image-preview-media-icon"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-16 h-16 rounded-lg"
          />
        </div>
      </div>

      <!-- 4. メディア(バナー)編集フォーム -->
      <div id="edit-form-template-mediaBanners" class="space-y-6">
        <div>
          <label for="edit-media-banner-url" class="block text-sm font-medium">
            リンク先URL (http://...)
          </label>
          <input
            type="url"
            id="edit-media-banner-url"
            placeholder="https://..."
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-media-banner-id" />
          <input type="hidden" id="edit-media-banner-imagePath" />
        </div>
        <div>
          <label
            for="edit-media-banner-order"
            class="block text-sm font-medium"
          >
            表示順 (数値)
            <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="edit-media-banner-order"
            value="10"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label
            for="edit-media-banner-animation"
            class="block text-sm font-medium"
          >
            アニメーション選択
          </label>
          <select
            id="edit-media-banner-animation"
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          >
            <option value="none">なし</option>
            <option value="pulse">ゆっくり光る</option>
            <option value="wiggle">小さく揺れる</option>
            <option value="squish">ぺこぺこへこむ</option>
            <option value="flash">キラッと光る</option>
            <option value="heartbeat">ドキドキ鼓動する</option>
          </select>
        </div>
        <div>
          <label
            for="edit-media-banner-image"
            class="block text-sm font-medium"
          >
            バナー画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-media-banner-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <p class="text-xs text-text-muted-light mt-1">
            推奨: 600x400px (3:2比率)
          </p>
          <img
            id="edit-image-preview-media-banner"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-48 h-auto rounded-lg"
          />
        </div>
      </div>

      <!-- 5. ブログ・HP編集フォーム -->
      <div id="edit-form-template-sites" class="space-y-6">
        <div>
          <label for="edit-site-title" class="block text-sm font-medium">
            タイトル
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-site-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-site-id" />
          <input type="hidden" id="edit-site-imagePath" />
        </div>
        <div>
          <label for="edit-site-description" class="block text-sm font-medium">
            解説内容
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-site-description"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-site-url" class="block text-sm font-medium">
            リンク先URL (http://...)
            <span class="text-red-500">*</span>
          </label>
          <input
            type="url"
            id="edit-site-url"
            placeholder="https://..."
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-site-order" class="block text-sm font-medium">
            表示順 (数値)
            <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="edit-site-order"
            value="10"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-site-icon-name" class="block text-sm font-medium">
            方法1: リストからアイコン選択
          </label>
          <select
            id="edit-site-icon-name"
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          >
            <option value="insights">マネタイズ (insights)</option>
            <option value="psychology">心理 (psychology)</option>
            <option value="school">スクール (school)</option>
            <option value="storefront">ストア (storefront)</option>
            <option value="groups">コミュニティ (groups)</option>
            <option value="link">その他 (link)</option>
          </select>
        </div>
        <div>
          <label for="edit-site-icon-image" class="block text-sm font-medium">
            方法2: カスタム画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-site-icon-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <p class="text-xs text-text-muted-light mt-1">
            推奨: 64x64px。画像を変更するとリスト選択は無視されます。
          </p>
          <img
            id="edit-image-preview-site"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-16 h-16 rounded-lg"
          />
        </div>
      </div>
      <!-- 6. ナビゲーション編集フォーム -->
      <div id="edit-form-template-navigation" class="space-y-6">
        <div>
          <label for="edit-nav-title" class="block text-sm font-medium">
            メニュー名
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-nav-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <input type="hidden" id="edit-nav-id" />
        </div>
        <div>
          <label for="edit-nav-url" class="block text-sm font-medium">
            リンク先URL
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-nav-url"
            placeholder="index.html"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-nav-order" class="block text-sm font-medium">
            表示順 (数値)
            <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="edit-nav-order"
            value="10"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
      </div>
      <!-- 7. ブログ記事編集フォーム (P2) -->
      <div id="edit-form-template-blog-posts" class="space-y-6">
        <input type="hidden" id="edit-blog-post-id" />
        <input type="hidden" id="edit-blog-post-imagePath" />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-blog-post-title" class="block text-sm font-medium">
              タイトル
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="edit-blog-post-title"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
          <div>
            <label for="edit-blog-post-url" class="block text-sm font-medium">
              リンク先URL
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="edit-blog-post-url"
              placeholder="blog/post1.html"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label
            for="edit-blog-post-description"
            class="block text-sm font-medium"
          >
            解説文
            <span class="text-red-500">*</span>
          </label>
          <textarea
            id="edit-blog-post-description"
            rows="3"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          ></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="edit-blog-post-category-select"
              class="block text-sm font-medium"
            >
              ブログカテゴリー
              <span class="text-red-500">*</span>
            </label>
            <select
              id="edit-blog-post-category-select"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            >
              <option value="" disabled selected>
                カテゴリーを読み込み中...
              </option>
              </select>
          </div>
          <div>
            <label for="edit-blog-post-order" class="block text-sm font-medium">
              表示順 (数値)
              <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="edit-blog-post-order"
              value="10"
              required
              class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">リンクオプション</label>
          <div
            class="mt-2 flex items-center justify-between p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600"
          >
            <label
              for="edit-blog-post-open-new-tab"
              class="block text-sm font-medium"
            >
              記事を新しいタブで開く
            </label>
            <div
              class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
            >
              <input
                type="checkbox"
                id="edit-blog-post-open-new-tab"
                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
              />
              <label
                for="edit-blog-post-open-new-tab"
                class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-700 cursor-pointer"
              ></label>
            </div>
          </div>
          <p class="text-xs text-text-muted-light mt-1">
            ※チェックを外すと、同じウィンドウで開きます。
          </p>
        </div>

        <div>
          <label for="edit-blog-post-image" class="block text-sm font-medium">
            アイキャッチ画像 (変更する場合)
          </label>
          <input
            type="file"
            id="edit-blog-post-image"
            accept="image/*"
            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30"
          />
          <img
            id="edit-image-preview-blog-post"
            src=""
            alt="画像プレビュー"
            class="mt-4 w-48 h-auto rounded-lg"
          />
        </div>
      </div>

      <div id="edit-form-template-sitemapEntries" class="space-y-6">
        <input type="hidden" id="edit-sitemap-id" />
        <div>
          <label for="edit-sitemap-title" class="block text-sm font-medium">
            タイトル
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="edit-sitemap-title"
            required
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
        </div>
        <div>
          <label for="edit-sitemap-path" class="block text-sm font-medium">
            URLパス
            <span class="text-red-500">*</span>
            (例: index.html)
          </label>
          <input
            type="text"
            id="edit-sitemap-path"
            required
            placeholder="index.html"
            class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
          />
          <p class="text-xs text-text-muted-light mt-1">
            ※注意:
            このパスがDBのIDになります。変更すると古い項目が残ったまま、新しい項目として登録されます。
          </p>
        </div>
      </div>
      <!-- 8. パーソナル情報編集フォーム -->
      <div id="edit-form-template-personalInfo" class="space-y-6">
        <input type="hidden" id="edit-personal-id" />
        <div>
          <label for="edit-personal-title" class="block text-sm font-medium">タイトル<span class="text-red-500">*</span></label>
          <input type="text" id="edit-personal-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div>
          <label for="edit-personal-description" class="block text-sm font-medium">内容・詳細<span class="text-red-500">*</span></label>
          <textarea id="edit-personal-description" rows="3" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"></textarea>
        </div>
        <div>
          <label for="edit-personal-order" class="block text-sm font-medium">表示順 (数値)<span class="text-red-500">*</span></label>
          <input type="number" id="edit-personal-order" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
      </div>
      <div id="edit-form-template-contactInfo" class="space-y-6">
        <input type="hidden" id="edit-contact-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-contact-title" class="block text-sm font-medium">項目名<span class="text-red-500">*</span></label>
            <input type="text" id="edit-contact-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
          </div>
          <div>
            <label for="edit-contact-icon" class="block text-sm font-medium">アイコン</label>
            <input type="text" id="edit-contact-icon" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
          </div>
          <div>
            <label for="edit-contact-image" class="block text-sm font-medium">カスタム画像アイコン (変更する場合)</label>
            <input type="file" id="edit-contact-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
            <p class="text-xs text-text-muted-light mt-1">※画像をアップロードすると、Material Symbolsの代わりに表示されます。</p>
            <img id="edit-image-preview-contact" src="" alt="画像プレビュー" class="hidden mt-4 w-16 h-16 rounded-lg" />
          </div>
        </div>
        <div>
          <label for="edit-contact-description" class="block text-sm font-medium">内容<span class="text-red-500">*</span></label>
          <textarea id="edit-contact-description" rows="2" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"></textarea>
        </div>
        <div>
          <label for="edit-contact-order" class="block text-sm font-medium">表示順 (数値)<span class="text-red-500">*</span></label>
          <input type="number" id="edit-contact-order" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-contact-width" class="block text-sm font-medium">横幅の指定<span class="text-red-500">*</span></label>
            <select id="edit-contact-width" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
              <option value="w-full">フルサイズ (100%)</option>
              <option value="w-1/2">半分 (50%)</option>
              <option value="w-1/3">3分の1 (33%)</option>
              <option value="w-1/4">4分の1 (25%)</option>
            </select>
          </div>
          <div>
            <label for="edit-contact-align" class="block text-sm font-medium">水平配置の指定<span class="text-red-500">*</span></label>
            <select id="edit-contact-align" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
              <option value="justify-start">左寄せ</option>
              <option value="justify-center">中央寄せ</option>
              <option value="justify-end">右寄せ</option>
            </select>
          </div>
        </div>
      </div>
      <div id="edit-form-template-blogContents" class="space-y-6">
        <input type="hidden" id="edit-dynamic-id" />
        <input type="hidden" id="edit-dynamic-imagePath" />
        <div>
          <label for="edit-dynamic-title" class="block text-sm font-medium">記事タイトル<span class="text-red-500">*</span></label>
          <input type="text" id="edit-dynamic-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        
        <div>
          <label class="block text-sm font-medium">記事本文 (カスタムHTMLブロック)<span class="text-red-500">*</span></label>
          <div id="edit-html-blocks-container" class="space-y-4 mt-2">
            </div>
          <button type="button" id="edit-add-html-block-btn" class="mt-4 py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center gap-1">
            <span class="material-symbols-outlined !text-base">add</span>
            <span>HTMLブロックを追加</span>
          </button>
        </div>
  
        <div>
          <label for="edit-dynamic-image" class="block text-sm font-medium">アイキャッチ画像 (変更する場合)</label>
          <input type="file" id="edit-dynamic-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
          <img id="edit-image-preview-dynamic" src="" alt="画像プレビュー" class="mt-4 w-48 h-auto rounded-lg hidden" />
        </div>
        <div class="mt-6 border-t border-slate-200 dark:border-slate-700 pt-4">
          <button type="button" id="edit-preview-dynamic-blog-btn" class="w-full py-2 px-4 bg-gray-600 text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
            <span class="material-symbols-outlined">open_in_new</span>
            <span>変更内容をプレビュー</span>
          </button>
        </div>
      </div>
      <div id="edit-form-template-bottomNavigation" class="space-y-6">
        <input type="hidden" id="edit-bottom-nav-id" />
        <input type="hidden" id="edit-bottom-nav-imagePath" />
        <div>
          <label for="edit-bottom-nav-title" class="block text-sm font-medium">メニュー名<span class="text-red-500">*</span></label>
          <input type="text" id="edit-bottom-nav-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div>
          <label for="edit-bottom-nav-url" class="block text-sm font-medium">リンク先URL<span class="text-red-500">*</span></label>
          <input type="text" id="edit-bottom-nav-url" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div>
          <label for="edit-bottom-nav-icon" class="block text-sm font-medium">アイコン名 (Material Icons)<span class="text-red-500">*</span></label>
          <input type="text" id="edit-bottom-nav-icon" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div>
          <label for="edit-bottom-nav-image" class="block text-sm font-medium">カスタム画像アイコン (変更する場合)</label>
          <input type="file" id="edit-bottom-nav-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
          <img id="edit-image-preview-bottom-nav" src="" alt="画像プレビュー" class="mt-4 w-16 h-16 object-contain hidden" />
        </div>
        <div>
          <label for="edit-bottom-nav-order" class="block text-sm font-medium">表示順 (数値)<span class="text-red-500">*</span></label>
          <input type="number" id="edit-bottom-nav-order" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
      </div>
      <div id="edit-form-template-skills" class="space-y-6">
        <input type="hidden" id="edit-skill-id" />
        <input type="hidden" id="edit-skill-imagePath" />
        <div>
          <label for="edit-skill-title" class="block text-sm font-medium">タイトル<span class="text-red-500">*</span></label>
          <input type="text" id="edit-skill-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div>
          <label for="edit-skill-subtitle" class="block text-sm font-medium">サブタイトル<span class="text-red-500">*</span></label>
          <input type="text" id="edit-skill-subtitle" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="edit-skill-icon" class="block text-sm font-medium">アイコン (Material Symbols)</label>
            <input type="text" id="edit-skill-icon" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
          </div>
          <div>
            <label for="edit-skill-order" class="block text-sm font-medium">表示順 (数値)<span class="text-red-500">*</span></label>
            <input type="number" id="edit-skill-order" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary" />
          </div>
        </div>
        <div>
          <label for="edit-skill-image" class="block text-sm font-medium">カスタム画像アイコン (変更する場合)</label>
          <input type="file" id="edit-skill-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 dark:file:bg-primary/20 dark:file:text-primary dark:hover:file:bg-primary/30" />
          <img id="edit-image-preview-skill" src="" alt="画像プレビュー" class="mt-4 w-16 h-16 object-contain hidden" />
        </div>
      </div>


      <!-- 8. 登録リンク編集フォーム -->
      <div id="edit-form-template-savedLinks" class="space-y-6">
        <input type="hidden" id="edit-saved-link-id" />
        <div>
          <label for="edit-saved-link-title" class="block text-sm font-medium">タイトル <span class="text-red-500">*</span></label>
          <input type="text" id="edit-saved-link-title" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
        </div>
        <div>
          <label for="edit-saved-link-url" class="block text-sm font-medium">URL <span class="text-red-500">*</span></label>
          <input type="url" id="edit-saved-link-url" required class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
        </div>
        <div>
          <label for="edit-saved-link-memo" class="block text-sm font-medium">メモ / 検索用キーワード</label>
          <input type="text" id="edit-saved-link-memo" class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary">
        </div>
      </div>
    </div>

    <!-- カスタムHTML部品 新規作成/編集モーダル -->
    <div id="cp-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen p-4">
        <!-- オーバーレイ -->
        <div
          class="modal-overlay fixed inset-0 bg-black opacity-50"
          onclick="document.getElementById('custom-part-modal').classList.add('hidden')"
        ></div>
        <!-- モーダルコンテンツ -->
        <div
          class="modal-content relative bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-200 dark:border-slate-700"
        >
          <!-- ヘッダー -->
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h3 id="cp-modal-title" class="text-2xl font-bold">
              カスタムHTML部品を作成
            </h3>
            <button
              onclick="document.getElementById('cp-modal').classList.add('hidden')"
              class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors"
            >
              <span class="material-symbols-outlined text-3xl">close</span>
            </button>
          </div>
          <!-- ボディ -->
          <div class="modal-body p-6 overflow-y-auto" style="max-height: calc(90vh - 180px)">
            <form id="cp-form" class="space-y-6">
              <input type="hidden" id="cp-input-id" />
              
              <!-- タイトル -->
              <div>
                <label for="cp-input-title" class="block text-sm font-medium">
                  部品名
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="cp-input-title"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  placeholder="例: ヘッダーバナー"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- カテゴリ -->
                <div>
                  <label for="cp-input-category" class="block text-sm font-medium">
                    カテゴリ
                    <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="cp-input-category"
                    required
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  >
                    <option value="バナー">バナー</option>
                    <option value="ボタン">ボタン</option>
                    <option value="告知">告知</option>
                    <option value="その他">その他</option>
                  </select>
                </div>

                <!-- アイコン -->
                <div>
                  <label for="cp-input-icon" class="block text-sm font-medium">
                    アイコン (Material Symbols)
                  </label>
                  <input
                    type="text"
                    id="cp-input-icon"
                    class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                    placeholder="例: campaign"
                  />
                  <p class="text-xs text-text-muted-light mt-1">
                    <a href="https://fonts.google.com/icons" target="_blank" class="text-primary hover:underline">
                      アイコン一覧を見る
                    </a>
                  </p>
                </div>
              </div>

              <!-- メモ -->
              <div>
                <label for="cp-input-memo" class="block text-sm font-medium">
                  メモ (使用場所など)
                </label>
                <textarea
                  id="cp-input-memo"
                  rows="2"
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary"
                  placeholder="例: トップページのヘッダー下に配置"
                ></textarea>
              </div>

              <!-- HTMLエディタ -->
              <div>
                <label for="cp-input-html" class="block text-sm font-medium mb-2">
                  HTMLコード
                  <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="cp-input-html"
                  rows="10"
                  required
                  class="mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary font-mono text-sm"
                  placeholder="<div>ここにHTMLコードを入力...</div>"
                ></textarea>
              </div>

              <!-- プレビューボタン (別タブ) -->
              <div>
                 <button
                  type="button"
                  id="preview-custom-part-btn"
                  class="w-full py-2 px-4 bg-gray-600 text-white font-bold rounded-lg hover:opacity-90 transition-opacity mt-4 flex items-center justify-center gap-2"
                >
                  <span class="material-symbols-outlined">open_in_new</span>
                  <span>新しいタブでプレビュー</span>
                </button>
              </div>
            </form>
          </div>
          <!-- フッター -->
          <div
            class="flex items-center justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700"
          >
            <button
              type="button"
              onclick="document.getElementById('cp-modal').classList.add('hidden')"
              class="py-2 px-6 bg-slate-600 text-white font-bold rounded-lg hover:bg-slate-700 transition-colors"
            >
              キャンセル
            </button>
            <button
              type="submit"
              form="cp-form"
              id="save-custom-part-btn"
              class="py-2 px-6 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"
            >
              <span class="material-symbols-outlined">save</span>
              <span>保存</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  
    <script type="module">
      // Import functions from the SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        GoogleAuthProvider,
        signInWithPopup,
        EmailAuthProvider,
        signInWithEmailAndPassword,
        RecaptchaVerifier,
        PhoneAuthProvider,
        signInWithCredential,
        PhoneMultiFactorGenerator,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        deleteDoc,
        doc,
        query,
        orderBy,
        serverTimestamp,
        updateDoc,
        getDoc,
        setDoc,
        where,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        // ★★★ 【修正】Storage SDK のインポートを完全に追加 ★★★
        getStorage,
        ref,
        uploadBytesResumable,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// ★★★ common.js をインポート ★★★
      import * as common from './js/common.js';
      import { generateSingleBookSnippet } from './js/common.js';

      /**
       * 指定された入力欄とリストコンテナを紐付け、リアルタイム検索を行う関数
       * @param {string} inputId - 検索ボックスのID
       * @param {string} listId - 検索対象のリストコンテナのID
       */
      function setupListFilter(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        if (!input || !list) {
            // どちらか一方でも存在しない場合は、イベントリスナーを登録せず終了
            return;
        }

        input.addEventListener('input', () => {
          const filter = input.value.toLowerCase();
          const items = list.children; // リスト内の全アイテム

          Array.from(items).forEach(item => {
            // アイテム内の全テキストを取得して検索
            const text = item.textContent.toLowerCase();
            if (text.includes(filter)) {
              item.classList.remove('hidden');
            } else {
              item.classList.add('hidden');
            }
          });
        });
      }

      // ★★★ すべてのコードを DOMContentLoaded で囲む ★★★
      document.addEventListener("DOMContentLoaded", () => {


        // Initialize Firebase
        // ★ common.js で初期化されたグローバルオブジェクトを参照する
        const auth = window.auth;
        const db = window.db;
        const storage = getStorage(window.app); // common.jsのappを参照してstorageを初期化

        // --- DOM Elements (共通) ---
        const loginSection = document.getElementById("login-section");
        const mfaSection = document.getElementById("mfa-section");
        const dashboardSection = document.getElementById("dashboard-section");
        const googleLoginBtn = document.getElementById("google-login-btn");
        const emailLoginForm = document.getElementById("email-login-form");
        const logoutBtn = document.getElementById("logout-btn");
        const userEmailEl = document.getElementById("user-email");
        const messageContainer = document.getElementById("message-container");
        const tabsContainer = document.getElementById("tabs-container");
        // サブタブ切り替え (Page Common Management) - 初期化ロジックは setupCommonManagementSubTabs 関数に移動


      // --- 既存のタブ切り替えロジック ---
      const tabBtns = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        // --- DOM Elements (MFA) ---
        const phoneForm = document.getElementById("phone-form");
        const codeForm = document.getElementById("code-form");
        const mfaInfoText = document.getElementById("mfa-info-text");
        const phoneNumberInput = document.getElementById("phone-number");
        const codeInput = document.getElementById("code");

        // --- DOM Elements (お知らせ) ---
        const addArticleForm = document.getElementById("add-article-form");
        const articlesListContainer = document.getElementById(
          "articles-list-container"
        );
        const articlesLoader = document.getElementById("articles-loader");
        const imageInputArticle = document.getElementById("article-image");
        const imagePreviewArticle = document.getElementById(
          "image-preview-article"
        );
        const uploadProgressContainerArticle = document.getElementById(
          "upload-progress-container-article"
        );
        const uploadProgressBarArticle = document.getElementById(
          "upload-progress-bar-article"
        );
        const submitArticleBtn = document.getElementById("submit-article-btn");

        // --- DOM Elements (書籍) ---
        const addBookForm = document.getElementById("add-book-form");
        const booksListContainer = document.getElementById(
          "books-list-container"
        );
        const booksLoader = document.getElementById("books-loader");
        const imageInputBook = document.getElementById("book-image");
        const imagePreviewBook = document.getElementById("image-preview-book");
        const uploadProgressContainerBook = document.getElementById(
          "upload-progress-container-book"
        );
        const uploadProgressBarBook = document.getElementById(
          "upload-progress-bar-book"
        );
        const submitBookBtn = document.getElementById("submit-book-btn");

        // --- DOM Elements (メディア(アイコン)) ---
        const addMediaIconForm = document.getElementById("add-media-icon-form");
        const mediaIconsListContainer = document.getElementById(
          "media-icons-list-container"
        );
        const mediaIconsLoader = document.getElementById("media-icons-loader");
        const imageInputMediaIcon = document.getElementById("media-icon-image");
        const imagePreviewMediaIcon = document.getElementById(
          "image-preview-media-icon"
        );
        const uploadProgressContainerMediaIcon = document.getElementById(
          "upload-progress-container-media-icon"
        );
        const uploadProgressBarMediaIcon = document.getElementById(
          "upload-progress-bar-media-icon"
        );
        const submitMediaIconBtn = document.getElementById(
          "submit-media-icon-btn"
        );

        // --- DOM Elements (メディア(バナー)) ---
        const addMediaBannerForm = document.getElementById(
          "add-media-banner-form"
        );
        const mediaBannersListContainer = document.getElementById(
          "media-banners-list-container"
        );
        const mediaBannersLoader = document.getElementById(
          "media-banners-loader"
        );
        const imageInputMediaBanner =
          document.getElementById("media-banner-image");
        const imagePreviewMediaBanner = document.getElementById(
          "image-preview-media-banner"
        );
        const uploadProgressContainerMediaBanner = document.getElementById(
          "upload-progress-container-media-banner"
        );
        const uploadProgressBarMediaBanner = document.getElementById(
          "upload-progress-bar-media-banner"
        );
        const submitMediaBannerBtn = document.getElementById(
          "submit-media-banner-btn"
        );

        // --- DOM Elements (ブログ・HP) (NEW) ---
        const addSiteForm = document.getElementById("add-site-form");
        const sitesListContainer = document.getElementById(
          "sites-list-container"
        );
        const sitesLoader = document.getElementById("sites-loader");
        const imageInputSite = document.getElementById("site-icon-image");
        const imagePreviewSite = document.getElementById("image-preview-site");
        const uploadProgressContainerSite = document.getElementById(
          "upload-progress-container-site"
        );
        const uploadProgressBarSite = document.getElementById(
          "upload-progress-bar-site"
        );
        const submitSiteBtn = document.getElementById("submit-site-btn");
        const addNavigationForm = document.getElementById(
          "add-navigation-form"
        );
        const navigationListContainer = document.getElementById(
          "navigation-list-container"
        );
        const navigationLoader = document.getElementById("navigation-loader");
        const submitNavigationBtn = document.getElementById(
          "submit-navigation-btn"
        );
        // --- ★ DOM Elements (固定ページ・共通) (NEW) ★ ---
        const updateHeaderCtaForm = document.getElementById(
          "update-header-cta-form"
        );
        const headerCtaLoader = document.getElementById("header-cta-loader");
        const submitHeaderCtaBtn = document.getElementById(
          "submit-header-cta-btn"
        );
        // ★ P-New: ブログカテゴリー
        const addBlogCategoryForm = document.getElementById(
          "add-blog-category-form"
        );
        const blogCategoriesListContainer = document.getElementById(
          "blog-categories-list-container"
        );
        const blogCategoriesLoader = document.getElementById(
          "blog-categories-loader"
        );
        const submitBlogCategoryBtn = document.getElementById(
          "submit-blog-category-btn"
        );
        // --- ★ DOM Elements (ブログ記事) (NEW) ★ ---
        const addBlogPostForm = document.getElementById("add-blog-post-form");
        const blogPostsListContainer = document.getElementById(
          "blog-posts-list-container"
        );
        const blogPostsLoader = document.getElementById("blog-posts-loader");
        const imageInputBlogPost = document.getElementById("blog-post-image");
        const imagePreviewBlogPost = document.getElementById(
          "image-preview-blog-post"
        );
        const uploadProgressContainerBlogPost = document.getElementById(
          "upload-progress-container-blog-post"
        );
        const uploadProgressBarBlogPost = document.getElementById(
          "upload-progress-bar-blog-post"
        );
        const submitBlogPostBtn = document.getElementById(
          "submit-blog-post-btn"
        );
        // 動的ブログ作成フォームの要素取得
        const addDynamicBlogForm = document.getElementById(
          "add-dynamic-blog-form"
        );
        const dynamicPostTitle = document.getElementById("dynamic-post-title");
        const dynamicPostImage = document.getElementById(
          "dynamic-post-image"
        );
        const uploadProgressBarDynamicPost = document.getElementById("upload-progress-bar-dynamic-post");
        const uploadProgressContainerDynamicPost = document.getElementById(
          "upload-progress-container-dynamic-post"
        );
        const imagePreviewDynamicPost = document.getElementById("image-preview-dynamic-post");
        let dynamicFileImage = null; // グローバルでファイルを保持する変数
        // --- ★ DOM Elements (修正モーダル) (NEW) ★ ---
        const editModal = document.getElementById("edit-modal");
        const modalOverlay = document.getElementById("modal-overlay");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const cancelModalBtn = document.getElementById("cancel-modal-btn");
        const editModalTitle = document.getElementById("edit-modal-title");
        const editFormContent = document.getElementById("edit-form-content");
        const editForm = document.getElementById("edit-form");
        const updateSubmitBtn = document.getElementById("update-submit-btn");

        // --- ★ DOM Elements (書籍スニペットモーダル) (NEW) ★ ---
        const snippetModal = document.getElementById("snippet-modal");
        const openSnippetModalBtn = document.getElementById(
          "open-snippet-modal-btn"
        );
        const closeSnippetModalBtn = document.getElementById(
          "close-snippet-modal"
        );
        const copySnippetButton = document.getElementById(
          "copy-snippet-button"
        );
        const snippetCodeArea = document.getElementById("snippet-code-area");
        const copyMessage = document.getElementById("copy-message");

        // --- ★ DOM Elements (編集フォームテンプレート) (NEW) ★ ---
        const templateArticle = document.getElementById(
          "edit-form-template-articles"
        );
        const templateBook = document.getElementById(
          "edit-form-template-books"
        );
        const templateMediaIcon = document.getElementById(
          "edit-form-template-mediaIcons"
        );
        const templateMediaBanner = document.getElementById(
          "edit-form-template-mediaBanners"
        );
        const templateSite = document.getElementById(
          "edit-form-template-sites"
        );
        const templateNavigation = document.getElementById(
          "edit-form-template-navigation"
        );
        // ★ P2: ブログ記事
        const templateBlogPost = document.getElementById(
          "edit-form-template-blog-posts"
        );
        // --- ★ DOM Elements (パーソナル情報) (NEW) ★ ---
        const addPersonalForm = document.getElementById("add-personal-form");
        const personalListContainer = document.getElementById(
          "personal-list-container"
        );
        const personalLoader = document.getElementById("personal-loader");
        const submitPersonalBtn = document.getElementById("submit-personal-btn");
        const templatePersonalInfo = document.getElementById(
          "edit-form-template-personalInfo"
        );
        const templateBottomNavigation = document.getElementById(
          "edit-form-template-bottomNavigation"
        );
        // ★ NEW: 登録リンク
        const templateSavedLink = document.getElementById(
          "edit-form-template-savedLinks"
        );
        // --- ★ DOM Elements (お問い合わせ情報) (NEW) ★ ---
        const addContactInfoForm = document.getElementById("add-contact-info-form");
        const contactListContainer = document.getElementById(
          "contact-list-container"
        );
        const contactLoader = document.getElementById("contact-loader");
        const submitContactBtn = document.getElementById("submit-contact-btn");
        const templateContactInfo = document.getElementById(
          "edit-form-template-contactInfo"
        );
        // --- ★ DOM Elements (スキル) (NEW) ★ ---
        const addSkillsForm = document.getElementById("add-skills-form");
        const skillsListContainer = document.getElementById("skills-list-container");
        const skillsLoader = document.getElementById("skills-loader");
        const submitSkillsBtn = document.getElementById("submit-skills-btn");
        const imageInputSkill = document.getElementById("skill-image");
        const imagePreviewSkill = document.getElementById("image-preview-skill");
        const uploadProgressContainerSkill = document.getElementById("upload-progress-container-skill");
        const uploadProgressBarSkill = document.getElementById("upload-progress-bar-skill");
        // --- ★ DOM Elements (お問い合わせ) (NEW) ★ ---
        const imageInputContact = document.getElementById("contact-image");
        const imagePreviewContact = document.getElementById("image-preview-contact");
        const uploadProgressContainerContact = document.getElementById("upload-progress-container-contact");
        const uploadProgressBarContact = document.getElementById("upload-progress-bar-contact");
        // --- グローバル変数 ---
        let currentVerificationId = null;
        let mfaResolver = null;
        // 追加用ファイル
        let selectedFileArticle = null;
        let selectedFileBook = null;
        let selectedFileMediaIcon = null;
        let selectedFileMediaBanner = null;
        let selectedFileSite = null;
        let selectedFileSkill = null;
        let selectedFileContact = null;
        let selectedFileBottomNav = null;
        // ★ P2: ブログ記事
        let selectedFileBlogPost = null;

        // ★ 修正用ファイル (NEW)
        let editFileArticle = null;
        let editFileBook = null;
        let editFileMediaIcon = null;
        let editFileMediaBanner = null;
        let editFileSite = null;
        let editFileSkill = null;
        let editFileContact = null;
        let editFileBottomNav = null;
        // ★ P2: ブログ記事
        let editFileBlogPost = null;
        let editFileDynamic = null; // 動的ブログ用
        // ★ 修正モーダルの状態 (NEW)
        let currentEditCollection = null;
        let currentEditDocId = null;
        let currentEditOldImagePath = null;

        // --- ★ DOM Elements (Phase 3-3 サイトマップ) ★ ---
        const sitemapLoader = document.getElementById("sitemap-loader");
        const scanSitemapBtn = document.getElementById("scan-sitemap-btn");
        const sitemapListContainer = document.getElementById(
          "sitemap-list-container"
        );
        const sitemapPrompt = document.getElementById("sitemap-prompt");
        // --- ★ Phase 6-2: ボトムナビ管理 ★ ---
        const addBottomNavForm = document.getElementById("add-bottom-nav-form");
        const bottomNavListContainer = document.getElementById(
          "bottom-nav-list-container"
        );
        const bottomNavLoader = document.getElementById("bottom-nav-loader");
        const submitBottomNavBtn = document.getElementById(
          "submit-bottom-nav-btn"
        );
        // --- ★ Phase 3-3: サイトマップスキャン用 静的ページリスト ★ ---
        // サイトのドメイン（共通URL）
        const SITE_DOMAIN = "https://www.example.com"; // ★★★ 奥村様、ここは後で実際のドメインに変更してください ★★★
        // サイトマップに登録すべき主要ページ（静的HTML）
        const STATIC_PAGES = [
          { title: "トップページ", url: "index.html" },
          { title: "わたしの歩み", url: "media.html" },
          { title: "お知らせ", url: "info.html" },
          { title: "プロフィール", url: "profile.html" },
          { title: "ビジョン", url: "vision.html" },
          { title: "サービス", url: "service.html" },
          { title: "お問い合わせ", url: "contact.html" },
          { title: "無料講座", url: "free-course.html" },
          // blog.html は "ブログ記事 (blogPosts)" で管理するため、ここでは不要
        ];


        // サイトマップダウンロード機能
        const downloadSitemapBtn = document.getElementById('download-sitemap-btn');

        // --- ユーティリティ関数 ---
        function showMessage(text, type = "success") {
          const isSuccess = type === "success";
          const bgColor = isSuccess ? "bg-green-500" : "bg-red-500";
          const messageEl = document.createElement("div");
          messageEl.className = `p-4 mb-4 text-white ${bgColor} rounded-lg shadow-md transition-all duration-300 transform translate-x-full opacity-0`;
          messageEl.textContent = text;
          if (messageContainer) {
            messageContainer.appendChild(messageEl);
            setTimeout(() => {
              messageEl.classList.remove("translate-x-full", "opacity-0");
              messageEl.classList.add("translate-x-0", "opacity-100");
            }, 10);
            setTimeout(() => {
              messageEl.classList.add("translate-x-full", "opacity-0");
              setTimeout(() => messageEl.remove(), 300);
            }, 4000);
          }
        }

        if (downloadSitemapBtn) {
          downloadSitemapBtn.addEventListener('click', async () => {
            try {
              // 1. Firestoreからデータを取得
              const q = query(collection(db, "sitemapEntries"));
              const querySnapshot = await getDocs(q);
              
              if (querySnapshot.empty) {
                showMessage("サイトマップに登録されたデータがありません。先にスキャンを行ってください。", "error");
                return;
              }

              // 2. XML文字列の生成
              let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
              xmlContent += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';

              querySnapshot.forEach((doc) => {
                const data = doc.data();
                // パスが http で始まっていればそのまま、そうでなければドメインと結合
                const loc = data.path.startsWith('http') ? data.path : `${SITE_DOMAIN}/${data.path.replace(/^\//, '')}`; // 先頭のスラッシュを削除して結合
                
                // 日付の整形 (YYYY-MM-DD)
                let lastmod = new Date().toISOString().split('T')[0];
                if (data.lastModified?.toDate) {
                   lastmod = data.lastModified.toDate().toISOString().split('T')[0];
                }

                xmlContent += '  <url>\n';
                xmlContent += `    <loc>${loc}</loc>\n`;
                xmlContent += `    <lastmod>${lastmod}</lastmod>\n`;
                xmlContent += '  </url>\n';
              });

              xmlContent += '</urlset>';

              // 3. ファイルダウンロードのトリガー
              const blob = new Blob([xmlContent], { type: 'application/xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'sitemap.xml';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              showMessage("sitemap.xml をダウンロードしました。");

            } catch (error) {
              console.error("Error generating sitemap: ", error);
              showMessage(`サイトマップ生成エラー: ${error.message}`, "error");
            }
          });
        }
        // --- ★ 【追加】書籍スニペットモーダル制御ロジック ★ ---
        if (openSnippetModalBtn && snippetModal) {
          // 1. モーダルを開く
          openSnippetModalBtn.addEventListener("click", async () => {
            // 既存の書籍リストを取得する処理を再利用し、トップ固定の書籍のみを取得
            try {
              const booksCol = collection(db, "books");
              // ★ "fixed" が true の書籍のみを取得するクエリ
              const q = query(
                booksCol,
                where("showInSnippet", "==", true), // ★ 修正: showInSnippet が true の書籍のみを取得
                orderBy("order", "asc") // order順に変更
              );
              const querySnapshot = await getDocs(q);

              // スニペットコードを生成 (common.jsの関数を使用)
              // querySnapshotを配列に変換して渡す
              const books = [];
              querySnapshot.forEach(doc => books.push(doc));
              const snippet = generateBookSnippet(books);

              // テキストエリアに挿入
              if (snippetCodeArea) {
                // textareaの最初の行にある不要な空白を削除するためにtrim()を使用
                snippetCodeArea.value = snippet.trim();
              }

              // モーダルを表示
              snippetModal.classList.remove("hidden");
              if (copyMessage) copyMessage.classList.add("hidden"); // コピーメッセージをリセット
            } catch (error) {
              console.error("Error generating book snippet: ", error);
              showMessage(`スニペット生成エラー: ${error.message}`, "error");
            }
          });

          // 2. モーダルを閉じる
          closeSnippetModalBtn.addEventListener("click", () => {
            snippetModal.classList.add("hidden");
          });

          // 3. コピーボタン
          copySnippetButton.addEventListener("click", () => {
            if (snippetCodeArea && copyMessage) {
              snippetCodeArea.select();
              document.execCommand("copy");
              copyMessage.classList.remove("hidden");
              setTimeout(() => {
                copyMessage.classList.add("hidden");
              }, 3000);
            }
          });
        }

        // 4. 書籍スニペット生成関数
        /**
         * トップページに埋め込むための書籍リスト HTML スニペットを生成する
         * @param {QuerySnapshot} querySnapshot - "fixed: true" でフィルタリングされた書籍データ
         * @returns {string} 生成された HTML スニペット
         */
        function generateBookSnippet(querySnapshot) {
          if (querySnapshot.empty) {
            return `
            <div id="top-books-container" class="mt-8 mb-16 px-4">
              <p class="text-center text-text-muted-light dark:text-text-muted-dark">現在、トップページに固定表示する書籍はありません。</p>
            </div>
          `;
          }

          let booksHtml = "";
          querySnapshot.forEach((docSnap) => {
            const book = docSnap.data();
            const linkHref = book.url || "#";
            const targetBlank = book.url
              ? 'target="_blank" rel="noopener noreferrer"'
              : "";

            booksHtml += `
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6 rounded-lg bg-card-light dark:bg-card-dark p-6 shadow-md transition-shadow hover:shadow-xl">
              <div class="w-48 md:w-56 flex-shrink-0">
                <img alt="Book cover of ${book.title}" class="rounded-lg shadow-xl w-full h-auto object-cover aspect-[3/4]" src="${book.imageUrl}" onerror="this.src='https://placehold.co/300x400/cccccc/ffffff?text=Image+Not+Found'; this.onerror=null;">
              </div>
              <div class="flex flex-col gap-4 text-center md:text-left">
                <div class="flex flex-col gap-1">
                  <p class="text-text-light dark:text-text-dark text-xl font-bold leading-tight">${book.title}</p>
                  <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal leading-normal">${book.description}</p>
                </div>
                <a class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] transition-transform hover:scale-105 mx-auto md:mx-0 w-fit" href="${linkHref}" ${targetBlank}>
                  <span class="truncate">詳細を見る</span>
                  <span class="material-symbols-outlined ml-2 text-base">arrow_forward</span>
                </a>
              </div>
            </div>
          `;
          });

          // Tailwind/HTML 構造全体を返す
          return `
          <div id="top-books-container" class="mt-8 mb-16 px-4 flex flex-col gap-6">
            <h2 class="text-text-light dark:text-text-dark text-2xl font-bold leading-tight tracking-[-0.015em] pb-3 pt-5 border-b border-primary/20">
              今、読んでほしい一冊 (Topics)
            </h2>
            ${booksHtml}
          </div>
          `;
        }

        // --- ★ 汎用アップロード関数 (NEW) ★ ---
        async function uploadImage(storageRef, file, progressBar) {
          return new Promise((resolve, reject) => {
            const uploadTask = uploadBytesResumable(storageRef, file);
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                if (progressBar) {
                  const progress =
                    (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  progressBar.style.width = progress + "%";
                }
              },
              (error) => {
                console.error("Upload Error:", error);
                reject(new Error(`画像アップロード失敗: ${error.message}`));
              },
              async () => {
                try {
                  const downloadURL = await getDownloadURL(
                    uploadTask.snapshot.ref
                  );
                  resolve(downloadURL);
                } catch (getUrlError) {
                  console.error("Get URL Error:", getUrlError);
                  reject(new Error(`画像URL取得失敗: ${getUrlError.message}`));
                }
              }
            );
          });
        }

        // --- 2. タブ切り替えロジック ---
        if (tabsContainer) {
        tabsContainer.addEventListener("click", (e) => {
          const targetButton = e.target.closest(".tab-btn");
          if (!targetButton) return;

          const tabName = targetButton.dataset.tab;

          // 1. タブボタンのアクティブ切り替え
          tabsContainer.querySelectorAll(".tab-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          targetButton.classList.add("active");

          // 2. タブコンテンツの表示切り替え
          tabContents.forEach((content) => {
            content.classList.remove("active");
            // クラスだけでなく style も操作して確実に隠す
            content.style.display = "none"; 
          });
          
          const activeContent = document.getElementById(`tab-content-${tabName}`);
          if (activeContent) {
            activeContent.classList.add("active");
            activeContent.style.display = "block"; // 確実に表示

            // --- ★ タブごとの初期化処理 ★ ---
            
            if (tabName === 'articles') {
                if (typeof setupArticleSubTabs === 'function') setupArticleSubTabs();
                if (typeof loadArticles === 'function') loadArticles();
                if (typeof loadArticleCategories === 'function') loadArticleCategories();
            } 
            else if (tabName === 'books') {
                if (typeof loadBooks === 'function') loadBooks();
            }
            else if (tabName === 'media-icons') {
                if (typeof loadMediaIcons === 'function') loadMediaIcons();
            }
            else if (tabName === 'media-banners') {
                if (typeof loadMediaBanners === 'function') loadMediaBanners();
            }
            else if (tabName === 'sites') {
                if (typeof loadSites === 'function') loadSites();
            }
            else if (tabName === 'common-management') {
                if (typeof setupCommonManagementSubTabs === 'function') setupCommonManagementSubTabs();
            }
            else if (tabName === 'static-pages') {
                if (typeof setupStaticPageSubTabs === 'function') setupStaticPageSubTabs();
                // 初期サブタブをクリック
                const defaultSubTab = activeContent.querySelector('.sub-tab-btn[data-sub-tab="common"]');
                if (defaultSubTab) defaultSubTab.click();
            }
            // ★ 今回の修正箇所: ブログ記事管理 ★
            else if (tabName === 'blog-posts') {
              // 1. サブタブ切り替え機能の初期化 (関数が存在すれば実行)
              if (typeof setupBlogPostSubTabs === 'function') setupBlogPostSubTabs();

              // 2. データの読み込み (関数が存在すれば実行)
              if (typeof loadBlogPosts === 'function') loadBlogPosts();
              if (typeof loadDynamicBlogs === 'function') loadDynamicBlogs();
              if (typeof loadBlogCategories === 'function') loadBlogCategories();
              
              // 3. 初期表示のサブタブをクリック状態にする
              const defaultSubTab = activeContent.querySelector('.sub-tab-btn[data-subtab="blog-meta"]');
              if (defaultSubTab) defaultSubTab.click();
            }
            else if (tabName === 'saved-links') {
                if (typeof loadSavedLinks === 'function') loadSavedLinks();
            }
            else if (tabName === 'custom-html') {
                if (typeof loadCustomParts === 'function') loadCustomParts();
            }
          }
        });
        }

// --- 18. 固定ページ管理 サブタブ切り替えロジックを関数化 (再修正) ---
function setupStaticPageSubTabs() {
  const staticPagesTab = document.getElementById(
    "tab-content-static-pages"
  );
  if (!staticPagesTab) return;

  // すべての変数を一度だけ宣言
  const subTabsContainer = staticPagesTab.querySelector(
    ".sub-tabs-container"
  );
  const subTabContents =
    staticPagesTab.querySelectorAll(".sub-tab-content");
  const ctaBlock = document.getElementById("common-cta-block");
  const blogCatBlock = document.getElementById(
    "common-blog-category-block"
  );
  // 初期表示用に 'sub-tab-content-common' のみ 'active' にする
  staticPagesTab.querySelector('#sub-tab-content-common')?.classList.add('active');


  // --- イベントリスナーの登録 ---
  if (subTabsContainer && subTabContents.length > 0) {
    // リスナー重複登録防止ロジックは削除

    subTabsContainer.addEventListener("click", (e) => {
      const targetButton = e.target.closest(".sub-tab-btn");
      if (!targetButton) return;

      const subTabName = targetButton.dataset.subTab;

      // ボタンのアクティブ状態を切り替え
      subTabsContainer
        .querySelectorAll(".sub-tab-btn")
        .forEach((btn) => {
          btn.classList.remove("active");
        });
      targetButton.classList.add("active");

      // コンテンツの表示を切り替え
      subTabContents.forEach((content) => {
        if (content.id === `sub-tab-content-${subTabName}`) {
          content.classList.add("active");
        } else {
          content.classList.remove("active");
        }
      });

      // ★ サブタブ切り替え時の表示制御ロジック ★
      // 'common' タブが選択された時のみ共通ブロックを表示する
      const isCommonTab = subTabName === "common";

      if (ctaBlock) ctaBlock.classList.toggle("hidden", !isCommonTab);
      if (blogCatBlock)
        blogCatBlock.classList.toggle("hidden", !isCommonTab);
    });

    // リスナー設定済みフラグのロジックは削除
  }
}

        // --- 認証 (Auth) ロジック ---
        // --- 3. 認証ロジック ---
        onAuthStateChanged(auth, (user) => {
          checkMFA(user);
          if (user) {
            // ログイン済みの場合の初期化処理
            loadSiteBranding(); // ★ サイトタイトル読み込み
            console.log("User logged in:", user.email);

            if (loginSection) loginSection.classList.add("hidden");
            if (mfaSection) mfaSection.classList.add("hidden");
            if (dashboardSection) dashboardSection.classList.remove("hidden");
            if (userEmailEl)
              userEmailEl.textContent = `ようこそ、${user.email} さん`;

            // ★ 5つのロード関数を呼び出す
            loadArticles();
            loadBooks();
            loadMediaIcons();
            loadMediaBanners();
            loadSites();

            // ★ 固定ページ共通(CTA)のロード関数を呼び出す
            loadHeaderCtaData();
            
            // ★ NEW: Phase 10-1 経歴・スキル管理機能の統合 ★
            addTimelineFormListener();
            loadTimeline();
            
            addSkillsFormListener();
            loadSkills();
            // ★ NEW: パーソナル情報管理機能の統合 ★
            addPersonalFormListener();
            loadPersonalInfo();
            // ★ NEW: Contact Set Management
            // ★ NEW: Contact Set Management
            loadContactSets();
            // ★ ブログ記事管理の初期化 (追記)
            if (typeof setupBlogPostSubTabs === 'function') setupBlogPostSubTabs();
            if (typeof loadDynamicBlogs === 'function') loadDynamicBlogs();

            // ★ P-New: ブログカテゴリーのロード関数を呼び出す
            loadBlogCategories();
            // ★ P2: ブログ記事のロード関数を呼び出す
            loadBlogPosts();
            // ★ NEW: 動的ブログ記事のロード関数を呼び出す
            loadDynamicBlogs();

            // ★ Phase 6-1: 共通管理サブタブの初期化
            setupCommonManagementSubTabs();
            // ★ NEW: Articles & Blog Posts Sub-tabs Initialization
            setupArticleSubTabs();
            setupBlogPostSubTabs();
            loadArticleCategories();
            // ★ ナビゲーション読み込み順序の保証 (サブタブ初期化の直後に実行)
            loadNavigation();
            loadBottomNavigation();

          } else {
            console.log("User logged out");
            if (loginSection) loginSection.classList.remove("hidden");
            if (mfaSection) mfaSection.classList.add("hidden");
            if (dashboardSection) dashboardSection.classList.add("hidden");
            if (userEmailEl) userEmailEl.textContent = "";
          }
        });

        if (googleLoginBtn) {
          googleLoginBtn.addEventListener("click", async () => {
            const provider = new GoogleAuthProvider();
            try {
              const result = await signInWithPopup(auth, provider);
              console.log("Google login successful");
              showMessage("Googleログインに成功しました。");
              await checkMFA(result.user);
            } catch (error) {
              console.error("Google login error:", error);
              if (error.code === "auth/multi-factor-auth-required") {
                mfaResolver = error.resolver;
                setupMFA();
              } else if (error.code !== "auth/popup-closed-by-user") {
                showMessage(`Googleログインエラー: ${error.message}`, "error");
              }
            }
          });
        }

        if (emailLoginForm) {
          emailLoginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            try {
              const result = await signInWithEmailAndPassword(
                auth,
                email,
                password
              );
              console.log("Email login successful");
              showMessage("ログインに成功しました。");
              await checkMFA(result.user);
            } catch (error) {
              console.error("Email login error:", error);
              if (error.code === "auth/multi-factor-auth-required") {
                mfaResolver = error.resolver;
                setupMFA();
              } else {
                showMessage(`ログインエラー: ${error.message}`, "error");
              }
            }
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await signOut(auth);
              showMessage("ログアウトしました。");
            } catch (error) {
              showMessage(`ログアウトエラー: ${error.message}`, "error");
            }
          });
        }

        // --- 2段階認証 (MFA) ロジック ---
        // --- 4. 2段階認証 (MFA) ロジック ---
        async function checkMFA(user) {
          // ★ NEW: ログアウト状態(user=null)の場合は即座に処理を終了
          if (!user) {
            console.log("MFA check skipped: User is logged out.");
            return;
          }
          if (
            user.multiFactor &&
            Array.isArray(user.multiFactor.enrolledFactors) &&
            user.multiFactor.enrolledFactors.length === 0
          ) {
            console.log("MFA not enrolled. Prompting for enrollment.");
            if (mfaInfoText)
              mfaInfoText.textContent =
                "セキュリティ強化のため、2段階認証の登録が必要です。電話番号を入力してSMSコードを送信してください。";
            mfaResolver = null;
            setupMFA();
          } else {
            console.log(
              "MFA check passed or MFA property not found, proceeding to dashboard."
            );
            if (loginSection) loginSection.classList.add("hidden");
            if (mfaSection) mfaSection.classList.add("hidden");
            if (dashboardSection) dashboardSection.classList.remove("hidden");
            if (userEmailEl)
              userEmailEl.textContent = `ようこそ、${user.email} さん`;
          }
        }

        async function setupMFA() {
          if (loginSection) loginSection.classList.add("hidden");
          if (mfaSection) mfaSection.classList.remove("hidden");
          if (phoneForm) phoneForm.classList.remove("hidden");
          if (codeForm) codeForm.classList.add("hidden");
          const recaptchaContainer = document.getElementById(
            "recaptcha-container"
          );
          if (recaptchaContainer && !recaptchaContainer.innerHTML.trim()) {
            try {
              window.recaptchaVerifier = new RecaptchaVerifier(
                auth,
                "recaptcha-container",
                {
                  size: "invisible",
                  callback: (response) => console.log("reCAPTCHA solved"),
                  "expired-callback": () => {
                    console.log("reCAPTCHA expired, resetting");
                    window.recaptchaVerifier
                      .render()
                      .catch((err) =>
                        console.error("Error re-rendering reCAPTCHA", err)
                      );
                  },
                }
              );
              await window.recaptchaVerifier.render();
              console.log("reCAPTCHA verifier rendered");
            } catch (error) {
              console.error("reCAPTCHA error:", error);
              showMessage(`reCAPTCHAエラー: ${error.message}`, "error");
            }
          }
        }

        if (phoneForm) {
          phoneForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const phoneNumber = phoneNumberInput.value;
            const appVerifier = window.recaptchaVerifier;
            if (!appVerifier) {
              showMessage(
                "reCAPTCHAが初期化されていません。ページをリロードしてください。",
                "error"
              );
              return;
            }
            try {
              let phoneAuthProvider;
              if (mfaResolver) {
                const mfaHint = mfaResolver.hints.find(
                  (hint) =>
                    hint.factorId === PhoneMultiFactorGenerator.FACTOR_ID
                );
                if (!mfaHint) {
                  // MFA解決用だがヒントがない場合（ほぼあり得ないが）
                  console.log("MFAヒントが見つかりません。");
                  showMessage(
                    "認証エラー: 電話番号のヒントが見つかりません。",
                    "error"
                  );
                  return;
                }
                phoneAuthProvider = new PhoneAuthProvider(auth);
                currentVerificationId =
                  await phoneAuthProvider.verifyPhoneNumber(
                    { multiFactorHint: mfaHint, session: mfaResolver.session },
                    appVerifier
                  );
              } else if (auth.currentUser) {
                // 新規登録の場合
                const session = await auth.currentUser.multiFactor.getSession();
                phoneAuthProvider = new PhoneAuthProvider(auth);
                currentVerificationId =
                  await phoneAuthProvider.verifyPhoneNumber(
                    { phoneNumber: phoneNumber, session: session },
                    appVerifier
                  );
              } else {
                throw new Error("ユーザーがログインしていません。");
              }
              showMessage("確認コードを送信しました。");
              if (phoneForm) phoneForm.classList.add("hidden");
              if (codeForm) codeForm.classList.remove("hidden");
            } catch (error) {
              console.error("SMS send error:", error);
              showMessage(`SMS送信エラー: ${error.message}`, "error");
              appVerifier.clear(); // エラー時にリセット
              appVerifier
                .render()
                .catch((err) =>
                  console.error("Error re-rendering reCAPTCHA", err)
                );
            }
          });
        }

        if (codeForm) {
          codeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const code = codeInput.value;
            if (!currentVerificationId) {
              showMessage(
                "確認IDがありません。SMS送信からやり直してください。",
                "error"
              );
              return;
            }
            const credential = PhoneAuthProvider.credential(
              currentVerificationId,
              code
            );
            try {
              if (mfaResolver) {
                const multiFactorAssertion =
                  PhoneMultiFactorGenerator.assertion(credential);
                await mfaResolver.resolveSignIn(multiFactorAssertion);
                showMessage("2段階認証に成功しました。");
                // 成功したらMFA画面を閉じてダッシュボード表示
                if (mfaSection) mfaSection.classList.add("hidden");
                if (dashboardSection)
                  dashboardSection.classList.remove("hidden");
              } else if (auth.currentUser) {
                const multiFactorAssertion =
                  PhoneMultiFactorGenerator.assertion(credential);
                await auth.currentUser.multiFactor.enroll(
                  multiFactorAssertion,
                  `My Phone`
                );
                showMessage("2段階認証の登録が完了しました。");
                if (mfaSection) mfaSection.classList.add("hidden");
                if (dashboardSection)
                  dashboardSection.classList.remove("hidden");
              } else {
                throw new Error("ユーザーがログインしていません。");
              }
            } catch (error) {
              console.error("MFA verification error:", error);
              showMessage(`認証エラー: ${error.message}`, "error");
            } finally {
              // フォームをリセット
              if (phoneForm) phoneForm.classList.remove("hidden");
              if (codeForm) codeForm.classList.add("hidden");
              if (codeInput) codeInput.value = "";
              if (phoneNumberInput) phoneNumberInput.value = "";
              currentVerificationId = null;
              mfaResolver = null;
              if (window.recaptchaVerifier) window.recaptchaVerifier.clear();
            }
          });
        }

        // --- Firestore (お知らせ) ロジック ---
        // --- 5. お知らせ管理 (Articles CRUD) ---

        // 1. お知らせの読み込み
        async function loadArticles() {
          if (!articlesLoader || !articlesListContainer) return;
          articlesLoader.classList.remove("hidden");
          articlesListContainer.innerHTML = ""; // 一旦クリア
          articlesListContainer.appendChild(articlesLoader);
          try {
            const articlesCol = collection(db, "articles");
            const q = query(articlesCol, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            articlesLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const articlesCountDisplay = document.getElementById(
              "articles-count-display"
            );
            if (articlesCountDisplay) {
              articlesCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }

            if (querySnapshot.empty) {
              articlesListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ記事がありません。</p>';
              return;
            }

            // 古い一覧をクリア
            articlesListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const article = docSnap.data();
              const articleId = docSnap.id;
              const articleEl = document.createElement("div");
              articleEl.className =
                "flex flex-col sm:flex-row items-start gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              let imageHtml = article.imageUrl
                ? `<img src="${article.imageUrl}" alt="${
                    article.title || "記事画像"
                  }" class="w-full sm:w-32 h-auto object-cover rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/300x200/cccccc/ffffff?text=No+Image'; this.onerror=null;">`
                : `<div class="w-full sm:w-32 h-20 bg-slate-200 dark:bg-slate-700 rounded-md flex items-center justify-center text-text-muted-light dark:text-text-muted-dark text-sm flex-shrink-0">画像なし</div>`;

              let articleDateStr = "日付不明";
              if (article.date) {
                try {
                  // タイムゾーンの問題を考慮して 'yyyy-mm-dd' をそのまま表示
                  articleDateStr = article.date.split("-").join(".");
                } catch (e) {
                  console.warn("Date format error:", e);
                }
              } else if (article.createdAt?.toDate) {
                try {
                  const dateObj = article.createdAt.toDate();
                  const year = dateObj.getFullYear();
                  const month = (dateObj.getMonth() + 1)
                    .toString()
                    .padStart(2, "0");
                  const day = dateObj.getDate().toString().padStart(2, "0");
                  articleDateStr = `${year}.${month}.${day}`;
                } catch (e) {
                  console.warn("Timestamp format error:", e);
                }
              }

              // ★ 特殊文字をエンコードして data 属性に埋め込む
              const contentPreview = article.content
                ? `${article.content.substring(0, 100)}...`
                : "";
              articleEl.innerHTML = `
              ${imageHtml}
              <div class="flex-grow">
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${articleDateStr} | <span class="font-semibold text-primary">${
                article.category || "カテゴリなし"
              }</span></p>
                <h3 class="text-lg font-bold mt-1">${
                  article.title || "タイトルなし"
                }</h3>
                ${
                  contentPreview
                    ? `<p class="text-sm mt-2 text-text-light dark:text-text-dark">${contentPreview}</p>`
                    : ""
                }
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${articleId}"
                  data-collection="articles"
                  data-title="${encodeURIComponent(article.title || "")}"
                  data-date="${article.date || ""}"
                  data-category="${article.category || "お知らせ"}"
                  data-content="${encodeURIComponent(article.content || "")}"
                  data-image-url="${article.imageUrl || ""}"
                  data-image-path="${article.imagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-type="article"
                  data-title="${encodeURIComponent(article.title || '')}"
                  data-image-url="${article.imageUrl || ''}"
                  data-description="${encodeURIComponent(article.content || '')}"
                  data-date="${articleDateStr}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>スニペット</span>
                </button>
                <button data-doc-id="${articleId}" data-collection="articles" data-image-path="${
                article.imagePath || ""
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              articlesListContainer.appendChild(articleEl);
            });
          } catch (error) {
            console.error("Error loading articles: ", error);
            showMessage(`記事の読み込みエラー: ${error.message}`, "error");
            articlesLoader.classList.add("hidden");
            articlesListContainer.innerHTML =
              '<p class="text-center text-red-500">記事の読み込みに失敗しました。</p>';
          }
        }

        // 2. お知らせの追加
        if (addArticleForm) {
          addArticleForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("article-title").value;
            const date = document.getElementById("article-date").value;
            const category = document.getElementById("article-category").value;
            const content = document.getElementById("article-content").value;

            if (submitArticleBtn) {
              submitArticleBtn.disabled = true;
              submitArticleBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              let imageUrl = "";
              let imagePath = "";
              if (selectedFileArticle) {
                const userId = auth.currentUser.uid;
                if (!userId) throw new Error("ユーザーが認証されていません。");
                imagePath = `images/photo/articles/${userId}/${Date.now()}_${
                  selectedFileArticle.name
                }`;
                const storageRef = ref(storage, imagePath);
                if (uploadProgressContainerArticle)
                  uploadProgressContainerArticle.classList.remove("hidden");
                imageUrl = await uploadImage(
                  storageRef,
                  selectedFileArticle,
                  uploadProgressBarArticle
                );
              }
              await addDoc(collection(db, "articles"), {
                title: title,
                date: date,
                category: category,
                content: content,
                imageUrl: imageUrl,
                imagePath: imagePath,
                createdAt: serverTimestamp(),
              });
              showMessage("記事が正常に追加されました。");
              resetArticleForm();
              loadArticles();
            } catch (error) {
              console.error("Error adding article: ", error);
              showMessage(`記事の追加エラー: ${error.message}`, "error");
              resetArticleForm(); // エラー時もリセット
            }
          });
        }

        // 3. お知らせフォームのリセット
        function resetArticleForm() {
          if (addArticleForm) addArticleForm.reset();
          selectedFileArticle = null;
          if (imageInputArticle) imageInputArticle.value = "";
          if (imagePreviewArticle) {
            imagePreviewArticle.classList.add("hidden");
            imagePreviewArticle.src = "";
          }
          if (uploadProgressContainerArticle)
            uploadProgressContainerArticle.classList.add("hidden");
          if (uploadProgressBarArticle)
            uploadProgressBarArticle.style.width = "0%";
          if (submitArticleBtn) {
            submitArticleBtn.disabled = false;
            submitArticleBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>記事を追加する</span>';
          }
        }

        // 4. お知らせ画像プレビュー
        if (imageInputArticle) {
          imageInputArticle.addEventListener("change", (e) => {
            selectedFileArticle = e.target.files[0];
            if (selectedFileArticle) {
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (selectedFileArticle.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは5MB以下にしてください。",
                  "error"
                );
                selectedFileArticle = null;
                if (imageInputArticle) imageInputArticle.value = "";
                if (imagePreviewArticle) {
                  imagePreviewArticle.classList.add("hidden");
                  imagePreviewArticle.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewArticle) {
                  imagePreviewArticle.src = event.target.result;
                  imagePreviewArticle.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileArticle);
              if (uploadProgressContainerArticle)
                uploadProgressContainerArticle.classList.add("hidden");
            } else {
              selectedFileArticle = null;
              if (imagePreviewArticle) {
                imagePreviewArticle.classList.add("hidden");
                imagePreviewArticle.src = "";
              }
            }
          });
        }

        // 5. ★ お知らせ修正用画像プレビュー (NEW)
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-article-image") {
            editFileArticle = e.target.files[0];
            const preview = document.getElementById(
              "edit-image-preview-article"
            );
            if (editFileArticle && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileArticle);
            } else if (preview) {
              // No file selected, keep the old image preview (don't hide)
            }
          }
        });

        // --- Firestore (書籍) ロジック ---
        // --- 6. 書籍管理 (Books CRUD) ---

        // 1. 書籍の読み込み
        async function loadBooks() {
          if (!booksLoader || !booksListContainer) return;
          booksLoader.classList.remove("hidden");
          booksListContainer.innerHTML = "";
          booksListContainer.appendChild(booksLoader);
          try {
            const booksCol = collection(db, "books");
            const q = query(booksCol, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            booksLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const booksCountDisplay = document.getElementById(
              "books-count-display"
            );
            if (booksCountDisplay) {
              booksCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }
            if (querySnapshot.empty) {
              booksListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ書籍がありません。</p>';
              return;
            }

            booksListContainer.innerHTML = ""; // 古い一覧をクリア

            querySnapshot.forEach((docSnap) => {
              const book = docSnap.data();
              const bookId = docSnap.id;
              const bookEl = document.createElement("div");
              bookEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";
              bookEl.innerHTML = `
              <img src="${book.imageUrl}" alt="${
                book.title
              }" class="w-20 h-auto object-cover rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/150x200/cccccc/ffffff?text=No+Cover'; this.onerror=null;">
              <div class="flex-grow">
                <h3 class="text-lg font-bold">${book.title}</h3>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${
                  book.description ? book.description.substring(0, 100) : ""
                }...</p>
                ${
                  book.url
                    ? `<a href="${book.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline break-all">${book.url}</a>`
                    : ""
                }
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <button 
                  data-doc-id="${bookId}"
                  data-collection="books"
                  data-title="${encodeURIComponent(book.title || "")}"
                  data-url="${encodeURIComponent(book.url || "")}"
                <button 
                  data-type="bookSnippet"
                  data-doc-id="${bookId}"
                  data-collection="books"
                  data-title="${encodeURIComponent(book.title || "")}"
                  data-url="${encodeURIComponent(book.url || "")}"
                  data-description="${encodeURIComponent(
                    book.description || ""
                  )}"
                  data-image-url="${book.imageUrl || ""}"
                  data-image-path="${book.imagePath || ""}"
                  data-star-rating="${book.starRating || 5}"
                  data-button-text="${encodeURIComponent(book.buttonText || '')}"
                  data-open-new-tab="${book.openNewTab === true ? 'true' : 'false'}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>単冊スニペット</span>
                </button>
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${bookId}"
                  data-collection="books"
                  data-title="${encodeURIComponent(book.title || "")}"
                  data-url="${encodeURIComponent(book.url || "")}"
                  data-description="${encodeURIComponent(
                    book.description || ""
                  )}"
                  data-fixed="${book.fixed === true ? 'true' : 'false'}"
                  data-fixed-on-media="${book.fixedOnMedia === true ? 'true' : 'false'}"
                  data-show-in-snippet="${book.showInSnippet !== false ? 'true' : 'false'}"
                  data-order="${book.order || 10}"
                  data-star-rating="${book.starRating || 5}"
                  data-button-text="${encodeURIComponent(book.buttonText || '')}"
                  data-open-new-tab="${book.openNewTab === true ? 'true' : 'false'}"
                  data-image-url="${book.imageUrl || ""}"
                  data-image-path="${book.imagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>

                <button data-doc-id="${bookId}" data-collection="books" data-image-path="${
                book.imagePath
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              booksListContainer.appendChild(bookEl);
            });
          } catch (error) {
            console.error("Error loading books: ", error);
            showMessage(`書籍の読み込みエラー: ${error.message}`, "error");
            booksLoader.classList.add("hidden");
            booksListContainer.innerHTML =
              '<p class="text-center text-red-500">書籍の読み込みに失敗しました。</p>';
          }
        }

        // 2. 書籍の追加
        if (addBookForm) {
          addBookForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("book-title").value;
            const url = document.getElementById("book-url").value;
            const buttonText = document.getElementById("book-button-text").value || "詳細を見る";
            const openNewTab = document.getElementById("book-open-new-tab").checked;
            const description =
              document.getElementById("book-description").value;
            
            // ★ 【追加】fixed, fixedOnMedia, order, starRating の値を取得
            const fixed = document.getElementById("book-fixed").checked;
            const fixedOnMedia = document.getElementById("book-fixed-on-media").checked;
            const order = parseInt(document.getElementById("book-order").value, 10);
            let starRating = parseInt(document.getElementById("book-star-rating").value, 10);
            starRating = Math.min(5, Math.max(1, starRating || 5)); // 1から5の間に制限し、空の場合は5をデフォルトとする

            if (!selectedFileBook) {
              showMessage("書籍画像は必須です。", "error");
              return;
            }

            if (submitBookBtn) {
              submitBookBtn.disabled = true;
              submitBookBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              const userId = auth.currentUser.uid;
              if (!userId) throw new Error("ユーザーが認証されていません。");
              const imagePath = `images/photo/books/${userId}/${Date.now()}_${
                selectedFileBook.name
              }`;
              const storageRef = ref(storage, imagePath);

              if (uploadProgressContainerBook)
                uploadProgressContainerBook.classList.remove("hidden");
              const imageUrl = await uploadImage(
                storageRef,
                selectedFileBook,
                uploadProgressBarBook
              );

              await addDoc(collection(db, "books"), {
                title: title,
                url: url,
                buttonText: buttonText, // ★ 追加
                openNewTab: openNewTab, // ★ 追加
                description: description,
                imageUrl: imageUrl,
                imagePath: imagePath,
                // ★ 【追加】fixed, order, starRating, showInSnippet を保存
                fixed: fixed,
                fixedOnMedia: document.getElementById("book-fixed-on-media").checked,
                showInSnippet: document.getElementById("book-show-in-snippet").checked,
                order: order,
                starRating: starRating,
                createdAt: serverTimestamp(),
              });
              showMessage("書籍が正常に追加されました。");
              resetBookForm();
              loadBooks();
            } catch (error) {
              console.error("Error adding book: ", error);
              showMessage(`書籍の追加エラー: ${error.message}`, "error");
              resetBookForm();
            }
          });
        }

        // 3. 書籍フォームのリセット
        function resetBookForm() {
          if (addBookForm) addBookForm.reset();
          selectedFileBook = null;
          if (imageInputBook) imageInputBook.value = "";
          if (imagePreviewBook) {
            imagePreviewBook.classList.add("hidden");
            imagePreviewBook.src = "";
          }
          if (uploadProgressContainerBook)
            uploadProgressContainerBook.classList.add("hidden");
          if (uploadProgressBarBook) uploadProgressBarBook.style.width = "0%";
          if (submitBookBtn) {
            submitBookBtn.disabled = false;
            submitBookBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>書籍を追加する</span>';
          }
        }

        // 4. 書籍画像プレビュー
        if (imageInputBook) {
          imageInputBook.addEventListener("change", (e) => {
            selectedFileBook = e.target.files[0];
            if (selectedFileBook) {
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (selectedFileBook.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは5MB以下にしてください。",
                  "error"
                );
                selectedFileBook = null;
                if (imageInputBook) imageInputBook.value = "";
                if (imagePreviewBook) {
                  imagePreviewBook.classList.add("hidden");
                  imagePreviewBook.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewBook) {
                  imagePreviewBook.src = event.target.result;
                  imagePreviewBook.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileBook);
              if (uploadProgressContainerBook)
                uploadProgressContainerBook.classList.add("hidden");
            } else {
              selectedFileBook = null;
              if (imagePreviewBook) {
                imagePreviewBook.classList.add("hidden");
                imagePreviewBook.src = "";
              }
            }
          });
        }

        // 5. ★ 書籍修正用画像プレビュー (NEW)
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-book-image") {
            editFileBook = e.target.files[0];
            const preview = document.getElementById("edit-image-preview-book");
            if (editFileBook && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileBook);
            }
          }
        });

        // --- Firestore (メディア(アイコン)) ロジック ---
        // --- 7. メディア(アイコン)管理 (Media Icons CRUD) ---

        // 1. 読み込み
        async function loadMediaIcons() {
          if (!mediaIconsLoader || !mediaIconsListContainer) return;
          mediaIconsLoader.classList.remove("hidden");
          mediaIconsListContainer.innerHTML = "";
          mediaIconsListContainer.appendChild(mediaIconsLoader);
          try {
            const mediaIconsCol = collection(db, "mediaIcons");
            const q = query(mediaIconsCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            mediaIconsLoader.classList.add("hidden");
            if (querySnapshot.empty) {
              mediaIconsListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだメディア(アイコン)がありません。</p>';
              return;
            }

            mediaIconsListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const iconData = docSnap.data();
              const iconId = docSnap.id;
              const iconEl = document.createElement("div");
              iconEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              let iconHtml = "";
              if (iconData.customIconUrl) {
                iconHtml = `<img src="${iconData.customIconUrl}" alt="${iconData.title}" class="w-10 h-10 object-contain rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/64x64/cccccc/ffffff?text=Icon'; this.onerror=null;">`;
              } else {
                iconHtml = `<span class="material-symbols-outlined text-3xl text-primary w-10 h-10 flex items-center justify-center flex-shrink-0">${
                  iconData.iconName || "link"
                }</span>`;
              }

              iconEl.innerHTML = `
              ${iconHtml}
              <div class="flex-grow w-full">
                <h3 class="text-lg font-bold">${
                  iconData.title
                } <span class="text-sm text-text-muted-light"> (表示順: ${
                iconData.order
              })</span></h3>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${
                  iconData.description
                }</p>
                ${
                  iconData.url
                    ? `<a href="${iconData.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline break-all">${iconData.url}</a>`
                    : ""
                }
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${iconId}"
                  data-collection="mediaIcons"
                  data-title="${encodeURIComponent(iconData.title || "")}"
                  data-description="${encodeURIComponent(
                    iconData.description || ""
                  )}"
                  data-url="${encodeURIComponent(iconData.url || "")}"
                  data-order="${iconData.order || "10"}"
                  data-icon-name="${iconData.iconName || "link"}"
                  data-image-url="${iconData.customIconUrl || ""}"
                  data-image-path="${iconData.customImagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-type="mediaIcon"
                  data-title="${encodeURIComponent(iconData.title || '')}"
                  data-url="${encodeURIComponent(iconData.url || '')}" 
                  data-image-url="${iconData.customIconUrl || ''}"
                  data-description="${encodeURIComponent(iconData.description || '')}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>スニペット</span>
                </button>
                <button data-doc-id="${iconId}" data-collection="mediaIcons" data-image-path="${
                iconData.customImagePath || ""
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              mediaIconsListContainer.appendChild(iconEl);
            });
          } catch (error) {
            console.error("Error loading media icons: ", error);
            showMessage(
              `メディア(アイコン)の読み込みエラー: ${error.message}`,
              "error"
            );
            mediaIconsLoader.classList.add("hidden");
            mediaIconsListContainer.innerHTML =
              '<p class="text-center text-red-500">メディア(アイコン)の読み込みに失敗しました。</p>';
          }
        }

        // 2. 追加
        if (addMediaIconForm) {
          addMediaIconForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("media-icon-title").value;
            const description = document.getElementById(
              "media-icon-description"
            ).value;
            const url = document.getElementById("media-icon-url").value;
            const order = parseInt(
              document.getElementById("media-icon-order").value,
              10
            );
            const iconName = document.getElementById("media-icon-name").value;

            if (submitMediaIconBtn) {
              submitMediaIconBtn.disabled = true;
              submitMediaIconBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              let customIconUrl = "";
              let customImagePath = "";
              let finalIconName = iconName;

              if (selectedFileMediaIcon) {
                const userId = auth.currentUser.uid;
                if (!userId) throw new Error("ユーザーが認証されていません。");
                customImagePath = `images/system/media_icons/${userId}/${Date.now()}_${
                  selectedFileMediaIcon.name
                }`;
                const storageRef = ref(storage, customImagePath);

                if (uploadProgressContainerMediaIcon)
                  uploadProgressContainerMediaIcon.classList.remove("hidden");
                customIconUrl = await uploadImage(
                  storageRef,
                  selectedFileMediaIcon,
                  uploadProgressBarMediaIcon
                );
                finalIconName = ""; // カスタム画像優先
              }

              await addDoc(collection(db, "mediaIcons"), {
                title: title,
                description: description,
                url: url,
                order: order,
                iconName: finalIconName,
                customIconUrl: customIconUrl,
                customImagePath: customImagePath,
                createdAt: serverTimestamp(),
              });
              showMessage("メディア(アイコン)が正常に追加されました。");
              resetMediaIconForm();
              loadMediaIcons();
            } catch (error) {
              console.error("Error adding media icon: ", error);
              showMessage(
                `メディア(アイコン)の追加エラー: ${error.message}`,
                "error"
              );
              resetMediaIconForm();
            }
          });
        }

        // 3. フォームリセット
        function resetMediaIconForm() {
          if (addMediaIconForm) addMediaIconForm.reset();
          selectedFileMediaIcon = null;
          if (imageInputMediaIcon) imageInputMediaIcon.value = "";
          if (imagePreviewMediaIcon) {
            imagePreviewMediaIcon.classList.add("hidden");
            imagePreviewMediaIcon.src = "";
          }
          if (uploadProgressContainerMediaIcon)
            uploadProgressContainerMediaIcon.classList.add("hidden");
          if (uploadProgressBarMediaIcon)
            uploadProgressBarMediaIcon.style.width = "0%";
          if (submitMediaIconBtn) {
            submitMediaIconBtn.disabled = false;
            submitMediaIconBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>メディア(アイコン)を追加する</span>';
          }
        }

        // 4. 画像プレビュー
        if (imageInputMediaIcon) {
          imageInputMediaIcon.addEventListener("change", (e) => {
            selectedFileMediaIcon = e.target.files[0];
            if (selectedFileMediaIcon) {
              const maxSize = 2 * 1024 * 1024; // 2MB
              if (selectedFileMediaIcon.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは2MB以下にしてください。",
                  "error"
                );
                selectedFileMediaIcon = null;
                if (imageInputMediaIcon) imageInputMediaIcon.value = "";
                if (imagePreviewMediaIcon) {
                  imagePreviewMediaIcon.classList.add("hidden");
                  imagePreviewMediaIcon.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewMediaIcon) {
                  imagePreviewMediaIcon.src = event.target.result;
                  imagePreviewMediaIcon.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileMediaIcon);
              if (uploadProgressContainerMediaIcon)
                uploadProgressContainerMediaIcon.classList.add("hidden");
            } else {
              selectedFileMediaIcon = null;
              if (imagePreviewMediaIcon) {
                imagePreviewMediaIcon.classList.add("hidden");
                imagePreviewMediaIcon.src = "";
              }
            }
          });
        }

        // --- Firestore (経歴 - Timeline) ロジック ---
        // --- 16. 経歴管理 (Timeline CRUD) ---

        // 1. 経歴の読み込み
        async function loadTimeline() {
          const container = document.getElementById("timeline-list-container");
          const loader = document.getElementById("timeline-loader");
          if (!loader || !container) return;
          loader.classList.remove("hidden");
          container.innerHTML = "";
          container.appendChild(loader);

          try {
            const timelineCol = collection(db, "timeline");
            const q = query(timelineCol, orderBy("year", "desc")); // 年代降順でソート
            const querySnapshot = await getDocs(q);
            loader.classList.add("hidden");

            if (querySnapshot.empty) {
              container.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ経歴項目がありません。</p>';
              return;
            }

            container.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const item = docSnap.data();
              const itemId = docSnap.id;
              const itemEl = document.createElement("div");
              itemEl.className =
                "flex flex-col sm:flex-row items-start gap-4 p-4 bg-background-light dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700";
              itemEl.innerHTML = `
                <div class="flex-grow w-full">
                  <p class="text-sm font-bold text-primary">${item.year}</p>
                  <h3 class="text-lg font-bold mt-1">${item.title}</h3>
                  <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-1">${item.company}</p>
                  <p class="text-sm text-text-light dark:text-text-dark">${item.description.substring(0, 100)}...</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                  <button data-doc-id="${itemId}" data-collection="timeline" data-image-path="" class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                    <span class="material-symbols-outlined !text-base">edit</span>
                    <span>修正</span>
                  </button>
                  <button data-doc-id="${itemId}" data-collection="timeline" data-image-path="" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                    <span class="material-symbols-outlined !text-base">delete</span>
                    <span>削除</span>
                  </button>
                </div>
              `;
              container.appendChild(itemEl);
            });
          } catch (error) {
            console.error("Error loading timeline items: ", error);
            showMessage(`経歴の読み込みエラー: ${error.message}`, "error");
            loader.classList.add("hidden");
            container.innerHTML = '<p class="text-center text-red-500">経歴の読み込みに失敗しました。</p>';
          }
        }

        // 2. 経歴の追加フォームイベントリスナー
        function addTimelineFormListener() {
          const form = document.getElementById('add-timeline-form');
          const submitBtn = document.getElementById('submit-timeline-btn');
          if (!form) return;

          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const year = document.getElementById("timeline-year").value;
            const title = document.getElementById("timeline-title").value;
            const company = document.getElementById("timeline-company").value;
            const description = document.getElementById("timeline-description").value;

            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              await addDoc(collection(db, "timeline"), {
                year: year,
                title: title,
                company: company,
                description: description,
                createdAt: serverTimestamp(),
              });
              showMessage("経歴項目が正常に追加されました。");
              resetTimelineForm();
              loadTimeline();
            } catch (error) {
              console.error("Error adding timeline item: ", error);
              showMessage(`経歴項目の追加エラー: ${error.message}`, "error");
            } finally {
               if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="material-symbols-outlined">add</span> <span>経歴項目を追加する</span>';
              }
            }
          });
        }

        // 3. フォームリセット
        function resetTimelineForm() {
          const form = document.getElementById('add-timeline-form');
          if (form) form.reset();
        }

        // --- 17. スキル管理 (Skills CRUD) ---

        // 1. スキルの読み込み
        async function loadSkills() {
          const container = document.getElementById("skills-list-container");
          const loader = document.getElementById("skills-loader");
          if (!loader || !container) return;
          loader.classList.remove("hidden");
          container.innerHTML = "";
          container.appendChild(loader);

          try {
            const skillsCol = collection(db, "skills");
            const q = query(skillsCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            loader.classList.add("hidden");

            if (querySnapshot.empty) {
              container.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark col-span-full">まだスキル項目がありません。</p>';
              return;
            }

            container.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const item = docSnap.data();
              const itemId = docSnap.id;
              const itemEl = document.createElement("div");
              itemEl.className =
                "flex flex-col items-center justify-center text-center p-4 bg-background-light dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700";

              let iconHtml = '';
              if (item.customIconUrl) {
                iconHtml = `<img src="${item.customIconUrl}" alt="${item.title}" class="w-12 h-12 object-contain mb-2">`;
              } else {
                iconHtml = `<span class="material-symbols-outlined text-4xl text-primary mb-2">${item.icon || 'code'}</span>`;
              }

              itemEl.innerHTML = `
                <div class="flex-grow flex flex-col items-center justify-center">
                  ${iconHtml}
                  <h4 class="font-bold text-sm text-text-light dark:text-text-dark">${item.title}</h4>
                  <p class="text-xs text-text-muted-light dark:text-text-muted-dark">${item.subtitle}</p>
                </div>
                <div class="flex flex-row gap-2 mt-4 flex-shrink-0">
                  <button 
                    data-doc-id="${itemId}" 
                    data-collection="skills" 
                    data-title="${encodeURIComponent(item.title || '')}"
                    data-subtitle="${encodeURIComponent(item.subtitle || '')}"
                    data-icon="${encodeURIComponent(item.icon || '')}"
                    data-order="${item.order || 10}"
                    data-image-url="${item.customIconUrl || ''}"
                    data-image-path="${item.customImagePath || ''}"
                    class="edit-btn py-1 px-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-xs flex items-center gap-1">
                    <span class="material-symbols-outlined !text-sm">edit</span>
                    <span>修正</span>
                  </button>
                  <button data-doc-id="${itemId}" data-collection="skills" data-image-path="${item.customImagePath || ''}" class="delete-btn py-1 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-xs flex items-center gap-1">
                    <span class="material-symbols-outlined !text-sm">delete</span>
                    <span>削除</span>
                  </button>
                </div>
              `;
              container.appendChild(itemEl);
            });
          } catch (error) {
            console.error("Error loading skills: ", error);
            showMessage(`スキル読み込みエラー: ${error.message}`, "error");
            loader.classList.add("hidden");
            container.innerHTML = '<p class="text-center text-red-500 col-span-full">スキルの読み込みに失敗しました。</p>';
          }
        }

        // 2. スキルの追加フォームイベントリスナー
        function addSkillsFormListener() {
          const form = document.getElementById('add-skills-form');
          const submitBtn = document.getElementById('submit-skills-btn');
          if (!form) return;

          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById("skill-title").value;
            const subtitle = document.getElementById("skill-subtitle").value;
            const icon = document.getElementById("skill-icon").value;
            const order = parseInt(document.getElementById("skill-order").value, 10);

            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            let dataToSave = {
              title: title,
              subtitle: subtitle,
              icon: icon,
              order: order,
              createdAt: serverTimestamp(),
            };

            try {
              if (selectedFileSkill) {
                const imagePath = `images/system/skills/${auth.currentUser.uid}/${Date.now()}_${selectedFileSkill.name}`;
                const imageUrl = await uploadImage(ref(storage, imagePath), selectedFileSkill, uploadProgressBarSkill);
                dataToSave.customIconUrl = imageUrl;
                dataToSave.customImagePath = imagePath;
                dataToSave.icon = ""; // カスタム画像優先
              }
              await addDoc(collection(db, "skills"), dataToSave);
              showMessage("スキル項目が正常に追加されました。");
              resetSkillsForm();
              loadSkills();
            } catch (error) {
              console.error("Error adding skill item: ", error);
              showMessage(`スキル項目の追加エラー: ${error.message}`, "error");
            } finally {
               if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="material-symbols-outlined">add</span> <span>スキル項目を追加する</span>';
              }
            }
          });
        }

        // スキル画像プレビュー
        if (imageInputSkill) {
          imageInputSkill.addEventListener("change", (e) => {
            selectedFileSkill = e.target.files[0];
            if (selectedFileSkill && imagePreviewSkill) {
              const reader = new FileReader();
              reader.onload = (event) => {
                imagePreviewSkill.src = event.target.result;
                imagePreviewSkill.classList.remove("hidden");
              };
              reader.readAsDataURL(selectedFileSkill);
            }
          });
        }


        // 3. フォームリセット
        function resetSkillsForm() {
          const form = document.getElementById('add-skills-form');
          if (form) form.reset();
          selectedFileSkill = null;
          if (imagePreviewSkill) imagePreviewSkill.classList.add('hidden');
          if (uploadProgressContainerSkill) uploadProgressContainerSkill.classList.add('hidden');
          if (uploadProgressBarSkill) uploadProgressBarSkill.style.width = '0%';
        }
        // 5. ★ 修正用画像プレビュー (NEW)
        // --- 18. パーソナル情報管理 (PersonalInfo CRUD) ---

        // 1. パーソナル情報の読み込み
        async function loadPersonalInfo() {
          if (!personalLoader || !personalListContainer) return;
          personalLoader.classList.remove("hidden");
          personalListContainer.innerHTML = "";
          personalListContainer.appendChild(personalLoader);

          try {
            const personalCol = collection(db, "personalInfo");
            const q = query(personalCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            personalLoader.classList.add("hidden");

            if (querySnapshot.empty) {
              personalListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだパーソナル情報がありません。</p>';
              return;
            }

            personalListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const item = docSnap.data();
              const itemId = docSnap.id;
              const itemEl = document.createElement("div");
              itemEl.className =
                "flex flex-col sm:flex-row items-start gap-4 p-4 bg-background-light dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700";
              itemEl.innerHTML = `
                <div class="flex-grow w-full">
                  <h3 class="text-lg font-bold">${item.title} <span class="text-sm text-text-muted-light">(表示順: ${item.order})</span></h3>
                  <p class="text-sm text-text-light dark:text-text-dark mt-1">${item.description.substring(0, 100)}...</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                  <button 
                    data-doc-id="${itemId}"
                    data-collection="personalInfo"
                    data-title="${encodeURIComponent(item.title || "")}"
                    data-description="${encodeURIComponent(item.description || "")}"
                    data-order="${item.order || 10}"
                    class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                    <span class="material-symbols-outlined !text-base">edit</span>
                    <span>修正</span>
                  </button>
                  <button data-doc-id="${itemId}" data-collection="personalInfo" data-image-path="" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                    <span class="material-symbols-outlined !text-base">delete</span>
                    <span>削除</span>
                  </button>
                </div>
              `;
              personalListContainer.appendChild(itemEl);
            });
          } catch (error) {
            console.error("Error loading personal info: ", error);
            showMessage(`パーソナル情報の読み込みエラー: ${error.message}`, "error");
            personalLoader.classList.add("hidden");
            personalListContainer.innerHTML = '<p class="text-center text-red-500">パーソナル情報の読み込みに失敗しました。</p>';
          }
        }

        // 2. パーソナル情報の追加フォームイベントリスナー
        function addPersonalFormListener() {
          if (!addPersonalForm) return;

          addPersonalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById("personal-title").value;
            const description = document.getElementById("personal-description").value;
            const order = parseInt(document.getElementById("personal-order").value, 10);

            if (submitPersonalBtn) {
              submitPersonalBtn.disabled = true;
              submitPersonalBtn.innerHTML = '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              await addDoc(collection(db, "personalInfo"), {
                title: title,
                description: description,
                order: order,
                createdAt: serverTimestamp(),
              });
              showMessage("パーソナル情報が正常に追加されました。");
              resetPersonalForm();
              loadPersonalInfo();
            } catch (error) {
              console.error("Error adding personal info: ", error);
              showMessage(`パーソナル情報の追加エラー: ${error.message}`, "error");
            } finally {
               if (submitPersonalBtn) {
                submitPersonalBtn.disabled = false;
                submitPersonalBtn.innerHTML = '<span class="material-symbols-outlined">add</span> <span>パーソナル情報を追加</span>';
              }
            }
          });
        }

        // 3. フォームリセット
        function resetPersonalForm() {
          if (addPersonalForm) addPersonalForm.reset();
        }

        // --- 19. お問い合わせ情報管理 (ContactInfo CRUD) ---

        // 1. お問い合わせ情報の読み込み
    async function loadContactInfo() {
          if (!contactLoader || !contactListContainer) return;
          contactLoader.classList.remove("hidden");
          contactListContainer.innerHTML = "";
          contactListContainer.appendChild(contactLoader);

          try {
            const contactCol = collection(db, "contactInfo");
            const q = query(contactCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            contactLoader.classList.add("hidden");

            if (querySnapshot.empty) {
          contactListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだお問い合わせ情報がありません。</p>';
          return;
        }

        contactListContainer.innerHTML = "";

        querySnapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const itemId = docSnap.id;
          const itemEl = document.createElement("div");
          itemEl.className = "flex flex-col sm:flex-row items-start gap-4 p-4 bg-background-light dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700";
          
          // アイコン表示ロジック
          let iconDisplay = '';
          if (item.customIconUrl) {
              iconDisplay = `<img src="${item.customIconUrl}" alt="${item.title}" class="w-8 h-8 object-contain">`;
          } else {
              iconDisplay = `<span class="material-symbols-outlined text-3xl text-primary">${item.icon || 'info'}</span>`;
          }

          itemEl.innerHTML = `
            <div class="flex-shrink-0">${iconDisplay}</div>
            <div class="flex-grow w-full">
              <h3 class="text-lg font-bold">${item.title} <span class="text-sm text-text-muted-light">(表示順: ${item.order})</span></h3>
              <p class="text-sm text-text-light dark:text-text-dark mt-1 whitespace-pre-wrap">${item.description}</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
              <button 
                data-doc-id="${itemId}" 
                data-collection="contactInfo" 
                data-title="${encodeURIComponent(item.title || '')}" 
                data-description="${encodeURIComponent(item.description || '')}" 
                data-icon="${item.icon || ''}" 
                data-image-url="${item.customIconUrl || ''}"
                data-image-path="${item.customImagePath || ''}"
                data-width="${item.width || 'w-full'}"
                data-align="${item.align || 'justify-start'}"
                data-order="${item.order || 10}" 
                class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">edit</span>
                <span>修正</span>
              </button>
              
              <button 
                data-type="contactInfo"
                data-title="${encodeURIComponent(item.title || '')}"
                data-description="${encodeURIComponent(item.description || '')}"
                data-icon="${item.icon || 'info'}"
                data-image-url="${item.customIconUrl || ''}"
                class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">code</span>
                <span>スニペット</span>
              </button>

              <button data-doc-id="${itemId}" data-collection="contactInfo" data-image-path="${item.customImagePath || ''}" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">delete</span>
                <span>削除</span>
              </button>
            </div>
          `;
          contactListContainer.appendChild(itemEl);
        });
      } catch (error) {
        console.error("Error loading contact info: ", error);
        showMessage(`お問い合わせ情報の読み込みエラー: ${error.message}`, "error");
        contactLoader.classList.add("hidden");
        contactListContainer.innerHTML = '<p class="text-center text-red-500">お問い合わせ情報の読み込みに失敗しました。</p>';
      }
        }
/**
     * 汎用スニペット生成関数
     * @param {Object} data - ボタンのdata属性から取得したオブジェクト
     * @returns {string} 生成されたHTMLコード
     */
    function generateGenericSnippet(data) {
      let snippetHtml = '';
      const type = data.type;

      // データのデコード処理
      const title = decodeURIComponent(data.title || '');
      const description = decodeURIComponent(data.description || '');
      const url = decodeURIComponent(data.url || '');
      const imageUrl = data.imageUrl || '';
      const icon = data.icon || 'info';

      // タイプ別の生成ロジック
      if (type === 'contactInfo') {
         // お問い合わせ情報用
         let iconHtml = '';
         if (imageUrl) {
             iconHtml = `<img src="${imageUrl}" alt="${title}" class="w-8 h-8 object-contain">`;
         } else {
             iconHtml = `<span class="material-symbols-outlined text-3xl text-primary">${icon}</span>`;
         }
         
         snippetHtml = `
<div class="flex items-start gap-4 p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
  <div class="flex-shrink-0 pt-1">${iconHtml}</div>
  <div>
    <h4 class="font-bold text-base text-slate-800 dark:text-slate-200 mb-1">${title}</h4>
    <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${description.replace(/\n/g, '<br>')}</p>
  </div>
</div>`;

      } else if (type === 'mediaBanner') {
         // バナー用
         snippetHtml = `
<a href="${url}" target="_blank" class="block w-full aspect-[3/2] rounded-xl overflow-hidden group relative transition-transform hover:scale-[1.02]">
  <img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover">
</a>`;

      } else if (type === 'mediaIcon') {
         // アイコンリンク用
         let iconDisplay = imageUrl ? `<img src="${imageUrl}" alt="${title}" class="w-12 h-12 object-contain">` : `<span class="material-symbols-outlined text-4xl text-primary">${icon}</span>`;
         snippetHtml = `
<a href="${url}" target="_blank" class="flex flex-col items-center gap-2 p-4 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors">
  ${iconDisplay}
  <span class="text-sm font-bold">${title}</span>
</a>`;

      } else if (type === 'bottomNavigation') {
         // ボトムナビ用スニペット
         let iconDisplay = imageUrl ? `<img src="${imageUrl}" alt="${title}" class="w-6 h-6 object-contain">` : `<span class="material-symbols-outlined text-2xl">${icon}</span>`;
         snippetHtml = `
<a href="${url}" class="flex flex-col items-center justify-center p-2 text-slate-500 hover:text-blue-500 transition-colors w-full">
  ${iconDisplay}
  <span class="text-xs mt-1 truncate max-w-full">${title}</span>
</a>`;

      } else {
         // その他（ブログ記事など）の汎用カード
         snippetHtml = `
<div class="flex flex-col md:flex-row items-center gap-6 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
  ${imageUrl ? `<div class="w-full md:w-1/3"><img src="${imageUrl}" alt="${title}" class="w-full h-auto rounded-lg object-cover aspect-video"></div>` : ''}
  <div class="flex-1">
    <h3 class="text-xl font-bold mb-2">${title}</h3>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-3">${description}</p>
    <a href="${url}" class="text-primary font-bold hover:underline inline-flex items-center gap-1">
      詳細を見る <span class="material-symbols-outlined text-sm">arrow_forward</span>
    </a>
  </div>
</div>`;
      }
      
      return snippetHtml.trim();
    }


        // 2. お問い合わせ情報の追加フォームイベントリスナー
        function addContactInfoFormListener() {
          // 要素の再取得（念のため）
          const addContactInfoForm = document.getElementById("add-contact-info-form");
          const submitContactBtn = document.getElementById("submit-contact-btn");

          if (!addContactInfoForm) return;

          addContactInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById("contact-title").value;
            const description = document.getElementById("contact-description").value;
            const icon = document.getElementById("contact-icon").value;
            const order = parseInt(document.getElementById("contact-order").value, 10);
            
            // ★ 追加: 画像ファイルを取得
            const imageInput = document.getElementById("contact-image");
            const file = imageInput ? imageInput.files[0] : null;

            if (submitContactBtn) {
              submitContactBtn.disabled = true;
              submitContactBtn.innerHTML = '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              let customIconUrl = "";
              let customImagePath = "";

              // ★ 追加: 画像があればアップロードを実行
              if (file) {
                 const userId = auth.currentUser.uid;
                 customImagePath = `images/system/contact/${userId}/${Date.now()}_${file.name}`;
                 const storageRef = ref(storage, customImagePath);
                 // プログレスバーはnull（表示なし）で実行
                 customIconUrl = await uploadImage(storageRef, file, null);
              }

              await addDoc(collection(db, "contactInfo"), {
                title: title,
                description: description,
                icon: icon,
                order: order,
                width: document.getElementById("contact-width").value,
                align: document.getElementById("contact-align").value,
                // ★ 追加: 画像情報を保存
                customIconUrl: customIconUrl,
                customImagePath: customImagePath,
                createdAt: serverTimestamp(),
              });

              showMessage("お問い合わせ情報が正常に追加されました。");
              addContactInfoForm.reset();
              loadContactInfo();
            } catch (error) {
              console.error("Error adding contact info: ", error);
              showMessage(`お問い合わせ情報の追加エラー: ${error.message}`, "error");
            } finally {
               if (submitContactBtn) {
                submitContactBtn.disabled = false;
                submitContactBtn.innerHTML = '<span class="material-symbols-outlined">add</span> <span>情報を追加</span>';
              }
            }
          });
        }

        // お問い合わせ情報画像プレビュー
        if (imageInputContact) {
          imageInputContact.addEventListener("change", (e) => {
            selectedFileContact = e.target.files[0];
            if (selectedFileContact && imagePreviewContact) {
              const reader = new FileReader();
              reader.onload = (event) => {
                imagePreviewContact.src = event.target.result;
                imagePreviewContact.classList.remove("hidden");
              };
              reader.readAsDataURL(selectedFileContact);
            }
          });
        }

        // スキル修正用画像プレビュー
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-skill-image") {
            editFileSkill = e.target.files[0];
            const preview = document.getElementById("edit-image-preview-skill");
            if (editFileSkill && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileSkill);
            }
          }
        });

        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-media-icon-image") {
            editFileMediaIcon = e.target.files[0];
            const preview = document.getElementById(
              "edit-image-preview-media-icon"
            );
            if (editFileMediaIcon && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileMediaIcon);
            }
          }
          if (e.target.id === "edit-contact-image") {
            editFileContact = e.target.files[0];
            const preview = document.getElementById("edit-image-preview-contact");
            if (editFileContact && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileContact);
            }
          }
        });
        
        // ボトムナビ画像プレビュー
        document.addEventListener("change", (e) => {
          if (e.target.id === "bottom-nav-image") {
            selectedFileBottomNav = e.target.files[0];
          }
          if (e.target.id === "edit-bottom-nav-image") {
            editFileBottomNav = e.target.files[0];
          }
        });


        // --- Firestore (メディア(バナー)) ロジック ---
        // --- 8. メディア(バナー)管理 (Media Banners CRUD) ---

        // 1. 読み込み
        async function loadMediaBanners() {
          if (!mediaBannersLoader || !mediaBannersListContainer) return;
          mediaBannersLoader.classList.remove("hidden");
          mediaBannersListContainer.innerHTML = "";
          mediaBannersListContainer.appendChild(mediaBannersLoader);
          try {
            const mediaBannersCol = collection(db, "mediaBanners");
            const q = query(mediaBannersCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            mediaBannersLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const mediaBannersCountDisplay = document.getElementById(
              "media-banners-count-display"
            );
            if (mediaBannersCountDisplay) {
              mediaBannersCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }

            if (querySnapshot.empty) {
              mediaBannersListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだバナーがありません。</p>';
              return;
            }

            mediaBannersListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const bannerData = docSnap.data();
              const bannerId = docSnap.id;
              const bannerEl = document.createElement("div");
              bannerEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              const animText =
                {
                  none: "なし",
                  pulse: "ゆっくり光る",
                  wiggle: "小さく揺れる",
                  squish: "ぺこぺこへこむ",
                  flash: "キラッと光る",
                  heartbeat: "ドキドキ鼓動",
                }[bannerData.animation] || "不明";

              bannerEl.innerHTML = `
              <img src="${
                bannerData.imageUrl
              }" alt="バナー画像" class="w-32 h-auto object-cover rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/600x400/cccccc/ffffff?text=No+Banner'; this.onerror=null;">
              <div class="flex-grow w-full">
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">表示順: ${
                  bannerData.order
                } | アニメ: ${animText}</p>
                ${
                  bannerData.url
                    ? `<a href="${bannerData.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline break-all">${bannerData.url}</a>`
                    : '<p class="text-sm text-text-muted-light">リンクなし</p>'
                }
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${bannerId}"
                  data-collection="mediaBanners"
                  data-url="${encodeURIComponent(bannerData.url || "")}"
                  data-order="${bannerData.order || "10"}"
                  data-animation="${bannerData.animation || "none"}"
                  data-image-url="${bannerData.imageUrl || ""}"
                  data-image-path="${bannerData.imagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-type="mediaBanner"
                  data-title="${encodeURIComponent(bannerData.title || 'バナー')}"
                  data-url="${encodeURIComponent(bannerData.url || '')}" 
                  data-image-url="${bannerData.imageUrl || ''}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>スニペット</span>
                </button>
                <button data-doc-id="${bannerId}" data-collection="mediaBanners" data-image-path="${
                bannerData.imagePath
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              mediaBannersListContainer.appendChild(bannerEl);
            });
          } catch (error) {
            console.error("Error loading media banners: ", error);
            showMessage(`バナーの読み込みエラー: ${error.message}`, "error");
            mediaBannersLoader.classList.add("hidden");
            mediaBannersListContainer.innerHTML =
              '<p class="text-center text-red-500">バナーの読み込みに失敗しました。</p>';
          }
        }

        // 2. 追加
        if (addMediaBannerForm) {
          addMediaBannerForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const url = document.getElementById("media-banner-url").value;
            const order = parseInt(
              document.getElementById("media-banner-order").value,
              10
            );
            const animation = document.getElementById(
              "media-banner-animation"
            ).value;

            if (!selectedFileMediaBanner) {
              showMessage("バナー画像は必須です。", "error");
              return;
            }

            if (submitMediaBannerBtn) {
              submitMediaBannerBtn.disabled = true;
              submitMediaBannerBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              const userId = auth.currentUser.uid;
              if (!userId) throw new Error("ユーザーが認証されていません。");
              const imagePath = `images/system/media_banners/${userId}/${Date.now()}_${
                selectedFileMediaBanner.name
              }`;
              const storageRef = ref(storage, imagePath);

              if (uploadProgressContainerMediaBanner)
                uploadProgressContainerMediaBanner.classList.remove("hidden");
              const imageUrl = await uploadImage(
                storageRef,
                selectedFileMediaBanner,
                uploadProgressBarMediaBanner
              );

              await addDoc(collection(db, "mediaBanners"), {
                url: url,
                order: order,
                animation: animation,
                imageUrl: imageUrl,
                imagePath: imagePath,
                createdAt: serverTimestamp(),
              });
              showMessage("メディア(バナー)が正常に追加されました。");
              resetMediaBannerForm();
              loadMediaBanners();
            } catch (error) {
              console.error("Error adding media banner: ", error);
              showMessage(`バナーの追加エラー: ${error.message}`, "error");
              resetMediaBannerForm();
            }
          });
        }

        // 3. フォームリセット
        function resetMediaBannerForm() {
          if (addMediaBannerForm) addMediaBannerForm.reset();
          selectedFileMediaBanner = null;
          if (imageInputMediaBanner) imageInputMediaBanner.value = "";
          if (imagePreviewMediaBanner) {
            imagePreviewMediaBanner.classList.add("hidden");
            imagePreviewMediaBanner.src = "";
          }
          if (uploadProgressContainerMediaBanner)
            uploadProgressContainerMediaBanner.classList.add("hidden");
          if (uploadProgressBarMediaBanner)
            uploadProgressBarMediaBanner.style.width = "0%";
          if (submitMediaBannerBtn) {
            submitMediaBannerBtn.disabled = false;
            submitMediaBannerBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>メディア(バナー)を追加する</span>';
          }
        }

        // 4. 画像プレビュー
        if (imageInputMediaBanner) {
          imageInputMediaBanner.addEventListener("change", (e) => {
            selectedFileMediaBanner = e.target.files[0];
            if (selectedFileMediaBanner) {
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (selectedFileMediaBanner.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは5MB以下にしてください。",
                  "error"
                );
                selectedFileMediaBanner = null;
                if (imageInputMediaBanner) imageInputMediaBanner.value = "";
                if (imagePreviewMediaBanner) {
                  imagePreviewMediaBanner.classList.add("hidden");
                  imagePreviewMediaBanner.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewMediaBanner) {
                  imagePreviewMediaBanner.src = event.target.result;
                  imagePreviewMediaBanner.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileMediaBanner);
              if (uploadProgressContainerMediaBanner)
                uploadProgressContainerMediaBanner.classList.add("hidden");
            } else {
              selectedFileMediaBanner = null;
              if (imagePreviewMediaBanner) {
                imagePreviewMediaBanner.classList.add("hidden");
                imagePreviewMediaBanner.src = "";
              }
            }
          });
        }

        // 5. ★ 修正用画像プレビュー (NEW)
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-media-banner-image") {
            editFileMediaBanner = e.target.files[0];
            const preview = document.getElementById(
              "edit-image-preview-media-banner"
            );
            if (editFileMediaBanner && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileMediaBanner);
            }
          }
        });

        // --- ★ Firestore (ブログ・HP) ロジック (NEW) ★ ---
        // --- 9. ブログ・HP管理 (Sites CRUD) ---

        // 1. 読み込み
        async function loadSites() {
          if (!sitesLoader || !sitesListContainer) return;
          sitesLoader.classList.remove("hidden");
          sitesListContainer.innerHTML = "";
          sitesListContainer.appendChild(sitesLoader);
          try {
            const sitesCol = collection(db, "sites");
            const q = query(sitesCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            sitesLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const sitesCountDisplay = document.getElementById(
              "sites-count-display"
            );
            if (sitesCountDisplay) {
              sitesCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }

            if (querySnapshot.empty) {
              sitesListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだブログ・HPがありません。</p>';
              return;
            }

            sitesListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const siteData = docSnap.data();
              const siteId = docSnap.id;
              const siteEl = document.createElement("div");
              siteEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              let iconHtml = "";
              if (siteData.customIconUrl) {
                iconHtml = `<img src="${siteData.customIconUrl}" alt="${siteData.title}" class="w-10 h-10 object-contain rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/64x64/cccccc/ffffff?text=Icon'; this.onerror=null;">`;
              } else {
                iconHtml = `<span class="material-symbols-outlined text-3xl text-primary w-10 h-10 flex items-center justify-center flex-shrink-0">${
                  siteData.iconName || "link"
                }</span>`;
              }

              siteEl.innerHTML = `
              ${iconHtml}
              <div class="flex-grow w-full">
                <h3 class="text-lg font-bold">${
                  siteData.title
                } <span class="text-sm text-text-muted-light"> (表示順: ${
                siteData.order
              })</span></h3>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${
                  siteData.description
                }</p>
                <a href="${
                  siteData.url
                }" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline break-all">${
                siteData.url
              }</a>
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${siteId}"
                  data-collection="sites"
                  data-title="${encodeURIComponent(siteData.title || "")}"
                  data-description="${encodeURIComponent(
                    siteData.description || ""
                  )}"
                  data-url="${encodeURIComponent(siteData.url || "")}"
                  data-order="${siteData.order || "10"}"
                  data-icon-name="${siteData.iconName || "link"}"
                  data-image-url="${siteData.customIconUrl || ""}"
                  data-image-path="${siteData.customImagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-type="site"
                  data-title="${encodeURIComponent(siteData.title || '')}"
                  data-url="${encodeURIComponent(siteData.url || '')}" 
                  data-image-url="${siteData.customIconUrl || ''}"
                  data-description="${encodeURIComponent(siteData.description || '')}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>スニペット</span>
                </button>
                <button data-doc-id="${siteId}" data-collection="sites" data-image-path="${
                siteData.customImagePath || ""
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              sitesListContainer.appendChild(siteEl);
            });
          } catch (error) {
            console.error("Error loading sites: ", error);
            showMessage(
              `ブログ・HPの読み込みエラー: ${error.message}`,
              "error"
            );
            sitesLoader.classList.add("hidden");
            sitesListContainer.innerHTML =
              '<p class="text-center text-red-500">ブログ・HPの読み込みに失敗しました。</p>';
          }
        }

        // 2. 追加
        if (addSiteForm) {
          addSiteForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("site-title").value;
            const description =
              document.getElementById("site-description").value;
            const url = document.getElementById("site-url").value;
            const order = parseInt(
              document.getElementById("site-order").value,
              10
            );
            const iconName = document.getElementById("site-icon-name").value;

            if (submitSiteBtn) {
              submitSiteBtn.disabled = true;
              submitSiteBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              let customIconUrl = "";
              let customImagePath = "";
              let finalIconName = iconName;

              if (selectedFileSite) {
                const userId = auth.currentUser.uid;
                if (!userId) throw new Error("ユーザーが認証されていません。");
                customImagePath = `images/system/sites/${userId}/${Date.now()}_${
                  selectedFileSite.name
                }`;
                const storageRef = ref(storage, customImagePath);

                if (uploadProgressContainerSite)
                  uploadProgressContainerSite.classList.remove("hidden");
                customIconUrl = await uploadImage(
                  storageRef,
                  selectedFileSite,
                  uploadProgressBarSite
                );
                finalIconName = ""; // カスタム画像優先
              }

              await addDoc(collection(db, "sites"), {
                title: title,
                description: description,
                url: url,
                order: order,
                iconName: finalIconName,
                customIconUrl: customIconUrl,
                customImagePath: customImagePath,
                createdAt: serverTimestamp(),
              });
              showMessage("ブログ・HPが正常に追加されました。");
              resetSiteForm();
              loadSites();
            } catch (error) {
              console.error("Error adding site: ", error);
              showMessage(`ブログ・HPの追加エラー: ${error.message}`, "error");
              resetSiteForm();
            }
          });
        }

        // 3. フォームリセット
        function resetSiteForm() {
          if (addSiteForm) addSiteForm.reset();
          selectedFileSite = null;
          if (imageInputSite) imageInputSite.value = "";
          if (imagePreviewSite) {
            imagePreviewSite.classList.add("hidden");
            imagePreviewSite.src = "";
          }
          if (uploadProgressContainerSite)
            uploadProgressContainerSite.classList.add("hidden");
          if (uploadProgressBarSite) uploadProgressBarSite.style.width = "0%";
          if (submitSiteBtn) {
            submitSiteBtn.disabled = false;
            submitSiteBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>ブログ・HPを追加する</span>';
          }
        }

        // 4. 画像プレビュー
        if (imageInputSite) {
          imageInputSite.addEventListener("change", (e) => {
            selectedFileSite = e.target.files[0];
            if (selectedFileSite) {
              const maxSize = 2 * 1024 * 1024; // 2MB
              if (selectedFileSite.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは2MB以下にしてください。",
                  "error"
                );
                selectedFileSite = null;
                if (imageInputSite) imageInputSite.value = "";
                if (imagePreviewSite) {
                  imagePreviewSite.classList.add("hidden");
                  imagePreviewSite.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewSite) {
                  imagePreviewSite.src = event.target.result;
                  imagePreviewSite.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileSite);
              if (uploadProgressContainerSite)
                uploadProgressContainerSite.classList.add("hidden");
            } else {
              selectedFileSite = null;
              if (imagePreviewSite) {
                imagePreviewSite.classList.add("hidden");
                imagePreviewSite.src = "";
              }
            }
          });
        }

        // 5. ★ 修正用画像プレビュー (NEW)
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-site-image") {
            editFileSite = e.target.files[0];
          } else if (e.target.id === "edit-dynamic-image") { // ★ NEW: 動的ブログの画像変更
            editFileDynamic = e.target.files[0];
            const preview = document.getElementById("edit-image-preview-site");
            if (editFileSite && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileSite);
            }
            const dynamicPreview = document.getElementById("edit-image-preview-dynamic");
            if (editFileDynamic && dynamicPreview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                dynamicPreview.src = event.target.result;
                dynamicPreview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileDynamic);
            }
          }
          // ★★★ ボトムナビ編集用画像プレビューの処理 (NEW) ★★★
          if (e.target.id === "edit-bottom-nav-image") {
              editFileBottomNav = e.target.files[0]; // グローバル変数にファイルをセット
              const preview = document.getElementById("edit-image-preview-bottom-nav");
              if (editFileBottomNav && preview) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      preview.src = event.target.result;
                      preview.classList.remove("hidden");
                  };
                  reader.readAsDataURL(editFileBottomNav);
              }
          }

        });

        // --- 10. グローバル削除・修正ロジック ---

        // 1. グローバルなクリックイベント（削除と修正ボタン）
        if (dashboardSection) {
          dashboardSection.addEventListener("click", async (e) => {
            // --- 削除処理 ---
            const deleteButton = e.target.closest(".delete-btn");
            if (deleteButton) {
              e.stopPropagation(); // 念のため

              const docId = deleteButton.dataset.docId;
              const collectionName = deleteButton.dataset.collection;
              const imagePath = deleteButton.dataset.imagePath || "";

              if (!docId || !collectionName) {
                showMessage(
                  "削除対象のIDまたはコレクションが不明です。",
                  "error"
                );
                return;
              }

              // ★ 削除確認 (修復)
              if (
                !confirm(
                  `「${docId}」を ${collectionName} から本当に削除しますか？\nこの操作は元に戻せません。`
                )
              ) {
                return;
              }

              deleteButton.disabled = true;
              deleteButton.innerHTML =
                '<div class="loader !w-5 !h-5 !border-t-white !border-slate-200/50"></div> <span>削除中...</span>';

              try {
                // 1. Firestoreからドキュメントを削除 (修復)
                await deleteDoc(doc(db, collectionName, docId));

                // 2. Storageから関連画像を削除 (修復)
                if (imagePath) {
                  try {
                    await deleteObject(ref(storage, imagePath));
                  } catch (imgErr) {
                    // 画像削除の失敗は警告に留め、処理は続行
                    console.warn(
                      `画像削除に失敗しました (Path: ${imagePath}):`,
                      imgErr
                    );
                  }
                }

                // 3. UIの更新 (修復 + Phase 6-2 追加)
                if (collectionName === "sitemapEntries") {
                  // (サイトマップのみ、ボタンを即時置換)
                  const buttonContainer = deleteButton.parentElement;
                  if (buttonContainer) {
                    const title = deleteButton.dataset.title || "";
                    const path = deleteButton.dataset.docId || ""; // docId = path
                    const registerButtonHtml = `
                    <button 
                      data-path="${path}"
                      data-title="${title}"
                      class="add-sitemap-btn flex-shrink-0 py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center gap-1">
                      <span class="material-symbols-outlined !text-base">add</span>
                      <span>DBに登録</span>
                    </button>
                  `;
                    buttonContainer.innerHTML = registerButtonHtml;
                  }
                } else {
                  // (sitemapEntries 以外は、一覧をリロード)
                  if (collectionName === "articles") {
                    loadArticles();
                  } else if (collectionName === "books") {
                    loadBooks();
                  } else if (collectionName === "mediaIcons") {
                    loadMediaIcons();
                  } else if (collectionName === "mediaBanners") {
                    loadMediaBanners();
                  } else if (collectionName === "sites") {
                    loadSites();
                  } else if (collectionName === "personalInfo") {
                    loadPersonalInfo();
                  } else if (collectionName === "contactInfo") {
                    loadContactInfo();
                  } else if (collectionName === "navigation") {
                    loadNavigation();
                  } else if (collectionName === "blogCategories") {
                    loadBlogCategories();
                  } else if (collectionName === "blogContents") {
                    loadDynamicBlogs();
                  } else if (collectionName === "blogPosts") {
                    loadBlogPosts();
                  } else if (collectionName === "bottomNavigation") {
                    // ★ Phase 6-2 追加
                    loadBottomNavigation();
                  }
                }

                showMessage("項目を削除しました。"); // (修復)
              } catch (error) {
                // (修復)
                console.error(`Error deleting ${collectionName}: `, error);
                showMessage(`削除エラー: ${error.message}`, "error");
                deleteButton.disabled = false;
                deleteButton.innerHTML =
                  '<span class="material-symbols-outlined !text-base">delete</span> <span>削除</span>';
              }
            } // --- 削除処理 終わり ---

            // --- 修正処理 (モーダルを開く) ---
            const editButton = e.target.closest(".edit-btn");
            if (editButton) {
              e.stopPropagation(); // 念のため
              const data = { ...editButton.dataset }; // データ属性をコピー

              // URLデコード
              Object.keys(data).forEach((key) => {
                if (["title", "description", "url", "content", "buttonText"].includes(key)) { // ★ buttonTextを追加
                  try {
                    data[key] = decodeURIComponent(data[key]);
                  } catch (e) {
                    console.warn(
                      `Error decoding data key ${key}:`,
                      data[key],
                      e
                    );
                    data[key] = data[key]; // デコード失敗時はそのまま
                  }
                }
              });
              openEditModal(data);
            } // --- 修正処理 終わり ---

            // --- 単冊スニペット取得処理 ---
            // --- 単冊スニペット取得処理 ---
            const getSnippetButton = e.target.closest(".get-snippet-btn");
            if (getSnippetButton && getSnippetButton.dataset.type === "bookSnippet") {
              e.stopPropagation();

              try {
                // data属性から情報を取得・デコード
                const data = { ...getSnippetButton.dataset };
                const title = decodeURIComponent(data.title || '');
                const url = decodeURIComponent(data.url || '');
                const description = decodeURIComponent(data.description || '');
                const imageUrl = data.imageUrl || '';
                const starRating = parseInt(data.starRating, 10) || 5; 
                const buttonText = decodeURIComponent(data.buttonText || '');
                const openNewTab = data.openNewTab === 'true';

                const bookData = {
                  title: title,
                  url: url,
                  description: description,
                  imageUrl: imageUrl,
                  starRating: starRating,
                  buttonText: buttonText,
                  openNewTab: openNewTab
                };

                // スニペットコードを生成
                const snippetCode = generateSingleBookSnippet(bookData);

                // モーダルに表示
                if (snippetCodeArea && snippetModal) {
                  snippetCodeArea.value = snippetCode.trim();
                  snippetModal.classList.remove("hidden");
                  if (copyMessage) copyMessage.classList.add("hidden");
                }

              } catch (err) {
                console.error('Failed to generate snippet: ', err);
                showMessage(`スニペット生成エラー: ${err.message}`, "error");
              }
            } // --- 単冊スニペット取得処理 終わり ---

            // --- 汎用スニペット取得処理 ---
            // --- 汎用スニペット取得処理 ---
            const genericSnippetBtn = e.target.closest(".get-snippet-btn");
            if (genericSnippetBtn && genericSnippetBtn.dataset.type !== "bookSnippet") {
              e.stopPropagation();
              const data = { ...genericSnippetBtn.dataset };
              // 必要なデータをデコード
              Object.keys(data).forEach(key => {
                if (['title', 'url', 'description'].includes(key)) {
                  data[key] = decodeURIComponent(data[key] || '');
                }
              });
              const snippetCode = generateGenericSnippet(data);
              showSnippetModal(snippetCode);
            }


            // --- サイトマップ登録処理 (Phase 3-3 統合) ---
            const addSitemapButton = e.target.closest(".add-sitemap-btn");
            if (addSitemapButton) {
              e.stopPropagation();
              const path = addSitemapButton.dataset.path;
              let title = addSitemapButton.dataset.title;

              // URLデコード
              try {
                title = decodeURIComponent(title);
              } catch (err) {
                console.warn(`Error decoding title:`, title, err);
              }

              addSitemapButton.disabled = true;
              addSitemapButton.innerHTML = "登録中...";

              await addSitemapEntry(path, title); // ★ 2616行目で定義済みの関数を呼び出す
            }
          });
        }

        // 2. 修正モーダルを開く関数
        function openEditModal(data) {
          if (!editModal || !editFormContent) return;

          // グローバル変数をリセット
          editFileArticle = null;
          editFileBook = null;
          editFileMediaIcon = null;
          editFileMediaBanner = null;
          editFileSite = null;
          currentEditCollection = data.collection;
          currentEditDocId = data.docId;
          currentEditOldImagePath = data.imagePath || "";

          // フォームの中身を一度クリア
          editFormContent.innerHTML = "";

          let template;

          try {
            // 適切なテンプレートを選択
            switch (data.collection) {
              case "articles":
                editModalTitle.textContent = "お知らせを修正";
                template = templateArticle.cloneNode(true);

                // ★ 修正点: appendChild の「前」に、`template.querySelector` で「中」の要素に値をセット
                template.querySelector("#edit-article-id").value = data.docId;
                template.querySelector("#edit-article-imagePath").value =
                  data.imagePath;
                template.querySelector("#edit-article-title").value =
                  data.title;
                template.querySelector("#edit-article-date").value = data.date;
                template.querySelector("#edit-article-category").value =
                  data.category;
                template.querySelector("#edit-article-content").value =
                  data.content;
                template.querySelector("#edit-image-preview-article").src =
                  data.imageUrl || "";
                template
                  .querySelector("#edit-image-preview-article")
                  .classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-article-image").value = ""; // ファイル入力をリセット

                // ★ 修正点: 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              case "books":
                  editModalTitle.textContent = "書籍を修正";
                  template = templateBook.cloneNode(true);

                  // ★ 修正点: appendChild の「前」に、`template.querySelector` で「中」の要素に値をセット
                  template.querySelector("#edit-book-id").value = data.docId;
                  template.querySelector("#edit-book-imagePath").value =
                    data.imagePath;
                  template.querySelector("#edit-book-title").value = data.title;
                  template.querySelector("#edit-book-url").value = data.url || "";
                  template.querySelector("#edit-book-button-text").value = data.buttonText || "詳細を見る";
                  template.querySelector("#edit-book-open-new-tab").checked = data.openNewTab === 'true'; // data属性は文字列なので比較
                  template.querySelector("#edit-book-description").value =
                    data.description;
                  template.querySelector("#edit-book-fixed").checked = data.fixed === 'true'; // data属性は文字列なので比較
                  template.querySelector("#edit-book-fixed-on-media").checked = data.fixedOnMedia === 'true';
                  template.querySelector("#edit-book-show-in-snippet").checked = data.showInSnippet === 'true';
                  template.querySelector("#edit-book-order").value = data.order;
                  template.querySelector("#edit-book-star-rating").value = data.starRating;
                  template.querySelector("#edit-image-preview-book").src =
                    data.imageUrl || "";
                  template
                    .querySelector("#edit-image-preview-book")
                    .classList.toggle("hidden", !data.imageUrl);
                  template.querySelector("#edit-book-image").value = "";

                // ★ 修正点: 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              case "mediaIcons":
                editModalTitle.textContent = "メディア(アイコン)を修正";
                template = templateMediaIcon.cloneNode(true);

                // ★ 修正点: appendChild の「前」に、`template.querySelector` で「中」の要素に値をセット
                template.querySelector("#edit-media-icon-id").value =
                  data.docId;
                template.querySelector("#edit-media-icon-imagePath").value =
                  data.imagePath;
                template.querySelector("#edit-media-icon-title").value =
                  data.title;
                template.querySelector("#edit-media-icon-description").value =
                  data.description;
                template.querySelector("#edit-media-icon-url").value = data.url;
                template.querySelector("#edit-media-icon-order").value =
                  data.order;
                template.querySelector("#edit-media-icon-name").value =
                  data.iconName;
                template.querySelector("#edit-image-preview-media-icon").src =
                  data.imageUrl || "";
                template
                  .querySelector("#edit-image-preview-media-icon")
                  .classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-media-icon-image").value = "";

                // ★ 修正点: 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              case "mediaBanners":
                editModalTitle.textContent = "メディア(バナー)を修正";
                template = templateMediaBanner.cloneNode(true);

                // ★ 修正点: appendChild の「前」に、`template.querySelector` で「中」の要素に値をセット
                template.querySelector("#edit-media-banner-id").value =
                  data.docId;
                template.querySelector("#edit-media-banner-imagePath").value =
                  data.imagePath;
                template.querySelector("#edit-media-banner-url").value =
                  data.url;
                template.querySelector("#edit-media-banner-order").value =
                  data.order;
                template.querySelector("#edit-media-banner-animation").value =
                  data.animation;
                template.querySelector("#edit-image-preview-media-banner").src =
                  data.imageUrl || "";
                template
                  .querySelector("#edit-image-preview-media-banner")
                  .classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-media-banner-image").value = "";

                // ★ 修正点: 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              case "sites":
                editModalTitle.textContent = "ブログ・HPを修正";
                template = templateSite.cloneNode(true);

                // appendChild の「前」に、`template.querySelector` で「中」の要素を探す
                template.querySelector("#edit-site-id").value = data.docId;
                template.querySelector("#edit-site-imagePath").value =
                  data.imagePath;
                template.querySelector("#edit-site-title").value = data.title;
                template.querySelector("#edit-site-description").value =
                  data.description;
                template.querySelector("#edit-site-url").value = data.url;
                template.querySelector("#edit-site-order").value = data.order;
                template.querySelector("#edit-site-icon-name").value =
                  data.iconName;
                template.querySelector("#edit-image-preview-site").src =
                  data.imageUrl || "";
                template
                  .querySelector("#edit-image-preview-site")
                  .classList.toggle("hidden", !data.imageUrl);

                // ★★★ (修正 3/3) 根本原因のバグ修正 ★★★
                // id を '#edit-site-image' から '#edit-site-icon-image' に修正
                template.querySelector("#edit-site-icon-image").value = "";

                // 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              case "personalInfo":
                editModalTitle.textContent = "パーソナル情報を修正";
                template = templatePersonalInfo.cloneNode(true);

                template.querySelector("#edit-personal-id").value = data.docId;
                template.querySelector("#edit-personal-title").value = data.title;
                template.querySelector("#edit-personal-description").value = data.description;
                template.querySelector("#edit-personal-order").value = data.order;

                editFormContent.appendChild(template);
                break;

              case "skills":
                editModalTitle.textContent = "スキル項目を修正";
                template = document.getElementById("edit-form-template-skills").cloneNode(true);

                template.querySelector("#edit-skill-id").value = data.docId;
                template.querySelector("#edit-skill-imagePath").value = data.imagePath;
                template.querySelector("#edit-skill-title").value = data.title;
                template.querySelector("#edit-skill-subtitle").value = data.subtitle;
                template.querySelector("#edit-skill-icon").value = data.icon;
                template.querySelector("#edit-skill-order").value = data.order;

                const previewSkill = template.querySelector("#edit-image-preview-skill");
                previewSkill.src = data.imageUrl || "";
                previewSkill.classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-skill-image").value = "";

                editFormContent.appendChild(template);
                break;

              case "contactInfo":
                editModalTitle.textContent = "お問い合わせ情報を修正";
                template = templateContactInfo.cloneNode(true);

                template.querySelector("#edit-contact-id").value = data.docId;
                template.querySelector("#edit-contact-title").value = data.title;
                template.querySelector("#edit-contact-description").value = data.description;
                template.querySelector("#edit-contact-icon").value = data.icon;
                template.querySelector("#edit-contact-order").value = data.order;
                template.querySelector("#edit-contact-width").value =
                  data.width || "w-full";
                template.querySelector("#edit-contact-align").value =
                  data.align || "justify-start";

                // 画像プレビュー
                const previewContact = template.querySelector("#edit-image-preview-contact");
                previewContact.src = data.imageUrl || "";
                previewContact.classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-contact-image").value = "";

                editFormContent.appendChild(template);
                break;

              case "bottomNavigation":
                editModalTitle.textContent = "ボトムナビ項目を修正";
                template = templateBottomNavigation.cloneNode(true);

                template.querySelector("#edit-bottom-nav-id").value = data.docId;
                template.querySelector("#edit-bottom-nav-title").value = data.title;
                template.querySelector("#edit-bottom-nav-url").value = data.url;
                template.querySelector("#edit-bottom-nav-icon").value = data.iconName;
                template.querySelector("#edit-bottom-nav-order").value = data.order;
                
                // 画像プレビュー
                const previewBottomNav = template.querySelector("#edit-image-preview-bottom-nav");
                if (previewBottomNav) {
                  previewBottomNav.src = data.imageUrl || "";
                  previewBottomNav.classList.toggle("hidden", !data.imageUrl);
                }
                const imageInput = template.querySelector("#edit-bottom-nav-image");
                if (imageInput) imageInput.value = "";

                // パスを保持
                template.querySelector("#edit-bottom-nav-imagePath").value = data.imagePath || "";

                editFormContent.appendChild(template);
                break;

              case "blogContents":
                editModalTitle.textContent = "動的ブログ記事を修正";
                template = document.getElementById("edit-form-template-blogContents").cloneNode(true);

                // ★ プレビューボタンのイベント設定 (修正モーダル用)
                const previewBtn = template.querySelector("#edit-preview-dynamic-blog-btn");
                if (previewBtn) {
                    previewBtn.addEventListener("click", async () => {
                        const title = template.querySelector("#edit-dynamic-title").value;
                        const fileInput = template.querySelector("#edit-dynamic-image");
                        const imgPreview = template.querySelector("#edit-image-preview-dynamic");
                        
                        let imageHtml = '';
                        
                        // 画像処理: 新規ファイル優先、なければ既存画像
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                           const file = fileInput.files[0];
                           const reader = new FileReader();
                           const base64 = await new Promise(resolve => {
                               reader.onload = (e) => resolve(e.target.result);
                               reader.readAsDataURL(file);
                           });
                           imageHtml = `<img src="${base64}" class="w-full h-auto max-h-96 object-cover rounded-lg mb-8">`;
                        } else if (imgPreview && !imgPreview.classList.contains('hidden') && imgPreview.src) {
                           imageHtml = `<img src="${imgPreview.src}" class="w-full h-auto max-h-96 object-cover rounded-lg mb-8">`;
                        }

                        // HTMLブロック収集
                        const contentBlocks = [];
                        const textareas = template.querySelectorAll('.dynamic-html-block');
                        textareas.forEach(textarea => {
                            contentBlocks.push(textarea.value);
                        });

                        // HTML構築
                        const fullHtml = `
                          <div class="container mx-auto max-w-3xl p-8 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200">
                            <h1 class="text-3xl font-bold mb-4">${title}</h1>
                            ${imageHtml}
                            <div class="prose prose-lg dark:prose-invert max-w-none">
                              ${contentBlocks.join('')}
                            </div>
                          </div>
                        `;
                        
                        localStorage.setItem('snippetPreviewCode', fullHtml);
                        window.open('preview.html', '_blank');
                    });
                }

                // 基本データの設定
                template.querySelector("#edit-dynamic-id").value = data.docId;
                template.querySelector("#edit-dynamic-title").value = data.title;
                template.querySelector("#edit-dynamic-imagePath").value = data.imagePath;

                // HTMLブロックの展開
                const blocksContainer = template.querySelector("#edit-html-blocks-container");
                if (blocksContainer && data.contentBlocks) {
                  try {
                    const contentBlocks = JSON.parse(decodeURIComponent(data.contentBlocks));
                    if (Array.isArray(contentBlocks)) {
                      contentBlocks.forEach(htmlContent => {
                        const blockDiv = document.createElement('div');
                        blockDiv.className = 'html-block-wrapper border border-slate-300 dark:border-slate-600 p-4 rounded-lg space-y-2';
                        blockDiv.innerHTML = `
                          <textarea class="dynamic-html-block mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary font-mono text-sm" rows="10">${htmlContent}</textarea>
                          <button type="button" class="delete-block-btn py-1 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-xs flex items-center gap-1">
                            <span class="material-symbols-outlined !text-sm">delete</span>
                            <span>このブロックを削除</span>
                          </button>
                        `;
                        blocksContainer.appendChild(blockDiv);
                      });
                    }
                  } catch (e) {
                    console.error("Error parsing contentBlocks:", e);
                    showMessage("記事本文の解析に失敗しました。", "error");
                  }
                }

                // 画像プレビュー
                const imagePreview = template.querySelector("#edit-image-preview-dynamic");
                if (imagePreview) {
                  imagePreview.src = data.imageUrl || "";
                  imagePreview.classList.toggle("hidden", !data.imageUrl);
                }

                // イベントリスナーの設定
                template.querySelector("#edit-add-html-block-btn").addEventListener('click', () => {
                  const newBlockDiv = document.createElement('div');
                  newBlockDiv.className = 'html-block-wrapper border border-slate-300 dark:border-slate-600 p-4 rounded-lg space-y-2';
                  newBlockDiv.innerHTML = `
                    <textarea class="dynamic-html-block mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary font-mono text-sm" rows="10" placeholder="新しいHTMLブロック..."></textarea>
                    <button type="button" class="delete-block-btn py-1 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-xs flex items-center gap-1">
                      <span class="material-symbols-outlined !text-sm">delete</span>
                      <span>このブロックを削除</span>
                    </button>
                  `;
                  blocksContainer.appendChild(newBlockDiv);
                });

                blocksContainer.addEventListener('click', (e) => {
                  if (e.target.closest('.delete-block-btn')) {
                    e.target.closest('.html-block-wrapper').remove();
                  }
                });

                editFormContent.appendChild(template);
                break;

              case "navigation":
                editModalTitle.textContent = "メニュー項目を修正";
                template = templateNavigation.cloneNode(true);

                // appendChild の「前」に、`template.querySelector` で「中」の要素を探す
                template.querySelector("#edit-nav-id").value = data.docId;
                template.querySelector("#edit-nav-title").value = data.title;
                template.querySelector("#edit-nav-url").value = data.url;
                template.querySelector("#edit-nav-order").value = data.order;

                // 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              /* --- 8. ブログ記事メタデータ (P2) --- */
              // ★★★ P2-Rework: 唯一の正しい blogPosts ブロック ★★★
              case "blogPosts":
                editModalTitle.textContent = "ブログ記事メタを修正";
                // (HTML型枠は 1021行目 で修正済み)
                template = templateBlogPost.cloneNode(true);

                // appendChild の「前」に、`template.querySelector` で「中」の要素を探す
                template.querySelector("#edit-blog-post-id").value = data.docId;
                template.querySelector("#edit-blog-post-imagePath").value =
                  data.imagePath;
                template.querySelector("#edit-blog-post-title").value =
                  data.title;
                template.querySelector("#edit-blog-post-url").value = data.url;
                template.querySelector("#edit-blog-post-description").value =
                  data.description;

                // ★ P2-Rework: ドロップダウンに値を設定
                // (loadBlogCategoriesが型枠に<option>を事前-移入済み)
                const editSelect = template.querySelector(
                  "#edit-blog-post-category-select"
                );
                if (editSelect) {
                  // 既存のカテゴリー（デコード済み）を選択状態にする
                  editSelect.value = data.category;
                } else {
                  // 万が一、型枠の <select> が見つからなかった場合（エラー防止）
                  console.error(
                    "edit-blog-post-category-select が見つかりません。HTML型枠を確認してください。"
                  );
                }

                template.querySelector("#edit-blog-post-order").value =
                  data.order;

                // ★ NEW: 新しいタブで開くチェックボックスの状態を設定
                const editOpenNewTab = template.querySelector(
                  "#edit-blog-post-open-new-tab"
                );
                if (editOpenNewTab) {
                  // data-open-new-tab が true ('true'という文字列) の場合にチェックを入れる
                  editOpenNewTab.checked = data.openNewTab === "true";
                }

                template.querySelector("#edit-image-preview-blog-post").src =
                  data.imageUrl || "";
                template
                  .querySelector("#edit-image-preview-blog-post")
                  .classList.toggle("hidden", !data.imageUrl);
                template.querySelector("#edit-blog-post-image").value = ""; // ファイル入力をリセット

                // 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              // --- 8. サイトマップ項目 (Phase 3-3) ---
              case "sitemapEntries":
                editModalTitle.textContent = "サイトマップ項目を修正";
                // ★ Phase 3-3 (機能追加 1/4) で追加したDOM ID
                template = document
                  .getElementById("edit-form-template-sitemapEntries")
                  .cloneNode(true);

                // appendChild の「前」に、`template.querySelector` で「中」の要素を探す
                template.querySelector("#edit-sitemap-id").value = data.docId; // (docId = path)
                template.querySelector("#edit-sitemap-title").value =
                  data.title;
                template.querySelector("#edit-sitemap-path").value = data.path;

                // 最後に appendChild する
                editFormContent.appendChild(template);
                break;

              // --- 9. 登録リンク (NEW) ---
              case "savedLinks":
                editModalTitle.textContent = "登録リンクを修正";
                template = templateSavedLink.cloneNode(true);

                template.querySelector("#edit-saved-link-id").value = data.docId;
                template.querySelector("#edit-saved-link-title").value = data.title;
                template.querySelector("#edit-saved-link-url").value = data.url;
                template.querySelector("#edit-saved-link-memo").value = data.memo || "";

                editFormContent.appendChild(template);
                break;



              default:
                throw new Error(`不明なコレクションです: ${data.collection}`);
            }

            // モーダルを表示
            editModal.classList.remove("hidden");
            setTimeout(() => {
              const modalContent = editModal.querySelector(".modal-content");
              if (modalContent) {
                modalContent.classList.remove("scale-95", "opacity-0");
                modalContent.classList.add("scale-100", "opacity-100");
              }
            }, 10); // 描画直後にアニメーション開始
          } catch (error) {
            console.error("Error opening edit modal:", error, data);
            showMessage(
              `編集ウィンドウを開けません: ${error.message}`,
              "error"
            );
          }
        }

        // 3. モーダルを閉じる
        function closeEditModal() {
          if (editModal) {
            const modalContent = editModal.querySelector(".modal-content");
            if (modalContent) {
              modalContent.classList.add("scale-95", "opacity-0");
              modalContent.classList.remove("scale-100", "opacity-100");
            }
            setTimeout(() => {
              editModal.classList.add("hidden");
              // 中身を空にしておく
              if (editFormContent) editFormContent.innerHTML = "";
            }, 300); // アニメーション時間
          }
        }

        if (closeModalBtn) {
          closeModalBtn.addEventListener("click", closeEditModal);
        }
        if (cancelModalBtn) {
          cancelModalBtn.addEventListener("click", closeEditModal);
        }
        if (modalOverlay) {
          modalOverlay.addEventListener("click", closeEditModal);
        }

        // 4. 修正フォームの共通送信処理
        if (editForm) {
          editForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!currentEditCollection || !currentEditDocId) return;

            if (updateSubmitBtn) {
              updateSubmitBtn.disabled = true;
              updateSubmitBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';
            }

            let updatedData = {};
            let selectedEditFile = null;
            let newImagePathPrefix = "";

            try {
              // コレクションに応じてデータを収集
              switch (currentEditCollection) {
                case "articles":
                  updatedData = {
                    title: document.getElementById("edit-article-title").value,
                    date: document.getElementById("edit-article-date").value,
                    category: document.getElementById("edit-article-category")
                      .value,
                    content: document.getElementById("edit-article-content")
                      .value,
                  };
                  selectedEditFile = editFileArticle;
                  newImagePathPrefix = "images/photo/articles";
                  break;

                case "books":
                  updatedData = {
                    title: document.getElementById("edit-book-title").value,
                    url: document.getElementById("edit-book-url").value,
                    buttonText: document.getElementById("edit-book-button-text").value || "詳細を見る",
                    openNewTab: document.getElementById("edit-book-open-new-tab").checked,
                    description: document.getElementById("edit-book-description").value,
                    // ★ 修正: fixed, order, starRating の値を取得して保存
                    fixed: document.getElementById("edit-book-fixed").checked,
                    fixedOnMedia: document.getElementById("edit-book-fixed-on-media").checked,
                    showInSnippet: document.getElementById("edit-book-show-in-snippet").checked,
                    order: parseInt(document.getElementById("edit-book-order").value, 10),
                    starRating: parseInt(document.getElementById("edit-book-star-rating").value, 10),
                  };
                  selectedEditFile = editFileBook;
                  newImagePathPrefix = "images/photo/books";
                  break;

                case "mediaIcons":
                  updatedData = {
                    title: document.getElementById("edit-media-icon-title")
                      .value,
                    description: document.getElementById(
                      "edit-media-icon-description"
                    ).value,
                    url: document.getElementById("edit-media-icon-url").value,
                    order: parseInt(
                      document.getElementById("edit-media-icon-order").value,
                      10
                    ),
                    iconName: document.getElementById("edit-media-icon-name")
                      .value,
                  };
                  selectedEditFile = editFileMediaIcon;
                  newImagePathPrefix = "images/system/media_icons";

                  // ★ アイコンロジック
                  if (selectedEditFile) {
                    updatedData.iconName = ""; // カスタム画像優先
                  } else if (updatedData.iconName) {
                    updatedData.customIconUrl = "";
                    updatedData.customImagePath = "";
                  }
                  break;

                case "mediaBanners":
                  updatedData = {
                    url: document.getElementById("edit-media-banner-url").value,
                    order: parseInt(
                      document.getElementById("edit-media-banner-order").value,
                      10
                    ),
                    animation: document.getElementById(
                      "edit-media-banner-animation"
                    ).value,
                  };
                  selectedEditFile = editFileMediaBanner;
                  newImagePathPrefix = "images/system/media_banners";
                  break;

                case "savedLinks":
                  updatedData = {
                    title: document.getElementById("edit-saved-link-title").value,
                    url: document.getElementById("edit-saved-link-url").value,
                    memo: document.getElementById("edit-saved-link-memo").value,
                  };
                  selectedEditFile = null;
                  newImagePathPrefix = "";
                  break;

                case "sites":
                  updatedData = {
                    title: document.getElementById("edit-site-title").value,
                    description: document.getElementById(
                      "edit-site-description"
                    ).value,
                    url: document.getElementById("edit-site-url").value,
                    order: parseInt(
                      document.getElementById("edit-site-order").value,
                      10
                    ),
                    iconName: document.getElementById("edit-site-icon-name")
                      .value,
                  };
                  selectedEditFile = editFileSite;
                  newImagePathPrefix = "images/system/sites";
                  editFileSkill = null;
                  editFileContact = null;
                  break;

                case "skills":
                  updatedData = {
                    title: document.getElementById("edit-skill-title").value,
                    subtitle: document.getElementById("edit-skill-subtitle").value,
                    icon: document.getElementById("edit-skill-icon").value,
                    order: parseInt(document.getElementById("edit-skill-order").value, 10),
                  };
                  selectedEditFile = editFileSkill;
                  newImagePathPrefix = "images/system/skills";
                  // アイコンロジック
                  if (selectedEditFile) {
                    updatedData.icon = ""; // カスタム画像優先
                  } else if (updatedData.icon) {
                    updatedData.customIconUrl = "";
                    updatedData.customImagePath = "";
                  }
                  break;

                case "personalInfo":
                  updatedData = {
                    title: document.getElementById("edit-personal-title").value,
                    description: document.getElementById("edit-personal-description").value,
                    order: parseInt(document.getElementById("edit-personal-order").value, 10),
                  };
                  selectedEditFile = null;
                  newImagePathPrefix = "";
                  break;

                case "contactInfo":
                  updatedData = {
                    title: document.getElementById("edit-contact-title").value,
                    description: document.getElementById("edit-contact-description").value,
                    icon: document.getElementById("edit-contact-icon").value,
                    order: parseInt(document.getElementById("edit-contact-order").value, 10),
                    width: document.getElementById("edit-contact-width").value,
                    align: document.getElementById("edit-contact-align").value,
                  };
                  selectedEditFile = null;
                  selectedEditFile = editFileContact;
                  newImagePathPrefix = "images/system/contact";
                  // アイコンロジック
                  if (selectedEditFile) {
                    updatedData.iconName = ""; // カスタム画像優先
                  } else if (updatedData.iconName) {
                    updatedData.customIconUrl = "";
                    updatedData.customImagePath = "";
                  }
                  newImagePathPrefix = "";
                  break;

                case "bottomNavigation":
                    updatedData = {
                      title: document.getElementById("edit-bottom-nav-title").value,
                      url: document.getElementById("edit-bottom-nav-url").value,
                      iconName: document.getElementById("edit-bottom-nav-icon").value,
                      order: parseInt(document.getElementById("edit-bottom-nav-order").value, 10),
                    };
                    
                    // ★ 画像アップロード設定 (editFileBottomNav を使用)
                    selectedEditFile = editFileBottomNav; 
                    newImagePathPrefix = "images/system/bottom_nav";

                    // アイコンロジック：画像があればiconNameをクリア
                    if (selectedEditFile) {
                        updatedData.iconName = "";
                    } else if (updatedData.iconName) {
                        updatedData.customIconUrl = "";
                        updatedData.customImagePath = "";
                    }
                    break;
                case "blogContents":
                  const contentBlocks = [];
                  document.querySelectorAll('#edit-html-blocks-container .dynamic-html-block').forEach(textarea => {
                    contentBlocks.push(textarea.value);
                  });

                  updatedData = {
                    title: document.getElementById("edit-dynamic-title").value,
                    contentBlocks: contentBlocks,
                  };
                  selectedEditFile = editFileDynamic;
                  newImagePathPrefix = "images/photo/blog_contents";
                  break;
                case "navigation":
                  updatedData = {
                    title: document.getElementById("edit-nav-title").value,
                    url: document.getElementById("edit-nav-url").value,
                    order: parseInt(
                      document.getElementById("edit-nav-order").value,
                      10
                    ),
                  };
                  // ナビゲーションには画像ファイルがないので、selectedEditFile は null のまま
                  selectedEditFile = null;
                  newImagePathPrefix = ""; // 使用しない
                  break;

                case "blogPosts":
                  updatedData = {
                    title: document.getElementById("edit-blog-post-title")
                      .value,
                    url: document.getElementById("edit-blog-post-url").value,
                    description: document.getElementById(
                      "edit-blog-post-description"
                    ).value,

                    category: document.getElementById(
                      "edit-blog-post-category-select"
                    ).value, // ★ P2-Rework: 変更

                    order: parseInt(
                      document.getElementById("edit-blog-post-order").value,
                      10
                    ),
                  };
                  selectedEditFile = editFileBlogPost; // (Step 7で定義した変数)
                  newImagePathPrefix = "images/photo/blog_posts";
                  break;
                // --- 8. サイトマップ項目 (Phase 3-3) ---
                case "sitemapEntries":
                  updatedData = {
                    title: document.getElementById("edit-sitemap-title").value,
                    path: document.getElementById("edit-sitemap-path").value,
                    // lastModified はDB保存時に serverTimestamp で更新
                  };
                  // サイトマップには画像ファイルがないので、selectedEditFile は null のまま
                  selectedEditFile = null;
                  newImagePathPrefix = ""; // 使用しない
                  break;
              }
              // 1. 新しい画像が選択されたか？
              if (selectedEditFile) {
                const userId = auth.currentUser.uid;
                if (!userId) throw new Error("ユーザーが認証されていません。");

                const newImagePath = `${newImagePathPrefix}/${userId}/${Date.now()}_${
                  selectedEditFile.name
                }`;
                const storageRef = ref(storage, newImagePath);

                // 1a. 新しい画像をアップロード
                const newImageUrl = await uploadImage(
                  storageRef, selectedEditFile, null );

                // 1b. データ更新
                if (
                  ["mediaIcons", "sites", "skills", "contactInfo"].includes(currentEditCollection)) {
                  updatedData.customIconUrl = newImageUrl;
                  updatedData.customImagePath = newImagePath;
                } else {
                  updatedData.imageUrl = newImageUrl;
                  updatedData.imagePath = newImagePath;
                }

                // 1c. 古い画像があれば削除
                if (currentEditOldImagePath) {
                  try {
                    await deleteObject(ref(storage, currentEditOldImagePath));
                  } catch (e) {
                    console.warn("古い画像の削除に失敗しました:", e);
                  }
                }
              }

              // 2. Firestoreドキュメントを更新
              // --- ★ Phase 3-3 (機能追加 4/4): サイトマップの特別保存処理 ★ ---
              if (currentEditCollection === "sitemapEntries") {
                const newPath = updatedData.path;

                // path (ドキュメントID) が変更されたかチェック
                if (newPath !== currentEditDocId) {
                  // IDが変更された場合

                  // 1. 新しいID (newPath) で新しいドキュメントを作成
                  // (IDが path と同じなのが sitemapEntries の仕様)
                  updatedData.lastModified = serverTimestamp(); // タイムスタンプも更新
                  const newDocRef = doc(db, "sitemapEntries", newPath);
                  await setDoc(newDocRef, updatedData);

                  // 2. 古いID (currentEditDocId) のドキュメントを削除
                  const oldDocRef = doc(db, "sitemapEntries", currentEditDocId);
                  await deleteDoc(oldDocRef);
                } else {
                  // IDが変更されていない場合 (通常のタイトル更新)
                  updatedData.lastModified = serverTimestamp(); // タイムスタンプも更新
                  const docRef = doc(db, "sitemapEntries", currentEditDocId);
                  await updateDoc(docRef, updatedData);
                }
              } else {
                // 2. Firestoreドキュメントを更新 (sitemapEntries 以外)
                await updateDoc(
                  doc(db, currentEditCollection, currentEditDocId),
                  updatedData
                );
              }

              showMessage("項目を更新しました。");
              closeEditModal();

              // 3. 対応するリストを再読み込み
              switch (currentEditCollection) {
                case "articles":
                  loadArticles();
                  break;
                case "books":
                  loadBooks();
                  break;
                case "mediaIcons":
                  loadMediaIcons();
                  break;
                case "mediaBanners":
                  loadMediaBanners();
                  break;
                case "sites":
                  loadSites();
                  break;
                case "skills":
                  loadSkills();
                  break;
                case "personalInfo":
                  loadPersonalInfo();
                  break;
                case "contactInfo":
                  loadContactInfo();
                  break;
                case "navigation":
                  loadNavigation();
                  break;
                case "blogPosts":
                  loadBlogPosts();
                  break;
                case "blogContents":
                  loadDynamicBlogs();
                  break;
                case "bottomNavigation":
                  loadBottomNavigation();
                  break;
                case "savedLinks":
                  loadSavedLinks();
                  break;
              }
            } catch (error) {
              console.error(`Error updating ${currentEditCollection}: `, error);
              showMessage(`更新エラー: ${error.message}`, "error");
            } finally {
              if (updateSubmitBtn) {
                updateSubmitBtn.disabled = false;
                updateSubmitBtn.innerHTML =
                  '<span class="material-symbols-outlined">save</span> <span>変更を保存</span>';
              }
            }
          });
        }
        // --- ★ Firestore (ナビゲーション) ロジック (NEW) ★ ---
        // --- 11. ナビゲーション管理 (Navigation CRUD) ---

        // 1. 読み込み
        async function loadNavigation() {
          if (!navigationLoader || !navigationListContainer) return;
          navigationLoader.classList.remove("hidden");
          navigationListContainer.innerHTML = "";
          navigationListContainer.appendChild(navigationLoader);
          try {
            const navigationCol = collection(db, "navigation");
            const q = query(navigationCol, orderBy("order", "asc"));
            const querySnapshot = await getDocs(q);
            navigationLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const navigationCountDisplay = document.getElementById(
              "navigation-count-display"
            );
            if (navigationCountDisplay) {
              navigationCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }

            if (querySnapshot.empty) {
              navigationListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだメニュー項目がありません。</p>';
              return;
            }

            navigationListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const navData = docSnap.data();
              const navId = docSnap.id;
              const navEl = document.createElement("div");
              navEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              navEl.innerHTML = `
              <div class="flex-grow w-full">
                <h3 class="text-lg font-bold">${
                  navData.title
                } <span class="text-sm text-text-muted-light"> (表示順: ${
                navData.order
              })</span></h3>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">リンク先: <span class="text-primary font-medium">${
                  navData.url
                }</span></p>
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${navId}"
                  data-collection="navigation"
                  data-title="${encodeURIComponent(navData.title || "")}"
                  data-url="${encodeURIComponent(navData.url || "")}"
                  data-order="${navData.order || "10"}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button data-doc-id="${navId}" data-collection="navigation" data-image-path="" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              navigationListContainer.appendChild(navEl);
            });
          } catch (error) {
            console.error("Error loading navigation: ", error);
            showMessage(
              `ナビゲーションの読み込みエラー: ${error.message}`,
              "error"
            );
            navigationLoader.classList.add("hidden");
            navigationListContainer.innerHTML =
              '<p class="text-center text-red-500">ナビゲーションの読み込みに失敗しました。</p>';
          }
        }

        // 2. 追加
        if (addNavigationForm) {
          addNavigationForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("nav-title").value;
            const url = document.getElementById("nav-url").value;
            const order = parseInt(
              document.getElementById("nav-order").value,
              10
            );

            if (submitNavigationBtn) {
              submitNavigationBtn.disabled = true;
              submitNavigationBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              await addDoc(collection(db, "navigation"), {
                title: title,
                url: url,
                order: order,
                createdAt: serverTimestamp(),
              });
              showMessage("メニュー項目が正常に追加されました。");
              resetNavigationForm();
              loadNavigation();
            } catch (error) {
              console.error("Error adding navigation item: ", error);
              showMessage(
                `メニュー項目の追加エラー: ${error.message}`,
                "error"
              );
              resetNavigationForm();
            }
          });
        }

        // 3. フォームリセット
        function resetNavigationForm() {
          if (addNavigationForm) addNavigationForm.reset();
          if (submitNavigationBtn) {
            submitNavigationBtn.disabled = false;
            submitNavigationBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>メニュー項目を追加する</span>';
          }
        }
        // --- ★ 固定ページ (ヘッダーCTA) ロジック (NEW) ★ ---
        // --- 12. 固定ページ管理 (Static Pages Logic) ---

        // 1. ヘッダーCTAデータの読み込み
        async function loadHeaderCtaData() {
          if (!updateHeaderCtaForm || !headerCtaLoader) return;

          // フォームを非表示にし、ローダーを表示
          updateHeaderCtaForm.classList.add("hidden");
          headerCtaLoader.classList.remove("hidden");

          try {
            // 「たった1つ」のドキュメント（設定）を指定して取得
            const docRef = doc(db, "staticPages", "commonSettings");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              // データが存在する場合、フォームに値を設定
              const data = docSnap.data().headerCta || {}; // headerCta フィールド内のデータを取得

              const visibleInput =
                document.getElementById("header-cta-visible");
              const textInput = document.getElementById("header-cta-text");
              const urlInput = document.getElementById("header-cta-url");

              if (visibleInput) visibleInput.checked = data.visible || false;
              if (textInput) textInput.value = data.text || "";
              if (urlInput) urlInput.value = data.url || "";

              // フッターテキストの読み込み
              const footerTextInput = document.getElementById("footer-text-input");
              if (footerTextInput) {
                footerTextInput.value = docSnap.data().footerText || "";
              }
            } else {
              // データがまだない場合（初回起動時など）
              console.log("ヘッダーCTA設定がまだ保存されていません。");
              // フォームは空のまま表示される
            }
          } catch (error) {
            console.error("Error loading header CTA data: ", error);
            showMessage(
              `ヘッダーCTA設定の読み込みエラー: ${error.message}`,
              "error"
            );
          } finally {
            // フォームを表示し、ローダーを非表示
            updateHeaderCtaForm.classList.remove("hidden");
            headerCtaLoader.classList.add("hidden");
          }
        }

        // --- ★ サイトタイトル・ロゴ管理 (Basic Settings Logic) ★ ---
        // 1. 読み込み
        async function loadSiteBranding() {
            const form = document.getElementById('update-site-branding-form');
            if (!form) return;
            
            try {
                const docRef = doc(db, "staticPages", "commonSettings");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const titleInput = document.getElementById('site-title-input');
                    const logoPreview = document.getElementById('current-site-logo-preview');
                    
                    if (titleInput) titleInput.value = data.siteTitle || '';
                    if (logoPreview) {
                        if (data.logoUrl) {
                            logoPreview.src = data.logoUrl;
                            logoPreview.style.display = 'block';
                        } else {
                            logoPreview.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading site branding:", error);
                showMessage(`サイト設定の読み込みエラー: ${error.message}`, "error");
            }
        }

        // 2. 保存
        const updateSiteBrandingForm = document.getElementById('update-site-branding-form');
        if (updateSiteBrandingForm) {
            updateSiteBrandingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = updateSiteBrandingForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loader !w-4 !h-4 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';
                }
                
                try {
                    const titleInput = document.getElementById('site-title-input');
                    const logoInput = document.getElementById('site-logo-input');
                    const siteTitle = titleInput ? titleInput.value.trim() : '';
                    
                    let logoUrl = null;
                    let logoPath = null;
                    
                    // ロゴ画像のアップロード処理
                    if (logoInput && logoInput.files[0]) {
                        const file = logoInput.files[0];
                        const userId = auth.currentUser.uid;
                        logoPath = `images/system/branding/${userId}/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, logoPath);
                        logoUrl = await uploadImage(storageRef, file, null);
                    }
                    
                    // 保存するデータ
                    const dataToSave = {
                        siteTitle: siteTitle
                    };
                    
                    if (logoUrl) {
                        dataToSave.logoUrl = logoUrl;
                        dataToSave.logoPath = logoPath;
                    }
                    
                    const docRef = doc(db, "staticPages", "commonSettings");
                    await setDoc(docRef, dataToSave, { merge: true });
                    
                    showMessage("サイト設定を保存しました。");
                    
                    // プレビュー更新
                    if (logoUrl) {
                        const logoPreview = document.getElementById('current-site-logo-preview');
                        if (logoPreview) {
                            logoPreview.src = logoUrl;
                            logoPreview.style.display = 'block';
                        }
                        logoInput.value = ''; // ファイル入力をリセット
                    }
                    
                } catch (error) {
                    console.error("Error saving site branding:", error);
                    showMessage(`保存エラー: ${error.message}`, "error");
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<span class="material-symbols-outlined">save</span> <span>サイト設定を保存</span>';
                    }
                }
            });
        }
        // 2. ヘッダーCTAデータの保存
        if (updateHeaderCtaForm) {
          updateHeaderCtaForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!submitHeaderCtaBtn) return;

            submitHeaderCtaBtn.disabled = true;
            submitHeaderCtaBtn.innerHTML =
              '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';

            try {
              // フォームからデータを収集
              const dataToSave = {
                headerCta: {
                  // headerCta というフィールドにまとめて保存
                  visible:
                    document.getElementById("header-cta-visible")?.checked ||
                    false,
                  text: document.getElementById("header-cta-text")?.value || "",
                  url: document.getElementById("header-cta-url")?.value || "",
                },
              };

              // 「たった1つ」のドキュメント（設定）を指定して保存
              // { merge: true } を指定することで、commonSettings 内の他のデータ（将来追加されるもの）を上書きせず、
              // headerCta フィールドだけを安全に更新できます。
              const docRef = doc(db, "staticPages", "commonSettings");
              await setDoc(docRef, dataToSave, { merge: true });

              showMessage("共通設定を保存しました。");
            } catch (error) {
              console.error("Error saving header CTA data: ", error);
              showMessage(`設定の保存エラー: ${error.message}`, "error");
            } finally {
              submitHeaderCtaBtn.disabled = false;
              submitHeaderCtaBtn.innerHTML =
                '<span class="material-symbols-outlined">save</span> <span>共通設定を保存</span>';
            }
          });
        }

        // 3. フッターテキストの保存
        const updateFooterTextForm = document.getElementById("update-footer-text-form");
        const saveFooterTextBtn = document.getElementById("save-footer-text-btn");

        if (updateFooterTextForm) {
          updateFooterTextForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!saveFooterTextBtn) return;

            saveFooterTextBtn.disabled = true;
            saveFooterTextBtn.innerHTML =
              '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';

            try {
              // フォームからデータを収集
              const footerText = document.getElementById("footer-text-input")?.value || "";

              const dataToSave = {
                footerText: footerText,
              };

              // commonSettings に footerText を保存
              const docRef = doc(db, "staticPages", "commonSettings");
              await setDoc(docRef, dataToSave, { merge: true });

              showMessage("フッター設定を保存しました。");
            } catch (error) {
              console.error("Error saving footer text: ", error);
              showMessage(`フッター設定の保存エラー: ${error.message}`, "error");
            } finally {
              saveFooterTextBtn.disabled = false;
              saveFooterTextBtn.innerHTML =
                '<span class="material-symbols-outlined">save</span> <span>フッター設定を保存</span>';
            }
          });
        }

// ========================================
// 13. Contact Set Management (NEW)
// ========================================

let currentEditingSetId = null;

// Load all contact sets and display them
async function loadContactSets() {
    const container = document.getElementById("contact-sets-container");
    if (!container) return;

    container.innerHTML = '<div class="flex justify-center py-8"><div class="loader"></div></div>';

    try {
        // Get all sets
        const setsSnapshot = await getDocs(collection(db, "contactSets"));
        const sets = [];
        setsSnapshot.forEach((doc) => {
            sets.push({ id: doc.id, ...doc.data() });
        });

        // Get active set ID
        const settingsDoc = await getDoc(doc(db, "staticPages", "commonSettings"));
        const activeSetId = settingsDoc.exists() ? settingsDoc.data().activeContactSetId : null;

        // Render sets
        if (sets.length === 0) {
            container.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark py-8">セットが登録されていません。「新規セット作成」ボタンから作成してください。</p>';
        } else {
            container.innerHTML = sets.map(set => `
                <div class="p-4 bg-white dark:bg-slate-800 rounded-lg border ${set.id === activeSetId ? 'border-primary' : 'border-slate-200 dark:border-slate-700'} shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="active-set" value="${set.id}" ${set.id === activeSetId ? 'checked' : ''} class="w-4 h-4 text-primary focus:ring-primary" onchange="toggleActiveContactSet('${set.id}')">
                                <span class="ml-2 font-bold">${set.title || '無題のセット'}</span>
                            </label>
                            ${set.id === activeSetId ? '<span class="text-xs bg-primary text-white px-2 py-1 rounded">有効</span>' : ''}
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="showContactSetSnippet('${set.id}')" class="text-sm text-green-600 hover:text-green-800 dark:text-green-400 font-bold flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">code</span>
                                スニペット
                            </button>
                            <button type="button" onclick="editContactSet('${set.id}')" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 font-bold">編集</button>
                            <button type="button" onclick="deleteContactSet('${set.id}')" class="text-sm text-red-600 hover:text-red-800 dark:text-red-400 font-bold">削除</button>
                        </div>
                    </div>
                    <div class="text-sm text-text-muted-light dark:text-text-muted-dark">
                        <p>CTA: ${set.cta?.visible ? '表示' : '非表示'} | 連絡先: ${set.items?.length || 0}件</p>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error("Error loading contact sets:", error);
        showMessage(`セット一覧の読み込みエラー: ${error.message}`, "error");
        container.innerHTML = '<p class="text-center text-red-600 py-8">読み込みエラーが発生しました。</p>';
    }
}

// Toggle active contact set
async function toggleActiveContactSet(setId) {
    try {
        const docRef = doc(db, "staticPages", "commonSettings");
        await setDoc(docRef, { activeContactSetId: setId }, { merge: true });
        showMessage("有効なセットを切り替えました。");
        loadContactSets(); // Reload to update UI
    } catch (error) {
        console.error("Error toggling active set:", error);
        showMessage(`切り替えエラー: ${error.message}`, "error");
    }
}

// Edit existing contact set
async function editContactSet(setId) {
    try {
        const docSnap = await getDoc(doc(db, "contactSets", setId));
        if (!docSnap.exists()) {
            showMessage("セットが見つかりません。", "error");
            return;
        }

        const data = docSnap.data();
        currentEditingSetId = setId;

        // Show editor
        document.getElementById("contact-set-editor-section").classList.remove("hidden");
        document.getElementById("editor-title").textContent = "セット編集";
        document.getElementById("set-id").value = setId;

        // Fill form
        document.getElementById("set-title").value = data.title || "";
        document.getElementById("set-cta-visible").checked = data.cta?.visible || false;
        document.getElementById("set-cta-main-text").value = data.cta?.mainText || "";
        document.getElementById("set-cta-sub-text").value = data.cta?.subText || "";
        document.getElementById("set-cta-button-text").value = data.cta?.buttonText || "";
        document.getElementById("set-cta-button-url").value = data.cta?.buttonUrl || "";
        document.getElementById("set-cta-align").value = data.cta?.align || "text-center";

        // Fill contact items
        const container = document.getElementById("set-contact-items-container");
        container.innerHTML = "";
        if (data.items && data.items.length > 0) {
            data.items.forEach((item, index) => {
                addContactItemField(item);
            });
        }
        
        // Fill items alignment
        document.getElementById("items-columns").value = data.itemsColumns || "2";
        document.getElementById("items-icon-position").value = data.itemsIconPosition || "flex-row";
        document.getElementById("items-align").value = data.itemsAlign || "text-left";


        // Scroll to editor
        document.getElementById("contact-set-editor-section").scrollIntoView({ behavior: "smooth" });
    } catch (error) {
        console.error("Error loading set for edit:", error);
        showMessage(`読み込みエラー: ${error.message}`, "error");
    }
}

// Delete contact set
async function deleteContactSet(setId) {
    if (!confirm("このセットを削除してもよろしいですか?")) return;

    try {
        await deleteDoc(doc(db, "contactSets", setId));
        showMessage("セットを削除しました。");
        loadContactSets();
    } catch (error) {
        console.error("Error deleting set:", error);
        showMessage(`削除エラー: ${error.message}`, "error");
    }
}

// Add contact item field to editor
function addContactItemField(data = {}) {
    const container = document.getElementById("set-contact-items-container");
    const index = container.children.length;
    const itemHtml = `
        <div class="contact-item p-3 bg-white dark:bg-slate-700 rounded border border-slate-200 dark:border-slate-600">
            <div class="flex justify-between items-start mb-2">
                <span class="text-sm font-bold">項目 ${index + 1}</span>
                <div class="flex items-center gap-3">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="item-visible sr-only peer" ${data.visible !== false ? 'checked' : ''}>
                        <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        <span class="ms-2 text-xs font-medium text-gray-900 dark:text-gray-300">表示</span>
                    </label>
                    <button type="button" onclick="this.closest('.contact-item').remove()" class="text-red-600 hover:text-red-800 text-sm">削除</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="text" class="item-title text-sm rounded border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800" placeholder="項目名 (例: 電話番号)" value="${data.title || ''}" />
                <input type="text" class="item-icon text-sm rounded border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800" placeholder="アイコン (例: call)" value="${data.icon || ''}" />
            </div>
            <textarea class="item-description mt-2 w-full text-sm rounded border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800" rows="2" placeholder="内容 (例: 03-1234-5678)">${data.description || ''}</textarea>
            <input type="text" class="item-image mt-2 w-full text-sm rounded border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800" placeholder="画像URL (任意)" value="${data.image || ''}" />
        </div>
    `;
    container.insertAdjacentHTML("beforeend", itemHtml);
}

// Save contact set
async function saveContactSet(e) {
    e.preventDefault();

    const saveBtn = document.getElementById("save-set-btn");
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<div class="loader !w-5 !h-5 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';

    try {
        const setId = document.getElementById("set-id").value;
        const title = document.getElementById("set-title").value;

        // Collect CTA data
        const cta = {
            visible: document.getElementById("set-cta-visible").checked,
            mainText: document.getElementById("set-cta-main-text").value,
            subText: document.getElementById("set-cta-sub-text").value,
            buttonText: document.getElementById("set-cta-button-text").value,
            buttonUrl: document.getElementById("set-cta-button-url").value,
            align: document.getElementById("set-cta-align").value,
        };

        // Collect contact items
        const items = [];
        document.querySelectorAll(".contact-item").forEach((item) => {
            items.push({
                title: item.querySelector(".item-title").value,
                description: item.querySelector(".item-description").value,
                icon: item.querySelector(".item-icon").value,
                image: item.querySelector(".item-image").value,
                visible: item.querySelector(".item-visible").checked,
            });
        });

        const dataToSave = {
            title,
            cta,
            itemsColumns: document.getElementById("items-columns").value,
            itemsIconPosition: document.getElementById("items-icon-position").value,
            itemsAlign: document.getElementById("items-align").value,
            items,
            updatedAt: new Date(),
            updatedAt: serverTimestamp() // 更新日時は常に記録
        };

        if (setId) {
            // Update existing
            await updateDoc(doc(db, "contactSets", setId), dataToSave);
            showMessage("セットを更新しました。");
        } else {
            // Create new
            dataToSave.createdAt = serverTimestamp(); // 新規作成時のみ createdAt を追加
            await addDoc(collection(db, "contactSets"), dataToSave);
            showMessage("新しいセットを作成しました。");
        }

        // Reset form and reload
        cancelSetEdit();
        loadContactSets();
    } catch (error) {
        console.error("Error saving contact set:", error);
        showMessage(`保存エラー: ${error.message}`, "error");
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<span class="material-symbols-outlined">save</span> <span>セットを保存</span>';
    }
}

// Show contact set snippet for embedding
async function showContactSetSnippet(setId) {
    try {
        const docSnap = await getDoc(doc(db, "contactSets", setId));
        if (!docSnap.exists()) {
            showMessage("セットが見つかりません。", "error");
            return;
        }

        const data = docSnap.data();
        
        // Generate HTML snippet
        let snippetHTML = '';
        
        // Add CTA section if visible
        if (data.cta && data.cta.visible) {
            snippetHTML += `
<!-- CTA Section -->
<section class="cta-section py-16 bg-gradient-to-r from-primary to-primary-dark text-white">
    <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold mb-4">${data.cta.mainText || ''}</h2>
        <p class="text-lg mb-8">${data.cta.subText || ''}</p>
        ${data.cta.buttonText && data.cta.buttonUrl ? `<a href="${data.cta.buttonUrl}" class="inline-block px-8 py-3 bg-white text-primary font-bold rounded-lg hover:bg-gray-100 transition-colors">${data.cta.buttonText}</a>` : ''}
    </div>
</section>

`;
        }
        
        // Add contact items section
        if (data.items && data.items.length > 0) {
            const visibleItems = data.items.filter(item => item.visible !== false);
            if (visibleItems.length > 0) {
                snippetHTML += `
<!-- Contact Information Section -->
<section class="contact-info-section py-12">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
`;
                visibleItems.forEach(item => {
                    snippetHTML += `            <div class="contact-item p-6 bg-white dark:bg-slate-800 rounded-lg shadow-md">
                <div class="flex items-center gap-4">
                    ${item.image ? `<img src="${item.image}" alt="${item.title}" class="w-12 h-12 rounded-full">` : item.icon ? `<span class="material-symbols-outlined text-4xl text-primary">${item.icon}</span>` : ''}
                    <div>
                        <h3 class="font-bold text-lg">${item.title || ''}</h3>
                        <p class="text-text-muted-light dark:text-text-muted-dark">${item.description || ''}</p>
                    </div>
                </div>
            </div>
`;
                });
                snippetHTML += `        </div>
    </div>
</section>`;
            }
        }
        
        // Show snippet modal
        const snippetModal = document.getElementById("snippet-modal");
        const snippetCodeArea = document.getElementById("snippet-code-area");
        
        if (snippetModal && snippetCodeArea) {
            snippetCodeArea.value = snippetHTML;
            snippetModal.classList.remove("hidden");
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(snippetHTML).then(() => {
                showMessage("スニペットをクリップボードにコピーしました。");
            }).catch(() => {
                showMessage("スニペットの生成に成功しました。", "success");
                console.log(snippetHTML);
            });
        }
    } catch (error) {
        console.error("Error generating snippet:", error);
        showMessage(`スニペット生成エラー: ${error.message}`, "error");
    }
}

// Cancel set edit
function cancelSetEdit() {
    currentEditingSetId = null;
    document.getElementById("contact-set-editor-section").classList.add("hidden");
    document.getElementById("contact-set-form").reset();
    document.getElementById("set-id").value = "";
    document.getElementById("set-contact-items-container").innerHTML = "";
    document.getElementById("editor-title").textContent = "新規セット作成";
}

// Initialize Contact Set Management
const createNewSetBtn = document.getElementById("create-new-set-btn");
const contactSetForm = document.getElementById("contact-set-form");
const addContactItemBtn = document.getElementById("add-contact-item-btn");
const cancelSetBtn = document.getElementById("cancel-set-btn");

if (createNewSetBtn) {
    createNewSetBtn.addEventListener("click", () => {
        cancelSetEdit(); // Reset form
        document.getElementById("contact-set-editor-section").classList.remove("hidden");
        document.getElementById("contact-set-editor-section").scrollIntoView({ behavior: "smooth" });
    });
}

if (contactSetForm) {
    contactSetForm.addEventListener("submit", saveContactSet);
}

if (addContactItemBtn) {
    addContactItemBtn.addEventListener("click", () => addContactItemField());
}

if (cancelSetBtn) {
    cancelSetBtn.addEventListener("click", cancelSetEdit);
}

// Expose functions to global scope for inline onclick handlers
window.loadContactSets = loadContactSets;
window.toggleActiveContactSet = toggleActiveContactSet;
window.editContactSet = editContactSet;
window.deleteContactSet = deleteContactSet;
window.showContactSetSnippet = showContactSetSnippet;
window.addContactItemField = addContactItemField;


        // --- ★ Firestore (ブログカテゴリー) ロジック (P-New) ★ ---
        // --- 13. ブログカテゴリー管理 (Blog Categories CRUD) ---

        // 1. 読み込み
        async function loadBlogCategories() {
          if (!blogCategoriesLoader || !blogCategoriesListContainer) return;
          blogCategoriesLoader.classList.remove("hidden");
          blogCategoriesListContainer.innerHTML = "";
          blogCategoriesListContainer.appendChild(blogCategoriesLoader);
          try {
            const categoriesCol = collection(db, "blogCategories");
            // ★ カテゴリー名 (name) でアルファベット順に並び替え
            const q = query(categoriesCol, orderBy("name", "asc"));
            const querySnapshot = await getDocs(q);
            blogCategoriesLoader.classList.add("hidden");

            if (querySnapshot.empty) {
              blogCategoriesListContainer.innerHTML =
                '<p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">まだカテゴリーがありません。</p>';
              return;
            }

            blogCategoriesListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const category = docSnap.data();
              const categoryId = docSnap.id;
              const categoryEl = document.createElement("div");
              categoryEl.className =
                "flex items-center justify-between gap-4 p-3 bg-background-light dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700";

              categoryEl.innerHTML = `
              <span class="font-medium">${category.name}</span>
              <button 
                data-doc-id="${categoryId}"
                data-collection="blogCategories"
                data-image-path=""
                class="delete-btn flex-shrink-0 py-1 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-xs flex items-center gap-1">
                <span class="material-symbols-outlined !text-sm">delete</span>
                <span>削除</span>
              </button>
            `;
              blogCategoriesListContainer.appendChild(categoryEl);
            });

            // ★ P2-Rework: 取得したカテゴリーを「ブログ記事追加」フォームのドロップダウンに設定
            const selectEl = document.getElementById(
              "blog-post-category-select"
            );
            if (selectEl) {
              if (querySnapshot.empty) {
                selectEl.innerHTML =
                  '<option value="" disabled selected>カテゴリーが登録されていません</option>';
              } else {
                selectEl.innerHTML =
                  '<option value="" disabled selected>カテゴリーを選択してください</option>';
                querySnapshot.forEach((docSnap) => {
                  const category = docSnap.data();
                  const option = document.createElement("option");
                  option.value = category.name;
                  option.textContent = category.name;
                  selectEl.appendChild(option);
                });
              }
            }

            // ★ P2-Rework: 「修正」フォームのテンプレートにもコピー
            const editSelectEl = document.getElementById(
              "edit-blog-post-category-select"
            );
            if (editSelectEl) {
              if (querySnapshot.empty) {
                editSelectEl.innerHTML =
                  '<option value="" disabled>カテゴリーが登録されていません</option>';
              } else {
                editSelectEl.innerHTML =
                  '<option value="" disabled>カテゴリーを選択してください</option>';
                querySnapshot.forEach((docSnap) => {
                  const category = docSnap.data();
                  const option = document.createElement("option");
                  option.value = category.name;
                  option.textContent = category.name;
                  editSelectEl.appendChild(option);
                });
              }
            }
          } catch (error) {
            console.error("Error loading blog categories: ", error);
            showMessage(
              `カテゴリーの読み込みエラー: ${error.message}`,
              "error"
            );
            blogCategoriesLoader.classList.add("hidden");
            blogCategoriesListContainer.innerHTML =
              '<p class="text-center text-red-500">カテゴリーの読み込みに失敗しました。</p>';
          }
        }



        // 3. フォームリセット
        function resetBlogCategoryForm() {
          const categoryNameInput =
            document.getElementById("blog-category-name");
          if (categoryNameInput) categoryNameInput.value = "";

          if (submitBlogCategoryBtn) {
            submitBlogCategoryBtn.disabled = false;
            submitBlogCategoryBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>追加</span>';
          }
        }
        // --- ★ Firestore (ブログ記事) ロジック (NEW) ★ ---
        // --- 14. ブログ記事管理 (Blog Posts CRUD) ---

        // 1. 読み込み
        async function loadBlogPosts() {
          if (!blogPostsLoader || !blogPostsListContainer) return;
          blogPostsLoader.classList.remove("hidden");
          blogPostsListContainer.innerHTML = "";
          blogPostsListContainer.appendChild(blogPostsLoader);
          try {
            const blogPostsCol = collection(db, "blogPosts");
            const q = query(blogPostsCol, orderBy("order", "asc")); // 表示順で並び替え
            const querySnapshot = await getDocs(q);

            blogPostsLoader.classList.add("hidden");

            // ★ Phase 3-1: 総数表示
            const blogPostsCountDisplay = document.getElementById(
              "blog-posts-count-display"
            );
            if (blogPostsCountDisplay) {
              blogPostsCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }

            if (querySnapshot.empty) {
              blogPostsListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだブログ記事のメタデータがありません。</p>';
              return;
            }

            blogPostsListContainer.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
              const postData = docSnap.data();
              const postId = docSnap.id;
              const postEl = document.createElement("div");
              postEl.className =
                "flex flex-col sm:flex-row items-start gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              postEl.innerHTML = `
              <img src="${postData.imageUrl}" alt="${
                postData.title || "アイキャッチ"
              }" class="w-full sm:w-32 h-auto object-cover rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/300x200/cccccc/ffffff?text=No+Image'; this.onerror=null;">
              <div class="flex-grow">
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">
                  <span class="font-semibold text-primary">${
                    postData.category || "カテゴリなし"
                  }</span> | <span>表示順: ${postData.order}</span>
                </p>
                <h3 class="text-lg font-bold mt-1">${
                  postData.title || "タイトルなし"
                }</h3>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark mt-1">
                  リンク先: <span class="text-primary font-medium">${
                    postData.url
                  }</span>
                </p>
                <p class="text-sm mt-2 text-text-light dark:text-text-dark">${
                  postData.description
                    ? postData.description.substring(0, 100)
                    : ""
                }...</p>
              </div>
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <!-- ★ 修正ボタン (データ属性を完全に追加) ★ -->
                <button 
                  data-doc-id="${postId}"
                  data-collection="blogPosts"
                  data-title="${encodeURIComponent(postData.title || "")}"
                  data-url="${encodeURIComponent(postData.url || "")}"
                  data-category="${encodeURIComponent(postData.category || "")}"
                  data-order="${postData.order || "10"}"
                  data-description="${encodeURIComponent(
                    postData.description || ""
                  )}"
                  data-image-url="${postData.imageUrl || ""}"
                  data-image-path="${postData.imagePath || ""}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-type="blogPost"
                  data-title="${encodeURIComponent(postData.title || '')}"
                  data-url="${encodeURIComponent(postData.url || '')}" 
                  data-image-url="${postData.imageUrl || ''}"
                  data-description="${encodeURIComponent(postData.description || '')}"
                  class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">code</span>
                  <span>スニペット</span>
                </button>
                <button data-doc-id="${postId}" data-collection="blogPosts" data-image-path="${
                postData.imagePath || ""
              }" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              blogPostsListContainer.appendChild(postEl);
            });
          } catch (error) {
            console.error("Error loading blog posts: ", error);
            showMessage(
              `ブログ記事の読み込みエラー: ${error.message}`,
              "error"
            );
            blogPostsLoader.classList.add("hidden");
            blogPostsListContainer.innerHTML =
              '<p class="text-center text-red-500">ブログ記事の読み込みに失敗しました。</p>';
          }
        }

        // 2. 追加
        if (addBlogPostForm) {
          addBlogPostForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // データをフォームから取得
            const title = document.getElementById("blog-post-title").value;
            const url = document.getElementById("blog-post-url").value;
            const description = document.getElementById(
              "blog-post-description"
            ).value;
            const category = document.getElementById(
              "blog-post-category-select"
            ).value;
            const order = parseInt(
              document.getElementById("blog-post-order").value,
              10
            );

            // ★ P2: アイキャッチ画像は必須
            if (!selectedFileBlogPost) {
              showMessage("アイキャッチ画像は必須です。", "error");
              return;
            }

            if (submitBlogPostBtn) {
              submitBlogPostBtn.disabled = true;
              submitBlogPostBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              const userId = auth.currentUser.uid;
              if (!userId) throw new Error("ユーザーが認証されていません。");

              // 1. 画像をアップロード
              const imagePath = `images/photo/blog_posts/${userId}/${Date.now()}_${
                selectedFileBlogPost.name
              }`;
              const storageRef = ref(storage, imagePath);
              if (uploadProgressContainerBlogPost)
                uploadProgressContainerBlogPost.classList.remove("hidden");
              const imageUrl = await uploadImage(
                storageRef,
                selectedFileBlogPost,
                uploadProgressBarBlogPost
              );

              // 2. Firestoreにデータを保存
              await addDoc(collection(db, "blogPosts"), {
                title: title,
                url: url,
                description: description,
                category: category,
                order: order,
                openNewTab: document.getElementById("blog-post-open-new-tab")
                  .checked, // ★ NEW: 新しいタブで開くか
                imageUrl: imageUrl,
                imagePath: imagePath,
                createdAt: serverTimestamp(),
              });

              showMessage("ブログ記事メタが正常に追加されました。");
              resetBlogPostForm(); // (Step 11で実装します)
              loadBlogPosts();
            } catch (error) {
              console.error("Error adding blog post: ", error);
              showMessage(
                `ブログ記事メタの追加エラー: ${error.message}`,
                "error"
              );
              resetBlogPostForm(); // (Step 11で実装します)
            }
          });
        }

        // 3. フォームリセット
        function resetBlogPostForm() {
          if (addBlogPostForm) addBlogPostForm.reset();
          selectedFileBlogPost = null;
          if (imageInputBlogPost) imageInputBlogPost.value = "";
          if (imagePreviewBlogPost) {
            imagePreviewBlogPost.classList.add("hidden");
            imagePreviewBlogPost.src = "";
          }
          if (uploadProgressContainerBlogPost)
            uploadProgressContainerBlogPost.classList.add("hidden");
          if (uploadProgressBarBlogPost)
            uploadProgressBarBlogPost.style.width = "0%";
          if (submitBlogPostBtn) {
            submitBlogPostBtn.disabled = false;
            submitBlogPostBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>ブログ記事メタを追加する</span>';
          }
        }

        // 4. 画像プレビュー
        if (imageInputBlogPost) {
          imageInputBlogPost.addEventListener("change", (e) => {
            selectedFileBlogPost = e.target.files[0];
            if (selectedFileBlogPost) {
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (selectedFileBlogPost.size > maxSize) {
                showMessage(
                  "画像ファイルサイズは5MB以下にしてください。",
                  "error"
                );
                selectedFileBlogPost = null;
                if (imageInputBlogPost) imageInputBlogPost.value = "";
                if (imagePreviewBlogPost) {
                  imagePreviewBlogPost.classList.add("hidden");
                  imagePreviewBlogPost.src = "";
                }
                return;
              }
              const reader = new FileReader();
              reader.onload = (event) => {
                if (imagePreviewBlogPost) {
                  imagePreviewBlogPost.src = event.target.result;
                  imagePreviewBlogPost.classList.remove("hidden");
                }
              };
              reader.readAsDataURL(selectedFileBlogPost);
              if (uploadProgressContainerBlogPost)
                uploadProgressContainerBlogPost.classList.add("hidden");
            } else {
              selectedFileBlogPost = null;
              if (imagePreviewBlogPost) {
                imagePreviewBlogPost.classList.add("hidden");
                imagePreviewBlogPost.src = "";
              }
            }
          });
        }

        // 5. 修正用画像プレビュー
        // (グローバルな change イベントリスナーはすでにあるので、そこに追加する形でも良いが、
        //  P2のロジックとしてまとめるため、ここで新たに追加する)
        document.addEventListener("change", (e) => {
          if (e.target.id === "edit-blog-post-image") {
            editFileBlogPost = e.target.files[0]; // (Step 7で定義した変数)
            const preview = document.getElementById(
              "edit-image-preview-blog-post"
            );
            if (editFileBlogPost && preview) {
              const reader = new FileReader();
              reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove("hidden");
              };
              reader.readAsDataURL(editFileBlogPost);
            }
          }
        });

        // --- ★ Phase 3-3: サイトマップDB登録関数 ★ ---
        // --- 15. サイトマップ管理 (Sitemap Logic) ---
        /**
         * サイトマップエントリをFirestoreに登録（または上書き）する
         * @param {string} path - 登録するURLパス (例: "index.html" や "blog/post1.html")
         * @param {string} title - ページのタイトル
         */
        async function addSitemapEntry(path, title) {
          if (!path || !title) {
            showMessage(
              "パスまたはタイトルが不明なため、登録できません。",
              "error"
            );
            return;
          }
          // path を docId として使用し、重複登録を防ぎつつ、情報更新を容易にする
          const docRef = doc(db, "sitemapEntries", path);

          try {
            await setDoc(docRef, {
              title: title,
              path: path, // データとしても path を保持
              lastModified: serverTimestamp(), // 最終更新日
            });

            // --- ★ Phase 3-3 (バグ修正 3/3): 「登録」→「修正/削除」への即時切替 ★ ---
            // 登録したボタン（緑）を探す
            const button = document.querySelector(
              `button[data-path="${path}"]`
            );
            // その親要素(div)を探す
            const buttonContainer = button ? button.parentElement : null;

            if (buttonContainer) {
              // data-title (エンコード済み) を取得
              const encodedTitle = button.dataset.title || "";

              // 「修正」「削除」ボタンのHTMLを生成
              const editDeleteButtonHtml = `
            <button 
              data-doc-id="${path}"
              data-collection="sitemapEntries"
              data-title="${encodedTitle}"
              data-path="${path}"
              class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
              <span class="material-symbols-outlined !text-base">edit</span>
              <span>修正</span>
            </button>
            <button 
              data-doc-id="${path}" 
              data-collection="sitemapEntries" 
              data-image-path="" 
              data-title="${encodedTitle}"
              class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
              <span class="material-symbols-outlined !text-base">delete</span>
              <span>削除</span>
            </button>
          `;

              // ボタンコンテナ(div)の中身を丸ごと差し替える
              buttonContainer.innerHTML = editDeleteButtonHtml;
            }
          } catch (error) {
            console.error("Error adding sitemap entry: ", error);
            showMessage(
              `サイトマップ登録エラー (Path: ${path}): ${error.message}`,
              "error"
            );
          }
        }

        // --- ★ Phase 3-3: サイトマップスキャン実行関数 ★ ---
        async function scanSitePages() {
          if (
            !sitemapLoader ||
            !sitemapListContainer ||
            !sitemapPrompt ||
            !scanSitemapBtn
          )
            return;

          // 1. スキャン開始処理
          sitemapLoader.classList.remove("hidden");
          sitemapPrompt.classList.add("hidden");
          sitemapListContainer.innerHTML = ""; // 古い結果をクリア
          sitemapListContainer.appendChild(sitemapLoader);
          scanSitemapBtn.disabled = true;
          scanSitemapBtn.innerHTML =
            '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>スキャン中...</span>';

          let allPages = []; // サイト内の全ページを格納する配列
          let registeredPaths = new Set(); // 登録済みパスを高速チェックするためのSet

          try {
            // 2. 登録済みのサイトマップエントリを取得
            const sitemapSnapshot = await getDocs(
              collection(db, "sitemapEntries")
            );
            sitemapSnapshot.forEach((doc) => {
              registeredPaths.add(doc.id); // (doc.id === doc.data().path のはず)
            });

            // 3. 主要ページ (STATIC_PAGES) を追加
            STATIC_PAGES.forEach((page) => {
              allPages.push({
                title: page.title,
                path: page.url, // (例: "index.html")
              });
            });

            // 4. Firestoreの各コレクションから「公開URL」を持つアイテムをスキャン
            // (注意: ここでは 'visible: true' などの公開/非公開はチェックしていません)

            // 4a. お知らせ (articles)
            // (メモ: お知らせ自体に詳細ページは無い想定のため、スキャン対象外とする)

            // 4b. 書籍 (books)
            const booksSnapshot = await getDocs(collection(db, "books"));
            booksSnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                // URLがあるものだけ
                allPages.push({ title: `書籍: ${data.title}`, path: data.url });
              }
            });

            // 4c. メディア(アイコン) (mediaIcons)
            const iconsSnapshot = await getDocs(collection(db, "mediaIcons"));
            iconsSnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                // URLがあるものだけ
                allPages.push({
                  title: `メディア: ${data.title}`,
                  path: data.url,
                });
              }
            });

            // 4d. メディア(バナー) (mediaBanners)
            const bannersSnapshot = await getDocs(
              collection(db, "mediaBanners")
            );
            bannersSnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                // URLがあるものだけ
                allPages.push({
                  title: `バナー: ${data.title || data.url}`,
                  path: data.url,
                });
              }
            });

            // 4e. ブログ・HP (sites)
            const sitesSnapshot = await getDocs(collection(db, "sites"));
            sitesSnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                // URLがあるものだけ
                allPages.push({
                  title: `ブログ/HP: ${data.title}`,
                  path: data.url,
                });
              }
            });

            // 4f. ブログ記事 (blogPosts) ★重要★
            const blogPostsSnapshot = await getDocs(
              collection(db, "blogPosts")
            );
            blogPostsSnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                // (例: "blog/post1.html")
                allPages.push({
                  title: `ブログ記事: ${data.title}`,
                  path: data.url,
                });
              }
            });

            // 5. スキャン結果を表示
            sitemapLoader.classList.add("hidden");
            sitemapListContainer.innerHTML = ""; // ローダーを消す

            const siteDomain = SITE_DOMAIN.endsWith("/")
              ? SITE_DOMAIN.slice(0, -1)
              : SITE_DOMAIN;

            // スキャン結果の総数を表示
            const sitemapCountDisplay = document.getElementById(
              "sitemap-count-display"
            );
            if (sitemapCountDisplay) {
              sitemapCountDisplay.textContent = `( ${allPages.length} ページ検出)`;
            }

            if (allPages.length === 0) {
              sitemapListContainer.innerHTML =
                '<p class="text-center text-text-muted-light dark:text-text-muted-dark">スキャン対象のページが見つかりませんでした。</p>';
            }

            allPages.forEach((page) => {
              const isRegistered = registeredPaths.has(page.path);
              const fullUrl = page.path.startsWith("http")
                ? page.path
                : `${siteDomain}/${page.path}`;

              const pageEl = document.createElement("div");
              pageEl.className =
                "flex flex-col sm:flex-row items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

              let buttonHtml = "";

              if (isRegistered) {
                // ★ Phase 3-3 (機能追加 2/4): 「登録済み」を「修正」「削除」ボタンに変更
                // 特殊文字をエンコード
                const encodedTitle = encodeURIComponent(page.title || "");
                const encodedPath = encodeURIComponent(page.path || ""); // pathも念のため

                buttonHtml = `
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <button 
                  data-doc-id="${page.path}"
                  data-collection="sitemapEntries"
                  data-title="${encodedTitle}"
                  data-path="${encodedPath}"
                  class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">edit</span>
                  <span>修正</span>
                </button>
                <button 
                  data-doc-id="${page.path}" 
                  data-collection="sitemapEntries" 
                  data-image-path=""
                  data-title="${encodedTitle}" 
                  class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">

                  <span class="material-symbols-outlined !text-base">delete</span>
                  <span>削除</span>
                </button>
              </div>
            `;
              } else {
                // ★ Phase 3-3 (機能追加 2/4): 「DBに登録」ボタンも div で囲み、レイアウトを統一
                // 特殊文字をエンコード
                const encodedTitle = encodeURIComponent(page.title);
                buttonHtml = `
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <button 
                  data-path="${page.path}"
                  data-title="${encodedTitle}"
                  class="add-sitemap-btn flex-shrink-0 py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center gap-1">
                  <span class="material-symbols-outlined !text-base">add</span>
                  <span>DBに登録</span>
                </button>
              </div>
            `;
              }

              pageEl.innerHTML = `
            <div class="flex-grow w-full">
              <h3 class="text-md font-bold">${page.title}</h3>
              <a href="${fullUrl}" target="_blank" rel="noopener noreferrer" class="text-sm text-primary hover:underline break-all">${page.path}</a>
            </div>
            ${buttonHtml}
          `;
              sitemapListContainer.appendChild(pageEl);
            });
          } catch (error) {
            console.error("Error scanning site pages: ", error);
            showMessage(`サイトスキャンエラー: ${error.message}`, "error");
            sitemapLoader.classList.add("hidden");
            sitemapListContainer.innerHTML = `<p class="text-center text-red-500">サイトスキャンに失敗しました。コンソールを確認してください。</p>`;
          } finally {
            // 6. スキャンボタンを元に戻す
            scanSitemapBtn.disabled = false;
            scanSitemapBtn.innerHTML =
              '<span class="material-symbols-outlined">refresh</span> <span>サイト内全ページのスキャンを再実行</span>';
          }
        }
        // --- ★ Phase 6-2: ボトムナビ管理 (Bottom Navigation CRUD) ★ ---

        // 1. ボトムナビの読み込み
    async function loadBottomNavigation() {
      if (!bottomNavLoader || !bottomNavListContainer) return;
      bottomNavLoader.classList.remove("hidden");
      bottomNavListContainer.innerHTML = ""; // 一旦クリア
      bottomNavListContainer.appendChild(bottomNavLoader);

      try {
        const bottomNavCol = collection(db, "bottomNavigation");
        const q = query(bottomNavCol, orderBy("order", "asc"));
        const querySnapshot = await getDocs(q);

        bottomNavLoader.classList.add("hidden");

        const countDisplay = document.getElementById(
          "bottom-nav-count-display"
        );
        if (countDisplay) {
          countDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
        }

        if (querySnapshot.empty) {
          bottomNavListContainer.innerHTML =
            '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだボトムナビ項目がありません。</p>';
          return;
        }

        bottomNavListContainer.innerHTML = ""; // 古い一覧をクリア

        querySnapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const itemId = docSnap.id;
          const itemEl = document.createElement("div");
          itemEl.className =
            "flex items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";
          
          // ★★★ アイコン表示ロジック (画像優先) ★★★
          let iconDisplayHtml = '';
          if (item.customIconUrl) {
              // 画像がある場合は画像を表示
              iconDisplayHtml = `<img src="${item.customIconUrl}" alt="${item.title}" class="w-10 h-10 object-contain rounded-md bg-slate-100 dark:bg-slate-700">`;
          } else {
              // ない場合はMaterial Iconsを表示
              iconDisplayHtml = `<span class="material-symbols-outlined text-3xl text-primary w-10 h-10 flex items-center justify-center flex-shrink-0">${item.iconName || 'link'}</span>`;
          }

          itemEl.innerHTML = `
            ${iconDisplayHtml}
            <div class="flex-grow w-full">
              <h3 class="text-lg font-bold">${item.title} <span class="text-sm text-text-muted-light"> (表示順: ${item.order})</span></h3>
              <p class="text-sm text-text-muted-light dark:text-text-muted-dark">リンク先: <span class="text-primary font-medium">${item.url}</span></p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
              <button 
                data-doc-id="${itemId}" 
                data-collection="bottomNavigation" 
                data-title="${encodeURIComponent(item.title || '')}"
                data-url="${encodeURIComponent(item.url || '')}"
                data-icon-name="${item.iconName || ''}"
                data-order="${item.order || 10}"
                data-image-url="${item.customIconUrl || ''}" 
                data-image-path="${item.customImagePath || ''}" 
                class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">edit</span>
                <span>修正</span>
              </button>
              <button 
                data-type="bottomNavigation"
                data-title="${encodeURIComponent(item.title || '')}"
                data-url="${encodeURIComponent(item.url || '')}"
                data-image-url="${item.customIconUrl || ''}"
                data-icon="${item.iconName || ''}"
                class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">code</span>
                <span>スニペット</span>
              </button>
              <button data-doc-id="${itemId}" data-collection="bottomNavigation" data-image-path="${item.customImagePath || ''}" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">delete</span>
                <span>削除</span>
              </button>
            </div>
          `;
          bottomNavListContainer.appendChild(itemEl);

          // ★ 強制再バインド (保険的措置)
          const editBtn = itemEl.querySelector('.edit-btn');
          if (editBtn) {
            editBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              const data = { ...editBtn.dataset };
              // URLデコード
              Object.keys(data).forEach((key) => {
                if (["title", "url"].includes(key)) {
                    try { data[key] = decodeURIComponent(data[key]); } catch (e) {}
                }
              });
              openEditModal(data);
            });
          }

          const deleteBtn = itemEl.querySelector('.delete-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              e.preventDefault();
              if (!confirm(`「${item.title}」を削除しますか？`)) return;
              
              deleteBtn.disabled = true;
              try {
                  await deleteDoc(doc(db, "bottomNavigation", itemId));
                  if (item.customImagePath) {
                      try { await deleteObject(ref(storage, item.customImagePath)); } catch (e) { console.warn(e); }
                  }
                  showMessage("項目を削除しました。");
                  loadBottomNavigation();
              } catch (error) {
                  console.error("Delete error:", error);
                  showMessage(`削除エラー: ${error.message}`, "error");
                  deleteBtn.disabled = false;
              }
            });
          }
        });

        // ★ スニペットボタンへのイベントリスナーを直接再付与（強制バインド）
        bottomNavListContainer.querySelectorAll('.get-snippet-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            const data = { ...btn.dataset };
            
            // データのデコード
            Object.keys(data).forEach(key => {
              if (['title', 'url', 'description'].includes(key)) {
                data[key] = decodeURIComponent(data[key] || '');
              }
            });

            // スニペット生成と表示
            const snippetCode = generateGenericSnippet(data);
            showSnippetModal(snippetCode);
          });
        });

      } catch (error) {
        console.error("Error loading bottom navigation: ", error);
        showMessage(
          `ボトムナビの読み込みエラー: ${error.message}`,
          "error"
        );
        bottomNavLoader.classList.add("hidden");
        bottomNavListContainer.innerHTML =
          '<p class="text-center text-red-500">ボトムナビの読み込みに失敗しました。</p>';
      }
    }

        // 3. ボトムナビのフォームリセット
        function resetBottomNavForm() {
          if (addBottomNavForm) addBottomNavForm.reset();
          selectedFileBottomNav = null;
          document.getElementById("bottom-nav-image").value = "";
          if (submitBottomNavBtn) {
            submitBottomNavBtn.disabled = false;
            submitBottomNavBtn.innerHTML =
              '<span class="material-symbols-outlined">add</span> <span>ボトムナビ項目を追加する</span>';
          }
        }
        // 2. ボトムナビの追加
        if (addBottomNavForm) {
          addBottomNavForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("bottom-nav-title").value;
            const url = document.getElementById("bottom-nav-url").value;
            const order = parseInt(document.getElementById("bottom-nav-order").value, 10);
            const iconName = document.getElementById("bottom-nav-icon").value;

            // ★ 画像ファイルを取得
            const imageInput = document.getElementById("bottom-nav-image");
            const file = imageInput ? imageInput.files[0] : null;

            if (submitBottomNavBtn) {
              submitBottomNavBtn.disabled = true;
              submitBottomNavBtn.innerHTML = '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>処理中...</span>';
            }

            try {
              let customIconUrl = "";
              let customImagePath = "";

              // ★ 画像があればアップロード
              if (file) {
                  const userId = auth.currentUser.uid;
                  customImagePath = `images/system/bottom_nav/${userId}/${Date.now()}_${file.name}`;
                  const storageRef = ref(storage, customImagePath);
                  customIconUrl = await uploadImage(storageRef, file, null);
              }

              await addDoc(collection(db, "bottomNavigation"), {
                title: title,
                url: url,
                order: order,
                iconName: iconName,
                // ★ 画像情報を保存
                customIconUrl: customIconUrl,
                customImagePath: customImagePath,
                createdAt: serverTimestamp(),
              });

              showMessage("ボトムナビ項目が正常に追加されました。");
              resetBottomNavForm();
              loadBottomNavigation();
            } catch (error) {
              console.error("Error adding bottom navigation item: ", error);
              showMessage(
                `ボトムナビ項目の追加エラー: ${error.message}`, "error");
              resetBottomNavForm();
            }
          });
        }

        // --- ★ ボトムナビ配置設定の保存 (NEW) ★ ---
        const bottomNavAlignForm = document.getElementById("update-bottom-nav-align-form");
        if (bottomNavAlignForm) {
          bottomNavAlignForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById("save-bottom-nav-align-btn");
            if(submitBtn) submitBtn.disabled = true;

            const alignValue = document.getElementById("bottom-nav-align-select").value;

            try {
              // staticPages/commonSettings に保存
              const docRef = doc(db, "staticPages", "commonSettings");
              await setDoc(docRef, { bottomNavAlign: alignValue }, { merge: true });
              
              showMessage("ボトムナビの配置を保存しました。");
              
              // 即時反映
              if (typeof window.loadBottomNavigation === 'function') {
                  window.loadBottomNavigation(); 
              } else {
                  // common.jsの関数がwindowにない場合はリロード推奨でも可
                  console.log("Reload to see changes");
              }

            } catch (error) {
              console.error("Error saving bottom nav align:", error);
              showMessage(`保存エラー: ${error.message}`, "error");
            } finally {
              if(submitBtn) submitBtn.disabled = false;
            }
          });
        }
        
        // 初期表示時に現在の設定をセレクトボックスに反映
        const alignSelect = document.getElementById("bottom-nav-align-select");
        if (alignSelect) {
            getDoc(doc(db, "staticPages", "commonSettings")).then(snap => {
                if (snap.exists() && snap.data().bottomNavAlign) {
                    alignSelect.value = snap.data().bottomNavAlign;
                }
            });
        }

        // --- ★ 【追加】書籍スニペットモーダル制御ロジック ★ ---
        if (openSnippetModalBtn && snippetModal) {
          // 1. モーダルを開く


          // 2. モーダルを閉じる
          closeSnippetModalBtn.addEventListener("click", () => {
            snippetModal.classList.add("hidden");
          });

          // 3. コピーボタン
          copySnippetButton.addEventListener("click", () => {
            if (snippetCodeArea && copyMessage) {
              snippetCodeArea.select();
              document.execCommand("copy");
              copyMessage.classList.remove("hidden");
              setTimeout(() => {
                copyMessage.classList.add("hidden");
              }, 3000);
            }
          });
        }

        // 4. 書籍スニペット生成関数
        /**
         * トップページに埋め込むための書籍リスト HTML スニペットを生成する
         * @param {QuerySnapshot} querySnapshot - "fixed: true" でフィルタリングされた書籍データ
         * @returns {string} 生成された HTML スニペット
         */
        function generateBookSnippet(querySnapshot) {
          if (querySnapshot.empty) {
            return `
            <div id="top-books-container" class="mt-8 mb-16 px-4">
              <p class="text-center text-text-muted-light dark:text-text-muted-dark">現在、固定表示する書籍はありません。</p>
            </div>
          `;
          }

          let booksHtml = "";
          querySnapshot.forEach((docSnap) => {
            const book = docSnap.data();
            const linkHref = book.url || "#";
            const targetBlank = book.url
              ? 'target="_blank" rel="noopener noreferrer"'
              : "";

            booksHtml += `
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6 rounded-lg bg-card-light dark:bg-card-dark p-6 shadow-md transition-shadow hover:shadow-xl">
              <div class="w-48 md:w-56 flex-shrink-0">
                <img alt="Book cover of ${book.title}" class="rounded-lg shadow-xl w-full h-auto object-cover aspect-[3/4]" src="${book.imageUrl}" onerror="this.src='https://placehold.co/300x400/cccccc/ffffff?text=Image+Not+Found'; this.onerror=null;">
              </div>
              <div class="flex flex-col gap-4 text-center md:text-left">
                <div class="flex flex-col gap-1">
                  <p class="text-text-light dark:text-text-dark text-xl font-bold leading-tight">${book.title}</p>
                  <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal leading-normal">${book.description}</p>
                </div>
                <a class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] transition-transform hover:scale-105 mx-auto md:mx-0 w-fit" href="${linkHref}" ${targetBlank}>
                  <span class="truncate">詳細を見る</span>
                  <span class="material-symbols-outlined ml-2 text-base">arrow_forward</span>
                </a>
              </div>
            </div>
          `;
          });

          // Tailwind/HTML 構造全体を返す
          return `
          <div id="top-books-container" class="mt-8 mb-16 px-4 flex flex-col gap-6">
            <h2 class="text-text-light dark:text-text-dark text-2xl font-bold leading-tight tracking-[-0.015em] pb-3 pt-5 border-b border-primary/20">
              おすすめの書籍 (Books)
            </h2>
            ${booksHtml}
          </div>
          `;
        }

        // --- ★ 汎用アップロード関数 (NEW) ★ ---
        async function uploadImage(storageRef, file, progressBar) {
          return new Promise((resolve, reject) => {
            const uploadTask = uploadBytesResumable(storageRef, file);
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                if (progressBar) {
                  const progress =
                    (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  progressBar.style.width = progress + "%";
                }
              },
              (error) => {
                console.error("Upload Error:", error);
                reject(new Error(`画像アップロード失敗: ${error.message}`));
              },
              async () => {
                try {
                  const downloadURL = await getDownloadURL(
                    uploadTask.snapshot.ref
                  );
                  resolve(downloadURL);
                } catch (getUrlError) {
                  console.error("Get URL Error:", getUrlError);
                  reject(new Error(`画像URL取得失敗: ${getUrlError.message}`));
                }
              }
            );
          });
        }

        // --- ★ Phase 3-3: サイトマップスキャンボタンのイベントリスナー (修正) ★ ---
        if (scanSitemapBtn) {
          scanSitemapBtn.addEventListener("click", scanSitePages); // ★ 仮置きの showMessage から scanSitePages 関数呼び出しに変更
        }
        // リスト検索機能の初期化
        if (document.getElementById('search-dynamic-blogs') && document.getElementById('dynamic-blogs-list-container')) {
            setupListFilter('search-dynamic-blogs', 'dynamic-blogs-list-container');
        }
        if (document.getElementById('search-blog-posts') && document.getElementById('blog-posts-list-container')) {
            setupListFilter('search-blog-posts', 'blog-posts-list-container');
        }
        if (document.getElementById('search-articles') && document.getElementById('articles-list-container')) {
            setupListFilter('search-articles', 'articles-list-container');
        }
        if (document.getElementById('search-sitemap') && document.getElementById('sitemap-list-container')) {
            setupListFilter('search-sitemap', 'sitemap-list-container');
        }

        // 動的ブログの画像選択時処理
        if (dynamicPostImage) {
            dynamicPostImage.addEventListener("change", (e) => {
                dynamicFileImage = e.target.files[0];
                if (dynamicFileImage) {
                    imagePreviewDynamicPost.src = URL.createObjectURL(dynamicFileImage);
                    imagePreviewDynamicPost.classList.remove("hidden");
                } else {
                    imagePreviewDynamicPost.classList.add("hidden");
                    imagePreviewDynamicPost.src = "";
                }
            });
        }

        // ★ 動的ブログ プレビューボタンのイベントリスナー (NEW)
        const previewDynamicBlogBtn = document.getElementById("preview-dynamic-blog-btn");
        if (previewDynamicBlogBtn) {
          previewDynamicBlogBtn.addEventListener("click", async (e) => { // asyncを追加
             e.preventDefault(); // 念のため

             const title = document.getElementById("dynamic-post-title").value;
             const fileInput = document.getElementById("dynamic-post-image");
             let imageHtml = '';
   
             // 画像の処理 (ローカルファイルを読み込む)
             if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                // Promiseで読み込みを待機
                const base64 = await new Promise(resolve => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                imageHtml = `<img src="${base64}" class="w-full h-auto max-h-96 object-cover rounded-lg mb-8">`;
             }
   
             // HTMLブロックの収集
             const contentBlocks = [];
             document.querySelectorAll('#html-blocks-container .dynamic-html-block').forEach(textarea => {
               contentBlocks.push(textarea.value);
             });
   
             // プレビュー用HTML構築
             const fullHtml = `
               <div class="container mx-auto max-w-3xl p-8 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200">
                 <h1 class="text-3xl font-bold mb-4">${title}</h1>
                 ${imageHtml}
                 <div class="prose prose-lg dark:prose-invert max-w-none">
                   ${contentBlocks.join('')}
                 </div>
               </div>
             `;
             
             localStorage.setItem('snippetPreviewCode', fullHtml);
             window.open('preview.html', '_blank');
          });
        }

        if (addDynamicBlogForm) {
          addDynamicBlogForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = dynamicPostTitle.value;
            // [addDynamicBlogForm submitリスナー内: const title = ... の直後に追加]

            // すべてのHTMLブロックから内容を配列として収集
            const contentBlocks = [];
            document.querySelectorAll('.dynamic-html-block').forEach(textarea => {
              contentBlocks.push(textarea.value);
            });

            const submitBtn = document.getElementById("submit-dynamic-post-btn");

            if (contentBlocks.length === 0) {
              showMessage('記事本文（HTMLブロック）を1つ以上追加してください。', 'error');
              // ボタンの無効化を解除（finallyブロックで処理されるが、ここで即時解除）
              if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = '<span class="material-symbols-outlined">save</span> <span>記事を保存する</span>';
              }
              return;
            }

            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML =
                '<div class="loader !w-6 !h-6 !border-t-white !border-slate-200/50"></div> <span>保存中...</span>';
            }

            try {
              let imageUrl = "";
              let imagePath = "";
              if (dynamicFileImage) {
                const userId = auth.currentUser.uid;
                if (!userId) throw new Error("ユーザーが認証されていません。");
                imagePath = `images/photo/blog_contents/${userId}/${Date.now()}_${dynamicFileImage.name}`;
                const storageRef = ref(storage, imagePath);
                imageUrl = await uploadImage(
                  storageRef,
                  dynamicFileImage,
                  uploadProgressBarDynamicPost
                );
              }

              await addDoc(collection(db, "blogContents"), {
                title: title,
                contentBlocks: contentBlocks, // ⬅️ content から contentBlocks に変更し、配列を保存
                imageUrl: imageUrl, // 画像URL（ファイルがある場合）
                imagePath: imagePath, // 画像パス（ファイルがある場合）
                timestamp: serverTimestamp(), // 現在のサーバータイムスタンプ
              });

              // 成功時の処理の置き換え（tryブロック内部）
              
              // 1. メッセージとフォームのリセット
              showMessage("記事を保存しました。"); 
              addDynamicBlogForm.reset();
              if(blocksContainer) blocksContainer.innerHTML = ''; 
              dynamicFileImage = null;
              imagePreviewDynamicPost.classList.add("hidden");
              imagePreviewDynamicPost.src = "";
              if (uploadProgressContainerDynamicPost) {
                uploadProgressContainerDynamicPost.classList.add("hidden");
                uploadProgressBarDynamicPost.style.width = "0%";
              }
              
              // 2. 確実に一覧を再読み込み
              await loadDynamicBlogs(); 
            } catch (error) {
              showMessage(`記事の保存エラー: ${error.message}`, "error");
            } finally {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML =
                  '<span class="material-symbols-outlined">save</span> <span>記事を保存する</span>';
              }
            }
          });
        }
        // --- ★ 動的ブログ記事一覧の読み込みロジック (NEW) ★ ---
    async function loadDynamicBlogs() {
      const dynamicBlogsListContainer = document.getElementById("dynamic-blogs-list-container");
      const dynamicBlogsLoader = document.getElementById("dynamic-blogs-loader");
      if (!dynamicBlogsLoader || !dynamicBlogsListContainer) {
          return;
      }
      
      dynamicBlogsLoader.classList.remove("hidden");
      dynamicBlogsListContainer.innerHTML = "";
      dynamicBlogsListContainer.appendChild(dynamicBlogsLoader);

      try {
        const blogContentsCol = collection(db, "blogContents");
        const q = query(blogContentsCol, orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);

        dynamicBlogsLoader.classList.add("hidden");
        
        const countDisplay = document.getElementById("dynamic-blogs-count-display");
        if (countDisplay) {
          countDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
        }

        if (querySnapshot.empty) {
          dynamicBlogsListContainer.innerHTML =
            '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ記事がありません。</p>';
          return;
        }

        let html = "";
        let itemCounter = 0;
        
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const docId = docSnap.id;
          
          let dateStr = "日付不明";
          if (data.timestamp?.toDate) {
            try { dateStr = data.timestamp.toDate().toLocaleDateString("ja-JP"); } catch (e) { /* silent */ }
          }
          
          // --- HTML生成ロジック (既存のロジックを維持し、画像/スニペットボタンを含む) ---
          const imageHtml = data.imageUrl
            ? `<img src="${data.imageUrl}" alt="${data.title || "記事画像"}" class="w-full sm:w-32 h-auto object-cover rounded-md flex-shrink-0" onerror="this.src='https://placehold.co/300x200/cccccc/ffffff?text=No+Image'; this.onerror=null;">`
            : `<div class="w-full sm:w-32 h-20 bg-slate-200 dark:bg-slate-700 rounded-md flex items-center justify-center text-text-muted-light dark:text-text-muted-dark text-sm flex-shrink-0">画像なし</div>`;

          const contentPreview = (data.contentBlocks || []).join(' ').replace(/<[^>]*>?/gm, '').substring(0, 100);

          const itemEl = document.createElement('div');
          itemEl.className = "flex flex-col sm:flex-row items-start gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-slate-200 dark:border-slate-700";

          itemEl.innerHTML = `
            ${imageHtml}
            <div class="flex-grow">
              <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${dateStr}</p>
              <h3 class="text-lg font-bold mt-1">${data.title || "タイトルなし"}</h3>
              <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1 font-mono">ID: ${docId}</p>
              <p class="text-sm mt-2 text-text-light dark:text-text-dark">${contentPreview}...</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
              <button data-doc-id="${docId}" data-collection="blogContents" data-title="${encodeURIComponent(data.title || '')}" data-image-url="${data.imageUrl || ''}" data-image-path="${data.imagePath || ''}" data-content-blocks="${encodeURIComponent(JSON.stringify(data.contentBlocks || []))}" class="edit-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">edit</span>
                <span>修正</span>
              </button>
              <button data-type="dynamicBlog" data-title="${encodeURIComponent(data.title || '')}" data-url="blog-detail.html?id=${docId}" data-image-url="${data.imageUrl || ''}" data-description="${encodeURIComponent(contentPreview)}" data-date="${dateStr}" class="get-snippet-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">code</span>
                <span>スニペット</span>
              </button>
              <button data-doc-id="${docId}" data-collection="blogContents" data-image-path="${data.imagePath || ''}" class="delete-btn flex-shrink-0 py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1">
                <span class="material-symbols-outlined !text-base">delete</span>
                <span>削除</span>
              </button>
            </div>
          `;
          dynamicBlogsListContainer.appendChild(itemEl);
          itemCounter++;
        });

        return; // ★ 正常終了時はここで確実に終了
        
      } catch (error) {
        dynamicBlogsLoader.classList.add("hidden");
        dynamicBlogsListContainer.innerHTML = `<p class="text-center text-red-500">記事の読み込み中に致命的なエラーが発生しました。</p>`;
      }
        }

        // --- カスタムHTMLブロック追加/削除ロジック ---
        const addHtmlBlockBtn = document.getElementById('add-html-block-btn');
        const blocksContainer = document.getElementById('html-blocks-container');

        // 「HTMLブロックを追加」ボタンのイベントリスナー
        if (addHtmlBlockBtn) {
          addHtmlBlockBtn.addEventListener('click', () => addContentBlock({ type: 'html' }));
        }

        // 「スペーサーを追加」モーダルを開くボタン
        const openSpacerModalBtn = document.getElementById('open-add-spacer-modal-btn');
        if (openSpacerModalBtn) {
          openSpacerModalBtn.addEventListener('click', () => {
            const modal = document.getElementById('add-spacer-modal');
            if (modal) modal.classList.remove('hidden');
          });
        }

        // 「削除」ボタンのイベントリスナー（イベント委任）
        if (blocksContainer) {
          blocksContainer.addEventListener('click', (e) => {
            if (e.target.closest('.delete-block-btn')) {
              e.target.closest('.html-block-wrapper').remove();
            }
          });
        }

        // ========================================
        // カスタムHTML部品管理
        // ========================================
        
        const customPartsListContainer = document.getElementById('custom-parts-list-container');
        const customPartsLoader = document.getElementById('custom-parts-loader');
        const customPartsCountDisplay = document.getElementById('custom-parts-count-display');
        const searchCustomPartsInput = document.getElementById('search-custom-parts');
        const filterCategorySelect = document.getElementById('filter-custom-parts-category');
        const includeArchivedCheckbox = document.getElementById('include-archived-parts');
        const addCustomPartBtn = document.getElementById('add-custom-part-btn');
        const customPartModal = document.getElementById('cp-modal');
        const customPartForm = document.getElementById('cp-form');
        const customPartModalTitle = document.getElementById('cp-modal-title');
        // const refreshPreviewBtn = document.getElementById('refresh-preview-btn'); // Removed
        const customPartHtmlInput = document.getElementById('cp-input-html');
        // const customPartPreview = document.getElementById('cp-preview'); // Removed
        const previewCustomPartBtn = document.getElementById('preview-custom-part-btn');

        // カスタムHTML部品を読み込む
        async function loadCustomParts() {
          if (!customPartsLoader || !customPartsListContainer) return;
          
          customPartsLoader.classList.remove('hidden');
          customPartsListContainer.innerHTML = '';
          
          try {
            const searchKeyword = searchCustomPartsInput?.value.toLowerCase() || '';
            const categoryFilter = filterCategorySelect?.value || '';
            const includeArchived = includeArchivedCheckbox?.checked || false;
            
            let q = query(collection(db, 'customParts'), orderBy('updatedAt', 'desc'));
            const querySnapshot = await getDocs(q);
            
            customPartsLoader.classList.add('hidden');
            
            if (customPartsCountDisplay) {
              customPartsCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }
            
            if (querySnapshot.empty) {
              customPartsListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ部品がありません。</p>';
              return;
            }
            
            let filteredCount = 0;
            querySnapshot.forEach((docSnap) => {
              const data = docSnap.data();
              const docId = docSnap.id;
              
              // フィルタリング
              if (!includeArchived && data.isArchived) return;
              if (categoryFilter && data.category !== categoryFilter) return;
              if (searchKeyword) {
                const titleMatch = (data.title || '').toLowerCase().includes(searchKeyword);
                const memoMatch = (data.memo || '').toLowerCase().includes(searchKeyword);
                if (!titleMatch && !memoMatch) return;
              }
              
              filteredCount++;
              
              const updatedAt = data.updatedAt?.toDate?.() || new Date();
              const updatedStr = updatedAt.toLocaleDateString('ja-JP');
              const memoPreview = (data.memo || '').substring(0, 50) + ((data.memo || '').length > 50 ? '...' : '');
              const iconName = data.icon || 'code';
              
              const cardEl = document.createElement('div');
              cardEl.className = 'bg-background-light dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 hover:shadow-md transition-shadow';
              cardEl.innerHTML = `
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                    <span class="material-symbols-outlined text-4xl text-primary">${iconName}</span>
                  </div>
                  <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2 mb-2">
                      <h4 class="text-lg font-bold truncate">${data.title || 'タイトルなし'}</h4>
                      <span class="px-2 py-1 text-xs font-bold rounded-full bg-primary/10 text-primary">${data.category || 'その他'}</span>
                      ${data.isArchived ? '<span class="px-2 py-1 text-xs font-bold rounded-full bg-slate-500/10 text-slate-500">アーカイブ</span>' : ''}
                    </div>
                    ${memoPreview ? `<p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-2">${memoPreview}</p>` : ''}
                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark">更新日: ${updatedStr}</p>
                    
                    <!-- プレビュー -->
                    <div class="mt-3 p-3 border border-slate-200 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 max-h-32 overflow-auto">
                      <div class="custom-part-preview-content">${data.htmlContent || ''}</div>
                    </div>
                  </div>
                  <div class="flex flex-col gap-2 flex-shrink-0">
                    <button
                      data-id="${docId}"
                      class="copy-internal-snippet-btn py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center gap-1"
                    >
                      <span class="material-symbols-outlined !text-base">content_copy</span>
                      <span>内部タグ</span>
                    </button>
                    <button
                      data-id="${docId}"
                      class="copy-external-snippet-btn py-2 px-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center gap-1"
                    >
                      <span class="material-symbols-outlined !text-base">code</span>
                      <span>外部埋め込み</span>
                    </button>
                    <button
                      data-id="${docId}"
                      class="edit-custom-part-btn py-2 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-1"
                    >
                      <span class="material-symbols-outlined !text-base">edit</span>
                      <span>編集</span>
                    </button>
                    <button
                      data-id="${docId}"
                      data-archived="${data.isArchived || false}"
                      class="archive-custom-part-btn py-2 px-4 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center gap-1"
                    >
                      <span class="material-symbols-outlined !text-base">${data.isArchived ? 'unarchive' : 'archive'}</span>
                      <span>${data.isArchived ? '復元' : 'アーカイブ'}</span>
                    </button>
                    <button
                      data-id="${docId}"
                      class="delete-custom-part-btn py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center gap-1"
                    >
                      <span class="material-symbols-outlined !text-base">delete</span>
                      <span>削除</span>
                    </button>
                  </div>
                </div>
              `;
              customPartsListContainer.appendChild(cardEl);
            });
            
            if (filteredCount === 0) {
              customPartsListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">条件に一致する部品がありません。</p>';
            }
            
          } catch (error) {
            customPartsLoader.classList.add('hidden');
            customPartsListContainer.innerHTML = '<p class="text-center text-red-500">部品の読み込み中にエラーが発生しました。</p>';
            console.error('Error loading custom parts:', error);
          }
        }

        // カスタムHTML部品を保存
        async function saveCustomPart(e) {
          e.preventDefault();
          
          const docId = document.getElementById('cp-input-id')?.value;
          const title = document.getElementById('cp-input-title')?.value;
          const category = document.getElementById('cp-input-category')?.value;
          const icon = document.getElementById('cp-input-icon')?.value;
          const memo = document.getElementById('cp-input-memo')?.value;
          const htmlContent = document.getElementById('cp-input-html')?.value;
          
          if (!title || !htmlContent) {
            showMessage('タイトルとHTMLコードは必須です。', 'error');
            return;
          }
          
          try {
            const partData = {
              title,
              htmlContent,
              category: category || 'その他',
              icon: icon || 'code',
              memo: memo || '',
              isArchived: false,
              updatedAt: serverTimestamp()
            };
            
            if (docId) {
              // 更新
              await updateDoc(doc(db, 'customParts', docId), partData);
              showMessage('部品を更新しました。', 'success');
            } else {
              // 新規作成
              partData.createdAt = serverTimestamp();
              await addDoc(collection(db, 'customParts'), partData);
              showMessage('部品を作成しました。', 'success');
            }
            
            customPartModal?.classList.add('hidden');
            customPartForm?.reset();
            loadCustomParts();
            
          } catch (error) {
            showMessage('保存中にエラーが発生しました。', 'error');
            console.error('Error saving custom part:', error);
          }
        }

        // 内部用スニペットをコピー
        function copyInternalSnippet(id) {
          const snippet = `<div id="custom-part-${id}" class="mt-16 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8"></div>`;
          navigator.clipboard.writeText(snippet).then(() => {
            showMessage('内部用タグをコピーしました。', 'success');
          }).catch((error) => {
            showMessage('コピーに失敗しました。', 'error');
            console.error('Error copying internal snippet:', error);
          });
        }

        // 外部用スニペットをコピー
        function copyExternalSnippet(id) {
          const origin = window.location.origin;
          const snippet = `<iframe src="${origin}/embed.html?id=${id}" width="100%" height="400" frameborder="0" style="border:none; overflow:hidden;"></iframe>`;
          navigator.clipboard.writeText(snippet).then(() => {
            showMessage('外部用コードをコピーしました。', 'success');
          }).catch((error) => {
            showMessage('コピーに失敗しました。', 'error');
            console.error('Error copying external snippet:', error);
          });
        }

        // アーカイブ/復元
        async function archiveCustomPart(id, isArchived) {
          try {
            await updateDoc(doc(db, 'customParts', id), {
              isArchived: !isArchived,
              updatedAt: serverTimestamp()
            });
            showMessage(isArchived ? '部品を復元しました。' : '部品をアーカイブしました。', 'success');
            loadCustomParts();
          } catch (error) {
            showMessage('操作中にエラーが発生しました。', 'error');
            console.error('Error archiving custom part:', error);
          }
        }

        // 削除
        async function deleteCustomPart(id) {
          if (!confirm('この部品を完全に削除しますか?')) return;
          
          try {
            await deleteDoc(doc(db, 'customParts', id));
            showMessage('部品を削除しました。', 'success');
            loadCustomParts();
          } catch (error) {
            showMessage('削除中にエラーが発生しました。', 'error');
            console.error('Error deleting custom part:', error);
          }
        }

        // プレビュー更新 (削除済み)
        // function updatePreview() { ... }

        // モーダルを開く（新規作成）
        if (addCustomPartBtn) {
          addCustomPartBtn.addEventListener('click', () => {
            customPartForm?.reset();
            document.getElementById('cp-input-id').value = '';
            customPartModalTitle.textContent = 'カスタムHTML部品を作成';
            customPartModal?.classList.remove('hidden');
            // updatePreview(); // Removed
          });
        }

        // フォーム送信
        if (customPartForm) {
          customPartForm.addEventListener('submit', saveCustomPart);
        }

        // プレビュー更新ボタン (削除済み)
        /*
        if (refreshPreviewBtn) {
          refreshPreviewBtn.addEventListener('click', updatePreview);
          }
        */

        // 新しいタブでプレビュー
        if (previewCustomPartBtn) {
          previewCustomPartBtn.addEventListener('click', () => {
            const htmlValue = customPartHtmlInput?.value;
            if (!htmlValue) {
              alert('HTMLコードを入力してください。');
              return;
            }
            localStorage.setItem('snippetPreviewCode', htmlValue);
            window.open('preview.html', '_blank');
          });
        }

      // ★ Nested Tabs Initialization (Grandchildren Tabs)
      function setupNestedTabs() {
        const nestedTabGroups = [
            { navId: 'nested-tabs-nav-settings', contentClass: 'nested-tab-content' },
            { navId: 'nested-tabs-site-common', contentClass: 'nested-tab-content' }
        ];

        nestedTabGroups.forEach(group => {
            const navContainer = document.getElementById(group.navId);
            if (!navContainer) return;

            const tabs = navContainer.querySelectorAll('.nested-tab-btn');
            const contents = navContainer.parentElement.parentElement.querySelectorAll(`.${group.contentClass}`);

            tabs.forEach(btn => {
                // Remove existing listeners (simple clone replacement)
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });

            // Re-select after replacement
            const refreshedTabs = navContainer.querySelectorAll('.nested-tab-btn');

            refreshedTabs.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent bubbling to parent tabs
                    
                    // Deactivate all tabs in this group
                    refreshedTabs.forEach(b => {
                        b.classList.remove('active', 'border-b-2', 'border-primary', 'text-primary');
                        b.classList.add('text-slate-500', 'dark:text-slate-400');
                    });

                    // Activate clicked tab
                    btn.classList.add('active', 'border-b-2', 'border-primary', 'text-primary');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400');

                    // Hide all contents in this group
                    // Note: We need to be careful to only hide contents belonging to this specific nested group
                    // The structure is: Parent -> [Nav, Content1, Content2]
                    // So we can find siblings of the nav container's parent? 
                    // Or just use IDs since they are unique.
                    
                    const targetId = `nested-content-${btn.dataset.nestedTab}`;
                    const targetContent = document.getElementById(targetId);
                    
                    // Hide all potential contents for this group
                    // We can identify them by checking if they are siblings or by specific IDs if we know them.
                    // Since we used specific IDs in HTML, let's just hide the known ones for each group.
                    
                    if (group.navId === 'nested-tabs-nav-settings') {
                        document.getElementById('nested-content-global-nav')?.classList.add('hidden');
                        document.getElementById('nested-content-bottom-nav')?.classList.add('hidden');
                    } else if (group.navId === 'nested-tabs-site-common') {
                        document.getElementById('nested-content-header-cta')?.classList.add('hidden');
                        document.getElementById('nested-content-footer')?.classList.add('hidden');
                    }

                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        });
      }

        // HTMLエディタの入力時に自動プレビュー更新 (削除済み)
        /*
        if (customPartHtmlInput) {
          customPartHtmlInput.addEventListener('input', updatePreview);
        }
        */

        // 検索・フィルタ
        if (searchCustomPartsInput) {
          searchCustomPartsInput.addEventListener('input', loadCustomParts);
        }
        if (filterCategorySelect) {
          filterCategorySelect.addEventListener('change', loadCustomParts);
        }
        if (includeArchivedCheckbox) {
          includeArchivedCheckbox.addEventListener('change', loadCustomParts);
        }

        // イベント委任（編集・削除・アーカイブ・スニペットコピー）
        if (customPartsListContainer) {
          customPartsListContainer.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-custom-part-btn');
            const deleteBtn = e.target.closest('.delete-custom-part-btn');
            const archiveBtn = e.target.closest('.archive-custom-part-btn');
            const copyInternalBtn = e.target.closest('.copy-internal-snippet-btn');
            const copyExternalBtn = e.target.closest('.copy-external-snippet-btn');
            
            if (editBtn) {
              const id = editBtn.dataset.id;
              try {
                const docSnap = await getDoc(doc(db, 'customParts', id));
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  document.getElementById('cp-input-id').value = id;
                  document.getElementById('cp-input-title').value = data.title || '';
                  document.getElementById('cp-input-category').value = data.category || 'その他';
                  document.getElementById('cp-input-icon').value = data.icon || '';
                  document.getElementById('cp-input-memo').value = data.memo || '';
                  document.getElementById('cp-input-html').value = data.htmlContent || '';
                  customPartModalTitle.textContent = 'カスタムHTML部品を編集';
                  customPartModal?.classList.remove('hidden');
                  // updatePreview(); // Removed
                }
              } catch (error) {
                showMessage('部品の読み込みに失敗しました。', 'error');
                console.error('Error loading custom part:', error);
              }
            } else if (deleteBtn) {
              deleteCustomPart(deleteBtn.dataset.id);
            } else if (archiveBtn) {
              const isArchived = archiveBtn.dataset.archived === 'true';
              archiveCustomPart(archiveBtn.dataset.id, isArchived);
            } else if (copyInternalBtn) {
              copyInternalSnippet(copyInternalBtn.dataset.id);
            } else if (copyExternalBtn) {
              copyExternalSnippet(copyExternalBtn.dataset.id);
            }
          });
        }

        // タブ切り替え時にカスタムHTML部品を読み込む
        const customHtmlTabBtn = document.querySelector('[data-tab="custom-html"]');
        if (customHtmlTabBtn) {
          customHtmlTabBtn.addEventListener('click', () => {
            loadCustomParts();
          });
        }

        // ========================================
        // 登録リンク管理 (Saved Links)
        // ========================================
        // const savedLinksListContainer = document.getElementById('saved-links-list-container');
        const savedLinksLoader = document.getElementById('saved-links-loader');
        const savedLinksCountDisplay = document.getElementById('saved-links-count-display');
        const searchSavedLinksInput = document.getElementById('search-saved-links');
        const addSavedLinkForm = document.getElementById('add-saved-link-form');

        let isSavedLinksLoading = false;

        async function loadSavedLinks() {
          const savedLinksListContainer = document.getElementById('saved-links-list-container');
          if (!savedLinksLoader || !savedLinksListContainer) return;
          
          if (isSavedLinksLoading) return;
          isSavedLinksLoading = true;

          savedLinksLoader.classList.remove('hidden');
          savedLinksListContainer.innerHTML = '';
          
          try {
            const searchKeyword = searchSavedLinksInput?.value.toLowerCase() || '';
            
            let q = query(collection(db, 'savedLinks'), orderBy('createdAt', 'desc'));
            const querySnapshot = await getDocs(q);
            
            savedLinksLoader.classList.add('hidden');
            
            if (savedLinksCountDisplay) {
              savedLinksCountDisplay.textContent = `(全 ${querySnapshot.size} 件)`;
            }
            
            if (querySnapshot.empty) {
              savedLinksListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">まだ登録されたリンクがありません。</p>';
              return;
            }
            
            let filteredCount = 0;
            querySnapshot.forEach((docSnap) => {
              const data = docSnap.data();
              const docId = docSnap.id;
              
              // 検索フィルタ
              if (searchKeyword) {
                const titleMatch = (data.title || '').toLowerCase().includes(searchKeyword);
                const urlMatch = (data.url || '').toLowerCase().includes(searchKeyword);
                const memoMatch = (data.memo || '').toLowerCase().includes(searchKeyword);
                if (!titleMatch && !urlMatch && !memoMatch) return;
              }
              
              filteredCount++;
              
              const itemEl = document.createElement('div');
              itemEl.className = 'flex flex-col sm:flex-row items-start sm:items-center gap-4 p-4 bg-background-light dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 hover:shadow-md transition-shadow';
              
              itemEl.innerHTML = `
                <div class="flex-grow min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <h4 class="text-lg font-bold truncate">${data.title || 'タイトルなし'}</h4>
                    ${data.memo ? `<span class="text-xs text-text-muted-light dark:text-text-muted-dark bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">${data.memo}</span>` : ''}
                  </div>
                  <div class="flex items-center gap-2 text-sm text-primary truncate">
                    <span class="material-symbols-outlined !text-base">link</span>
                    <a href="${data.url}" target="_blank" class="hover:underline truncate">${data.url}</a>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                  <button
                    data-url="${data.url}"
                    class="copy-link-btn py-2 px-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-1 flex-grow sm:flex-grow-0"
                    title="URLをコピー"
                  >
                    <span class="material-symbols-outlined !text-base">content_copy</span>
                    <span class="sm:hidden">コピー</span>
                  </button>
                  <button
                    data-doc-id="${docId}"
                    data-collection="savedLinks"
                    data-title="${data.title || ''}"
                    data-url="${data.url || ''}"
                    data-memo="${data.memo || ''}"
                    class="edit-btn py-2 px-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center justify-center gap-1 flex-grow sm:flex-grow-0"
                  >
                    <span class="material-symbols-outlined !text-base">edit</span>
                    <span class="sm:hidden">編集</span>
                  </button>
                  <button
                    data-doc-id="${docId}"
                    data-collection="savedLinks"
                    class="delete-btn py-2 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center justify-center gap-1 flex-grow sm:flex-grow-0"
                  >
                    <span class="material-symbols-outlined !text-base">delete</span>
                    <span class="sm:hidden">削除</span>
                  </button>
                </div>
              `;
              savedLinksListContainer.appendChild(itemEl);
            });
            
            if (filteredCount === 0) {
              savedLinksListContainer.innerHTML = '<p class="text-center text-text-muted-light dark:text-text-muted-dark">条件に一致するリンクがありません。</p>';
            }
            
          } catch (error) {
            // エラー時もコンテナを再取得してメッセージ表示
            const savedLinksListContainer = document.getElementById('saved-links-list-container');
            if (savedLinksListContainer) {
                savedLinksListContainer.innerHTML = '<p class="text-center text-red-500">リンクの読み込み中にエラーが発生しました。</p>';
            }
            console.error('Error loading saved links:', error);
          } finally {
            isSavedLinksLoading = false;
            savedLinksLoader.classList.add('hidden');
          }
        }

        // リンク登録フォーム送信
        if (addSavedLinkForm) {
          addSavedLinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('saved-link-title').value;
            const url = document.getElementById('saved-link-url').value;
            const memo = document.getElementById('saved-link-memo').value;
            
            if (!title || !url) return;
            
            try {
              await addDoc(collection(db, 'savedLinks'), {
                title,
                url,
                memo,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              });
              
              addSavedLinkForm.reset();
              showMessage('リンクを登録しました。', 'success');
              loadSavedLinks();
            } catch (error) {
              console.error('Error adding saved link:', error);
              showMessage('リンクの登録に失敗しました。', 'error');
            }
          });
        }

        // 検索ボックス
        if (searchSavedLinksInput) {
          searchSavedLinksInput.addEventListener('input', loadSavedLinks);
        }

        // --- ★ 登録リンク管理のイベントリスナー (NEW) ★ ---
        const savedLinksContainer = document.getElementById("saved-links-list-container");
        if (savedLinksContainer) {
          const newContainer = savedLinksContainer.cloneNode(true);
          savedLinksContainer.parentNode.replaceChild(newContainer, savedLinksContainer);

          newContainer.addEventListener("click", async (e) => {
            // 1. コピーボタン
            const copyBtn = e.target.closest(".copy-link-btn");
            if (copyBtn) {
              e.stopPropagation();
              e.preventDefault();
              const url = decodeURIComponent(copyBtn.dataset.url || '');
              try {
                await navigator.clipboard.writeText(url);
                showMessage("リンクをコピーしました！");
              } catch (err) {
                console.error("Copy failed:", err);
                showMessage("コピーに失敗しました", "error");
              }
              return;
            }

            // 2. 修正ボタン (共通の edit-btn クラスを使用)
            const editBtn = e.target.closest(".edit-btn");
            if (editBtn) {
              e.stopPropagation();
              e.preventDefault();
              const data = { ...editBtn.dataset };
              // データのデコード
              Object.keys(data).forEach(key => {
                  if (['title', 'url', 'memo'].includes(key)) {
                      try { data[key] = decodeURIComponent(data[key]); } catch (e) {}
                  }
              });
              openEditModal(data);
              return;
            }

            // 3. 削除ボタン (共通の delete-btn クラスを使用)
            const deleteBtn = e.target.closest(".delete-btn");
            if (deleteBtn) {
              e.stopPropagation();
              e.preventDefault();
              const docId = deleteBtn.dataset.docId;
              if (!docId) return;

              if (!confirm("このリンクを削除してもよろしいですか？")) return;

              try {
                const deleteBtn = e.target.closest(".delete-btn");
                if (deleteBtn) deleteBtn.disabled = true; // 連打防止
                
                await deleteDoc(doc(db, "savedLinks", docId));
                showMessage("リンクを削除しました。", "success");
                loadSavedLinks();

              } catch (error) {
                console.error("Error deleting link:", error);
                showMessage(`削除エラー: ${error.message}`, "error");
              }
            }
          });
        }

        // --- ★ ナビゲーション管理のイベントリスナー (ボタン反応なし修正) ★ ---
        const navListContainer = document.getElementById("navigation-list-container");
        if (navListContainer) {
          navListContainer.addEventListener("click", async (e) => {
            // 1. 修正ボタン
            const editBtn = e.target.closest(".edit-btn");
            if (editBtn) {
              e.stopPropagation();
              e.preventDefault();
              
              const data = { ...editBtn.dataset };
              // データのデコード (タイトルやURLなど)
              Object.keys(data).forEach(key => {
                if (['title', 'url'].includes(key)) {
                   try { data[key] = decodeURIComponent(data[key]); } catch (err) {}
                }
              });
              
              // 編集モーダルを開く (既存の openEditModal 関数を利用)
              openEditModal(data);
              return;
            }

            // 2. 削除ボタン
            const deleteBtn = e.target.closest(".delete-btn");
            if (deleteBtn) {
              e.stopPropagation();
              e.preventDefault();
              
              const docId = deleteBtn.dataset.docId;
              if (!docId) return;

              if (!confirm("このメニュー項目を削除してもよろしいですか？")) return;

              // ボタンを無効化して連打防止
              deleteBtn.disabled = true;

              try {
                await deleteDoc(doc(db, "navigation", docId));
                showMessage("メニュー項目を削除しました。");
                loadNavigation(); // リストを再読み込み
              } catch (error) {
                console.error("Navigation delete error:", error);
                showMessage(`削除エラー: ${error.message}`, "error");
                deleteBtn.disabled = false;
              }
            }
          });
        }

        // タブ切り替え時に読み込み
        const savedLinksTabBtn = document.querySelector('[data-tab="saved-links"]');
        if (savedLinksTabBtn) {
          savedLinksTabBtn.addEventListener('click', () => {
            loadSavedLinks();
          });
        }

      // ★ Nested Tabs Initialization (Grandchildren Tabs)
      function setupNestedTabs() {
        const nestedTabGroups = [
            { navId: 'nested-tabs-nav-settings', contentClass: 'nested-tab-content' },
            { navId: 'nested-tabs-site-common', contentClass: 'nested-tab-content' }
        ];

        nestedTabGroups.forEach(group => {
            const navContainer = document.getElementById(group.navId);
            if (!navContainer) return;

            const tabs = navContainer.querySelectorAll('.nested-tab-btn');
            
            // Re-select tabs to ensure fresh listeners if needed
            tabs.forEach(btn => {
                // Clone to remove old listeners
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });

            const refreshedTabs = navContainer.querySelectorAll('.nested-tab-btn');

            refreshedTabs.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    
                    // Deactivate all tabs in this group
                    refreshedTabs.forEach(b => {
                        b.classList.remove('active', 'border-b-2', 'border-primary', 'text-primary');
                        b.classList.add('text-slate-500', 'dark:text-slate-400');
                    });

                    // Activate clicked tab
                    btn.classList.add('active', 'border-b-2', 'border-primary', 'text-primary');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400');

                    // Switch content visibility
                    if (group.navId === 'nested-tabs-nav-settings') {
                        document.getElementById('nested-content-global-nav')?.classList.add('hidden');
                        document.getElementById('nested-content-bottom-nav')?.classList.add('hidden');
                    } else if (group.navId === 'nested-tabs-site-common') {
                        document.getElementById('nested-content-header-cta')?.classList.add('hidden');
                        document.getElementById('nested-content-footer')?.classList.add('hidden');
                    }

                    const targetId = `nested-content-${btn.dataset.nestedTab}`;
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        });
      }



      // ★ Blog Posts Sub-tab Initialization
      function setupBlogPostsSubTabs() {
        const subTabs = document.querySelectorAll('#sub-tabs-container-blog-posts .sub-tab-btn');
        const subContents = document.querySelectorAll('.sub-tab-content-blog-posts');

        if (subTabs.length > 0) {
          subTabs.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
          });

          const refreshedTabs = document.querySelectorAll('#sub-tabs-container-blog-posts .sub-tab-btn');
          refreshedTabs.forEach(btn => {
            btn.addEventListener('click', () => {
              refreshedTabs.forEach(b => {
                b.classList.remove('active', 'border-b-2', 'border-primary', 'text-primary');
                b.classList.add('text-slate-500', 'dark:text-slate-400');
              });
              btn.classList.add('active', 'border-b-2', 'border-primary', 'text-primary');
              btn.classList.remove('text-slate-500', 'dark:text-slate-400');

              subContents.forEach(c => c.classList.add('hidden'));
              const targetId = `sub-tab-content-${btn.dataset.subtab}`;
              const targetContent = document.getElementById(targetId);
              if (targetContent) targetContent.classList.remove('hidden');

              if (btn.dataset.subtab === 'blog-categories') {
                loadBlogCategories();
              }
            });
          });
        }
      }

    // --- サブタブ切り替えロジック ---
    function setupSubTabs(containerId, contentClass) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const tabs = container.querySelectorAll(".sub-tab-btn");
        const contents = document.querySelectorAll("." + contentClass);

        // クローンでイベント重複防止
        const newContainer = container.cloneNode(true);
        container.parentNode.replaceChild(newContainer, container);
        const newTabs = newContainer.querySelectorAll(".sub-tab-btn");

        newTabs.forEach(btn => {
            btn.addEventListener("click", () => {
                newTabs.forEach(t => {
                    t.classList.remove("active", "border-b-2", "border-primary", "text-primary");
                    t.classList.add("text-slate-500", "dark:text-slate-400");
                });
                btn.classList.add("active", "border-b-2", "border-primary", "text-primary");
                btn.classList.remove("text-slate-500", "dark:text-slate-400");

                const targetId = `sub-tab-content-${btn.dataset.subtab}`;
                contents.forEach(c => {
                    if (c.id === targetId) c.classList.remove("hidden");
                    else c.classList.add("hidden");
                });
            });
        });
    }

    function setupArticleSubTabs() { setupSubTabs("sub-tabs-container-articles", "sub-tab-content-articles"); }
    function setupBlogPostSubTabs() { setupSubTabs("sub-tabs-container-blog-posts", "sub-tab-content-blog-posts"); }

    // --- お知らせカテゴリー管理ロジック ---
    async function loadArticleCategories() {
        const listContainer = document.getElementById("article-categories-list-container");
        if (!listContainer) return;
        listContainer.innerHTML = '<div class="loader"></div>';
        
        try {
            const q = query(collection(db, "articleCategories"), orderBy("name", "asc"));
            const snapshot = await getDocs(q);
            listContainer.innerHTML = "";
            
            // セレクトボックス更新用
            const selects = [document.getElementById("article-category"), document.getElementById("edit-article-category")];
            
            selects.forEach(sel => {
                if(sel) {
                    const current = sel.value;
                    sel.innerHTML = '<option value="" disabled selected>カテゴリーを選択</option>';
                    snapshot.forEach(doc => {
                        const opt = document.createElement("option");
                        opt.value = doc.data().name;
                        opt.textContent = doc.data().name;
                        sel.appendChild(opt);
                    });
                    if(current) sel.value = current;
                }
            });

            if (snapshot.empty) {
                listContainer.innerHTML = "<p class='text-center text-sm text-slate-500'>カテゴリーなし</p>";
                return;
            }

            snapshot.forEach(docSnap => {
                const div = document.createElement("div");
                div.className = "flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700";
                div.innerHTML = `<span>${docSnap.data().name}</span>`;
                
                const delBtn = document.createElement("button");
                delBtn.className = "text-red-600 text-sm font-bold";
                delBtn.textContent = "削除";
                delBtn.onclick = async () => {
                    if(confirm("削除しますか？")) {
                        await deleteDoc(doc(db, "articleCategories", docSnap.id));
                        loadArticleCategories();
                    }
                };
                div.appendChild(delBtn);
                listContainer.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            listContainer.innerHTML = "<p class='text-red-500'>読み込みエラー</p>";
        }
    }

      // --- ★ ブログカテゴリー管理ロジック (復旧・追加) ★ ---
      async function loadBlogCategories() {
        const listContainer = document.getElementById("blog-categories-list-container");
        // ローダーがあれば表示
        const loader = document.getElementById("blog-categories-loader");
        if (loader && listContainer) loader.classList.remove("hidden");

        try {
            const q = query(collection(db, "blogCategories"), orderBy("name", "asc"));
            const snapshot = await getDocs(q);

            // 1. カテゴリー管理タブのリスト更新
            if (listContainer) {
                listContainer.innerHTML = "";
                if (loader) loader.classList.add("hidden");

                if (snapshot.empty) {
                    listContainer.innerHTML = "<p class='text-center text-sm text-slate-500'>カテゴリーなし</p>";
                } else {
                    snapshot.forEach(docSnap => {
                        const div = document.createElement("div");
                        div.className = "flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700";
                        div.innerHTML = `<span>${docSnap.data().name}</span>`;
                        
                        const delBtn = document.createElement("button");
                        delBtn.className = "text-red-600 text-sm font-bold";
                        delBtn.textContent = "削除";
                        delBtn.onclick = async () => {
                            if(confirm("削除しますか？")) {
                                await deleteDoc(doc(db, "blogCategories", docSnap.id));
                                loadBlogCategories();
                            }
                        };
                        div.appendChild(delBtn);
                        listContainer.appendChild(div);
                    });
                }
            }
            
            // 2. セレクトボックス更新 (追加フォーム & 編集フォーム)
            const selects = [
                document.getElementById("blog-post-category-select"), 
                document.getElementById("edit-blog-post-category-select")
            ];
            
            selects.forEach(sel => {
                if(sel) {
                    const current = sel.value;
                    sel.innerHTML = '<option value="" disabled selected>カテゴリーを選択</option>';
                    if (snapshot.empty) {
                         sel.innerHTML = '<option value="" disabled>カテゴリーが登録されていません</option>';
                    } else {
                        snapshot.forEach(doc => {
                            const opt = document.createElement("option");
                            opt.value = doc.data().name;
                            opt.textContent = doc.data().name;
                            sel.appendChild(opt);
                        });
                    }
                    // 編集時などで値があれば再選択
                    if(current) sel.value = current;
                }
            });

        } catch (e) {
            console.error("ブログカテゴリー読み込みエラー:", e);
            if (listContainer) listContainer.innerHTML = "<p class='text-red-500'>読み込みエラー</p>";
        }
      }

      // ブログカテゴリー追加フォームのイベント
      const addBlogCatForm = document.getElementById("add-blog-category-form");
      if(addBlogCatForm) {
        addBlogCatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("blog-category-name");
            if(!input.value.trim()) return;
            
            const submitBtn = document.getElementById("submit-blog-category-btn");
            if(submitBtn) submitBtn.disabled = true;

            try {
                await addDoc(collection(db, "blogCategories"), { name: input.value.trim(), createdAt: serverTimestamp() });
                input.value = "";
                showMessage("ブログカテゴリーを追加しました");
                loadBlogCategories();
            } catch(err) {
                console.error(err);
                showMessage("追加エラー", "error");
            } finally {
                if(submitBtn) submitBtn.disabled = false;
            }
        });
      }

    const addArtCatForm = document.getElementById("add-article-category-form");
    if(addArtCatForm) {
        addArtCatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("article-category-name");
            if(!input.value.trim()) return;
            await addDoc(collection(db, "articleCategories"), { name: input.value.trim(), createdAt: serverTimestamp() });
            input.value = "";
            loadArticleCategories();
            showMessage("カテゴリーを追加しました");
        });
    }

      // ★ Page Common Management Sub-tab Initialization
      function setupCommonManagementSubTabs() {
        const commonSubTabs = document.querySelectorAll('#sub-tabs-container-common-management .sub-tab-btn');
        const commonSubContents = document.querySelectorAll('.sub-tab-content-common');

        if (commonSubTabs.length > 0) {
          commonSubTabs.forEach(btn => {
            // Remove existing listeners to prevent duplication (simple approach)
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
          });
          
          // Re-select buttons after replacement
          const refreshedTabs = document.querySelectorAll('#sub-tabs-container-common-management .sub-tab-btn');
          
          refreshedTabs.forEach(btn => {
            btn.addEventListener('click', () => {
              // Remove active class from all buttons
              refreshedTabs.forEach(b => {
                b.classList.remove('active', 'border-b-2', 'border-primary', 'text-primary');
                b.classList.add('text-slate-500', 'dark:text-slate-400');
              });
              // Add active class to clicked button
              btn.classList.add('active', 'border-b-2', 'border-primary', 'text-primary');
              btn.classList.remove('text-slate-500', 'dark:text-slate-400');

              // Hide all contents
              commonSubContents.forEach(c => c.classList.add('hidden'));
              // Show target content
              const targetId = `sub-tab-content-${btn.dataset.subtab}`;
              const targetContent = document.getElementById(targetId);
              if (targetContent) {
                  targetContent.classList.remove('hidden');
              }

              // ★ Load data based on sub-tab
              const subtab = btn.dataset.subtab;
              if (subtab === 'basic-settings') {
                  if (typeof loadSiteBranding === 'function') loadSiteBranding();
              } else if (subtab === 'nav-settings') {
                  if (typeof loadNavigation === 'function') loadNavigation();
                  if (typeof loadNavigation === 'function') loadNavigation();
                  if (typeof loadBottomNavigation === 'function') {
                      loadBottomNavigation();
                      // ボトムナビ配置設定の読み込みとイベントリスナー設定
                      if (typeof loadBottomNavAlignSettings === 'function') {
                          loadBottomNavAlignSettings();
                      }
                  }
              } else if (subtab === 'site-common') {
                  if (typeof loadHeaderCtaData === 'function') loadHeaderCtaData();
              } else if (subtab === 'system-settings') {
                  if (typeof loadBlogCategories === 'function') loadBlogCategories();
              }
            });
          });
          
          // Initialize Nested Tabs
          setupNestedTabs();
        }
      }

      /**
 * 汎用的なコンテンツブロックを追加する関数
 * @param {Object} data - ブロック情報 (type, width, heightなど)
 */
function addContentBlock(data) {
  const blocksContainer = document.getElementById('html-blocks-container');
  if (!blocksContainer) return;

  const blockDiv = document.createElement('div');
  blockDiv.className = 'content-block-wrapper border border-slate-300 dark:border-slate-600 p-4 rounded-lg space-y-2 relative';
  blockDiv.dataset.type = data.type; // 'html' または 'spacer'

  let contentHtml = '';
  
  if (data.type === 'html') {
    contentHtml = `
      <span class="absolute top-2 right-2 text-xs font-bold text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">HTML</span>
      <textarea class="dynamic-html-block content-data mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-800 shadow-sm focus:border-primary focus:ring-primary font-mono text-sm" rows="10" placeholder="ここにカスタムHTMLコードを貼り付け..."></textarea>
    `;
  } else if (data.type === 'spacer') {
    // Spacer logic (Layout Control)
    contentHtml = `
      <div class="flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-md p-4 text-center text-slate-500">
        <span class="material-symbols-outlined mr-2">space_bar</span>
        <span>スペーサー (${data.width || 'w-full'}, ${data.height || 'h-8'})</span>
      </div>
    `;
  }

  // 削除ボタンを追加
  contentHtml += `<button type="button" class="delete-block-btn py-1 px-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-xs flex items-center gap-1"><span class="material-symbols-outlined !text-sm">delete</span><span>このブロックを削除</span></button>`;
  
  blockDiv.innerHTML = contentHtml;
  blocksContainer.appendChild(blockDiv);
}
      });
    </script>
  </body>
</html>